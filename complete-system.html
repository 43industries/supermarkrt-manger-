<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>43 INDUSTRIES SUPERMARKET MANAGER</title>
    <!-- Prevent caching - forces browser to reload latest version -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Load scripts: Use standard script tags - browser will handle loading -->
    <script src="./libs/react.min.js" onerror="console.error('Failed to load React from local file')"></script>
    <script src="./libs/react-dom.min.js" onerror="console.error('Failed to load ReactDOM from local file')"></script>
    <script src="./libs/babel.min.js" onerror="console.error('Failed to load Babel from local file')"></script>
    <script src="./libs/tailwind.js" onerror="console.error('Failed to load Tailwind from local file')"></script>
    <script src="./libs/qrcode.min.js" onerror="console.error('Failed to load QRCode from local file')"></script>
    <!-- Fallback to CDN if local files fail (only works online) -->
    <script>
        // Wait a bit then check if libraries loaded
        setTimeout(function() {
            // Check if React loaded, if not try CDN
            if (typeof React === 'undefined') {
                console.log('Local React failed, trying CDN...');
                const r = document.createElement('script');
                r.src = 'https://unpkg.com/react@18/umd/react.production.min.js';
                r.crossOrigin = 'anonymous';
                r.onload = function() { console.log('React loaded from CDN'); };
                r.onerror = function() { console.error('Failed to load React from CDN'); };
                document.head.appendChild(r);
            }
            if (typeof ReactDOM === 'undefined') {
                console.log('Local ReactDOM failed, trying CDN...');
                const rd = document.createElement('script');
                rd.src = 'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js';
                rd.crossOrigin = 'anonymous';
                rd.onload = function() { console.log('ReactDOM loaded from CDN'); };
                rd.onerror = function() { console.error('Failed to load ReactDOM from CDN'); };
                document.head.appendChild(rd);
            }
            if (typeof Babel === 'undefined') {
                console.log('Local Babel failed, trying CDN...');
                const b = document.createElement('script');
                b.src = 'https://unpkg.com/@babel/standalone/babel.min.js';
                b.onload = function() { console.log('Babel loaded from CDN'); };
                b.onerror = function() { console.error('Failed to load Babel from CDN'); };
                document.head.appendChild(b);
            }
        }, 500);
    </script>
    
    <style>
        /* ============= ULTIMATE POS ANIMATIONS ============= */
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.4), 0 0 40px rgba(34, 197, 94, 0.2); }
            50% { box-shadow: 0 0 40px rgba(34, 197, 94, 0.6), 0 0 80px rgba(34, 197, 94, 0.4); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes scan-line {
            0% { top: 0; opacity: 1; }
            50% { opacity: 0.5; }
            100% { top: 100%; opacity: 1; }
        }
        
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes number-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes slide-in {
            0% { transform: translateX(100px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes success-flash {
            0% { background-color: transparent; }
            50% { background-color: rgba(34, 197, 94, 0.3); }
            100% { background-color: transparent; }
        }
        
        .animate-shimmer { animation: shimmer 2s infinite; }
        .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-gradient { 
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite; 
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out; }
        .animate-pop { animation: number-pop 0.3s ease-out; }
        
        /* Glass effect */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Scrollbar styling */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Thermal Receipt Print Styles - 80mm (302px) paper */
        @media print {
            @page {
                size: 80mm auto;
                margin: 0;
            }
            
            /* Hide everything by default */
            body * {
                visibility: hidden;
            }
            
            /* Show only receipt print area */
            .receipt-print-area,
            .receipt-print-area *,
            .receipt-print-area *::before,
            .receipt-print-area *::after {
                visibility: visible !important;
            }
            
            /* Hide modal overlay and container */
            .no-print-parent,
            .no-print-parent * {
                visibility: hidden !important;
            }
            
            /* But keep receipt visible */
            .no-print-parent .receipt-print-area,
            .no-print-parent .receipt-print-area * {
                visibility: visible !important;
            }
            
            /* Show receipt container */
            .receipt-print-area {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 80mm !important;
                max-width: 80mm !important;
                padding: 2mm !important;
                margin: 0 !important;
                font-family: 'Courier New', Courier, monospace !important;
                font-size: 10px !important;
                line-height: 1.2 !important;
                background: white !important;
                color: black !important;
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
            }
            
            body {
                margin: 0 !important;
                padding: 0 !important;
                width: 80mm !important;
                background: white !important;
            }
            
            .receipt-print-area h2 {
                font-size: 14px !important;
                margin: 0 !important;
                padding: 0 !important;
                line-height: 1.2 !important;
            }
            
            .receipt-print-area p {
                font-size: 9px !important;
                margin: 1px 0 !important;
            }
            
            .receipt-print-area div {
                font-size: 10px !important;
            }
            
            .receipt-print-area span {
                font-size: 10px !important;
            }
            
            .receipt-print-area table {
                width: 100% !important;
                font-size: 10px !important;
                border-collapse: collapse !important;
            }
            
            .receipt-print-area th,
            .receipt-print-area td {
                padding: 1px 2px !important;
                border: none !important;
                font-size: 10px !important;
            }
            
            /* Override all inline font-size styles */
            .receipt-print-area [style*="fontSize"],
            .receipt-print-area [style*="font-size"] {
                font-size: 10px !important;
            }
            
            /* Override large font sizes specifically */
            .receipt-print-area [style*="28px"],
            .receipt-print-area [style*="24px"],
            .receipt-print-area [style*="20px"],
            .receipt-print-area [style*="16px"],
            .receipt-print-area [style*="15px"],
            .receipt-print-area [style*="14px"] {
                font-size: 10px !important;
            }
            
            /* Header can be slightly larger */
            .receipt-print-area h2[style*="fontSize"],
            .receipt-print-area h2[style*="font-size"] {
                font-size: 14px !important;
            }
            
            /* Total section can be slightly larger - target by fontSize: '12px' */
            .receipt-print-area [style*="fontSize: '12px'"],
            .receipt-print-area [style*="font-size: 12px"] {
                font-size: 12px !important;
            }
            
            /* Reduce padding and margins */
            .receipt-print-area [style*="padding"] {
                padding: 4px !important;
            }
            
            .receipt-print-area [style*="margin"] {
                margin: 2px 0 !important;
            }
            
            /* Hide all no-print elements */
            .no-print,
            .no-print * {
                display: none !important;
                visibility: hidden !important;
            }
            
            .qr-code-container {
                text-align: center !important;
                margin: 8px 0 !important;
            }
            
            .qr-code-container canvas,
            .qr-code-container img {
                max-width: 60px !important;
                max-height: 60px !important;
                width: 60px !important;
                height: 60px !important;
                display: inline-block !important;
            }
            
            .receipt-print-area img {
                max-width: 60px !important;
                max-height: 60px !important;
                width: 60px !important;
                height: 60px !important;
            }
            
            /* Ensure all text is black */
            .receipt-print-area,
            .receipt-print-area * {
                color: #000000 !important;
                background: transparent !important;
            }
            
            .receipt-print-area {
                background: white !important;
            }
        }
        
        /* Screen preview styles for thermal receipt */
        .thermal-receipt {
            font-family: 'Courier New', Courier, monospace;
            max-width: 302px;
            margin: 0 auto;
            background: white;
            padding: 8px;
        }
        
        .thermal-receipt h2 {
            font-size: 14px;
            font-weight: bold;
        }
        
        .thermal-receipt .item-row {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            border-bottom: 1px dotted #ccc;
            padding: 2px 0;
        }
        
        .dashed-line {
            border-top: 1px dashed #000;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;
        
        // All Icons
        const ShoppingCart = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/>
                <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
            </svg>
        );
        
        const Package = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/>
                <path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/>
            </svg>
        );
        
        const Users = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
        );
        
        const TrendingUp = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/>
            </svg>
        );
        
        const Zap = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </svg>
        );
        
        const DollarSign = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
        );
        
        const AlertCircle = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/>
            </svg>
        );
        
        const LogOut = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>
            </svg>
        );

        const Search = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
            </svg>
        );

        const Barcode = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/>
            </svg>
        );

        const FileText = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                <polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/>
                <line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/>
            </svg>
        );

        const Plus = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M5 12h14"/><path d="M12 5v14"/>
            </svg>
        );

        const Download = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>
            </svg>
        );

        const Printer = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                <rect width="12" height="8" x="6" y="14"/>
            </svg>
        );

        const CreditCard = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/>
            </svg>
        );

        const Smartphone = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/>
            </svg>
        );

        const Banknote = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/>
            </svg>
        );

        const Edit = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
        );

        const Trash = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            </svg>
        );

        const Truck = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/>
                <path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/>
                <circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/>
            </svg>
        );

        const ClipboardList = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                <path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/>
            </svg>
        );

        const BarChart = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/>
                <line x1="6" x2="6" y1="20" y2="14"/>
            </svg>
        );

        const Settings = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
        );

        const Calendar = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                <line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/>
                <line x1="3" x2="21" y1="10" y2="10"/>
            </svg>
        );

        const Save = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
            </svg>
        );

        const X = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
            </svg>
        );
        
        // Main Complete App
        const CompleteSystem = () => {
          const [isLoggedIn, setIsLoggedIn] = useState(() => {
            const savedUser = localStorage.getItem('logged_in_user');
            return savedUser !== null;
          });
          const [currentUser, setCurrentUser] = useState(() => {
            const savedUser = localStorage.getItem('logged_in_user');
            return savedUser ? JSON.parse(savedUser) : null;
          });
          const [loginForm, setLoginForm] = useState({ username: '', password: '', rememberMe: true });
          const [currentView, setCurrentView] = useState('dashboard');
          
          const defaultProducts = [
            { id: 1, name: 'Rice 5kg', barcode: '8901234567890', category: 'Grains', costPrice: 450, sellingPrice: 650, stock: 45, unit: 'kg', reorderLevel: 10 },
            { id: 2, name: 'Cooking Oil 2L', barcode: '8901234567891', category: 'Oils', costPrice: 280, sellingPrice: 380, stock: 8, unit: 'litres', reorderLevel: 15 },
            { id: 3, name: 'Sugar 1kg', barcode: '8901234567892', category: 'Sweeteners', costPrice: 95, sellingPrice: 135, stock: 120, unit: 'kg', reorderLevel: 20 },
            { id: 4, name: 'Milk 1L', barcode: '8901234567893', category: 'Dairy', costPrice: 55, sellingPrice: 80, stock: 5, unit: 'litres', reorderLevel: 25 },
            { id: 5, name: 'Bread Loaf', barcode: '8901234567894', category: 'Bakery', costPrice: 35, sellingPrice: 55, stock: 30, unit: 'pieces', reorderLevel: 10 },
            { id: 6, name: 'Tea 250g', barcode: '8901234567895', category: 'Beverages', costPrice: 180, sellingPrice: 250, stock: 60, unit: 'grams', reorderLevel: 15 },
          ];

          const defaultSales = [
            { id: 1, date: '2025-11-10', time: '10:30', items: 3, total: 265, profit: 85, paymentMethod: 'Cash' },
            { id: 2, date: '2025-11-10', time: '11:15', items: 5, total: 580, profit: 180, paymentMethod: 'M-Pesa' },
          ];

          const defaultCustomers = [
            { id: 1, name: 'John Doe', phone: '+254700111222', email: 'john@email.com', points: 450 },
            { id: 2, name: 'Jane Smith', phone: '+254700333444', email: 'jane@email.com', points: 780 },
          ];

          const defaultSuppliers = [
            { id: 1, name: 'ABC Distributors', phone: '0722111222', email: 'abc@supplier.com', address: 'Nairobi CBD', products: ['Rice', 'Sugar', 'Flour'], totalPurchases: 125000 },
            { id: 2, name: 'Fresh Foods Ltd', phone: '0733222333', email: 'fresh@foods.co.ke', address: 'Industrial Area', products: ['Milk', 'Bread', 'Eggs'], totalPurchases: 85000 },
          ];

          const defaultExpenses = [
            { id: 1, date: '2025-12-01', category: 'Rent', description: 'Monthly rent', amount: 25000 },
            { id: 2, date: '2025-12-05', category: 'Utilities', description: 'Electricity bill', amount: 3500 },
          ];

          const [products, setProducts] = useState(() => {
            const saved = localStorage.getItem('products');
            return saved ? JSON.parse(saved) : defaultProducts;
          });

          const [sales, setSales] = useState(() => {
            const saved = localStorage.getItem('sales');
            return saved ? JSON.parse(saved) : defaultSales;
          });

          const [customers, setCustomers] = useState(() => {
            const saved = localStorage.getItem('customers');
            return saved ? JSON.parse(saved) : defaultCustomers;
          });

          const [suppliers, setSuppliers] = useState(() => {
            const saved = localStorage.getItem('suppliers');
            return saved ? JSON.parse(saved) : defaultSuppliers;
          });

          const [expenses, setExpenses] = useState(() => {
            const saved = localStorage.getItem('expenses');
            return saved ? JSON.parse(saved) : defaultExpenses;
          });

          const [cashRegister, setCashRegister] = useState(() => {
            const saved = localStorage.getItem('cashRegister');
            return saved ? JSON.parse(saved) : { isOpen: false, openingFloat: 0, openingTime: null, cashierName: '' };
          });

          const [quickButtons, setQuickButtons] = useState(() => {
            const saved = localStorage.getItem('quickButtons');
            return saved ? JSON.parse(saved) : [];
          });

          const [cart, setCart] = useState([]);
          const [searchTerm, setSearchTerm] = useState('');
          const [barcodeInput, setBarcodeInput] = useState('');
          const [selectedCategory, setSelectedCategory] = useState('');
          const [showBuyByAmountModal, setShowBuyByAmountModal] = useState(false);
          const [buyByAmountProduct, setBuyByAmountProduct] = useState(null);
          const [buyByAmountValue, setBuyByAmountValue] = useState('');
          const [editingCartItemAmount, setEditingCartItemAmount] = useState(null);
          const [cartItemAmountValue, setCartItemAmountValue] = useState('');
          const [purchaseSearchTerm, setPurchaseSearchTerm] = useState('');
          
          // Product search filters for Products & Prices table
          const [productFilters, setProductFilters] = useState({
            name: '',
            barcode: '',
            category: '',
            costPrice: '',
            sellingPrice: '',
            stock: ''
          });
          const [showReceipt, setShowReceipt] = useState(false);
          const [lastSale, setLastSale] = useState(null);
          const [paymentMethod, setPaymentMethod] = useState('Cash');
          const [amountReceived, setAmountReceived] = useState(0);
          const [showDetailModal, setShowDetailModal] = useState(false);
          const [detailModalData, setDetailModalData] = useState(null);
          const [stockBarcode, setStockBarcode] = useState('');
          const [stockQuantity, setStockQuantity] = useState('');
          const [scannedProduct, setScannedProduct] = useState(null);
          const [stockHistory, setStockHistory] = useState(() => {
            const saved = localStorage.getItem('stock_history');
            return saved ? JSON.parse(saved) : [];
          });
          const [mpesaPhone, setMpesaPhone] = useState('');
          const [showMpesaPrompt, setShowMpesaPrompt] = useState(false);
          const [mpesaProcessing, setMpesaProcessing] = useState(false);
          
          // New state for additional features
          const [editingProduct, setEditingProduct] = useState(null);
          const [showAddProduct, setShowAddProduct] = useState(false);
          const [newProduct, setNewProduct] = useState({ name: '', barcode: '', category: '', costPrice: '', sellingPrice: '', marketPrice: '', stock: '', unit: 'pieces', reorderLevel: 10, expiryDate: '', supplierId: '' });
          
          const [purchases, setPurchases] = useState(() => {
            const saved = localStorage.getItem('purchases');
            return saved ? JSON.parse(saved) : [
              { id: 1, date: '2025-12-01', supplier: 'ABC Distributors', items: [{ name: 'Rice 5kg', qty: 50, unitCost: 450 }], total: 22500, status: 'Received', invoiceNo: 'PO-001' },
              { id: 2, date: '2025-12-05', supplier: 'XYZ Supplies', items: [{ name: 'Cooking Oil 2L', qty: 30, unitCost: 280 }], total: 8400, status: 'Pending', invoiceNo: 'PO-002' },
            ];
          });
          const [showPurchaseForm, setShowPurchaseForm] = useState(false);
          const [newPurchase, setNewPurchase] = useState({ supplier: '', items: [], total: 0 });
          const [purchaseItem, setPurchaseItem] = useState({ productId: '', qty: '', unitCost: '' });
          
          const [invoices, setInvoices] = useState(() => {
            const saved = localStorage.getItem('invoices');
            return saved ? JSON.parse(saved) : [];
          });
          const [showInvoiceForm, setShowInvoiceForm] = useState(false);
          const [selectedSaleForInvoice, setSelectedSaleForInvoice] = useState(null);
          const [invoiceCustomer, setInvoiceCustomer] = useState({ name: '', address: '', phone: '', email: '', taxId: '' });
          const [showInvoicePreview, setShowInvoicePreview] = useState(false);
          const [currentInvoice, setCurrentInvoice] = useState(null);
          
          const [reportDateRange, setReportDateRange] = useState({ start: '', end: '' });
          const [reportType, setReportType] = useState('sales');
          
          // Quick Add Product state
          const [showQuickAdd, setShowQuickAdd] = useState(false);
          const [quickAddBarcode, setQuickAddBarcode] = useState('');
          
          // Hold/Park Orders state
          const [heldOrders, setHeldOrders] = useState(() => {
            const saved = localStorage.getItem('held_orders');
            return saved ? JSON.parse(saved) : [];
          });
          const [showHeldOrders, setShowHeldOrders] = useState(false);
          
          // Void Sales state
          const [showVoidSale, setShowVoidSale] = useState(false);
          
          // Customer Loyalty state
          const [selectedCustomer, setSelectedCustomer] = useState(null);
          const [showCustomerSelect, setShowCustomerSelect] = useState(false);
          const [showAddCustomer, setShowAddCustomer] = useState(false);
          const [newCustomer, setNewCustomer] = useState({ name: '', phone: '', email: '' });
          const [customerSearchTerm, setCustomerSearchTerm] = useState('');
          const [customerSearch, setCustomerSearch] = useState('');
          const [redeemPoints, setRedeemPoints] = useState(0);
          const [pointsDiscount, setPointsDiscount] = useState(0);

          // Supplier states
          const [showAddSupplier, setShowAddSupplier] = useState(false);
          const [newSupplier, setNewSupplier] = useState({ name: '', phone: '', email: '', address: '', products: '' });
          const [editingSupplier, setEditingSupplier] = useState(null);

          // Expense states
          const [showAddExpense, setShowAddExpense] = useState(false);
          const [newExpense, setNewExpense] = useState({ date: new Date().toISOString().split('T')[0], category: 'Rent', description: '', amount: '' });

          // Cash Register states
          const [showOpenRegister, setShowOpenRegister] = useState(false);
          const [showCloseRegister, setShowCloseRegister] = useState(false);
          const [closingCash, setClosingCash] = useState('');

          // Split payment state
          const [splitPayment, setSplitPayment] = useState({ enabled: false, cashAmount: 0, mpesaAmount: 0 });

          // Quick buttons edit mode
          const [editingQuickButtons, setEditingQuickButtons] = useState(false);
          
          // Store Configuration System - For selling to different mini marts
          const defaultStoreConfig = {
            storeName: '43 INDUSTRIES SUPERMARKET MANAGER',
            phone: '+254 XXX XXX XXX',
            email: 'info@43industries.com',
            address: 'Nairobi, Kenya',
            taxPin: 'P051234567X',
            currency: 'KES',
            currencySymbol: 'KES',
            footerText: 'Thank you for shopping at 43 INDUSTRIES',
            showFooter: true
          };

          const [storeConfig, setStoreConfig] = useState(() => {
            const saved = localStorage.getItem('storeConfig');
            return saved ? JSON.parse(saved) : defaultStoreConfig;
          });

          // Save store config whenever it changes
          useEffect(() => {
            localStorage.setItem('storeConfig', JSON.stringify(storeConfig));
          }, [storeConfig]);

          // Loyalty settings: 1 point per 100 KES spent
          const POINTS_PER_CURRENCY = 100; // Earn 1 point per 100 KES

          // Export functions
          const exportToCSV = (data, filename) => {
            if (!data || data.length === 0) {
              alert('No data to export');
              return;
            }
            const headers = Object.keys(data[0]);
            const csv = [
              headers.join(','),
              ...data.map(row => headers.map(h => {
                let val = row[h];
                if (typeof val === 'object') val = JSON.stringify(val);
                if (typeof val === 'string' && val.includes(',')) val = '"' + val + '"';
                return val;
              }).join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename + '_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
          };

          const backupAllData = () => {
            const backup = {
              products,
              sales,
              customers,
              suppliers,
              expenses,
              purchases,
              invoices,
              stockHistory,
              quickButtons,
              exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '43_industries_backup_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            alert('âœ… Backup downloaded!\n\nSave this file safely to restore your data later.');
          };

          const restoreFromBackup = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const backup = JSON.parse(e.target.result);
                if (confirm('âš ï¸ This will replace ALL current data with the backup.\n\nBackup date: ' + backup.exportDate + '\n\nContinue?')) {
                  if (backup.products) setProducts(backup.products);
                  if (backup.sales) setSales(backup.sales);
                  if (backup.customers) setCustomers(backup.customers);
                  if (backup.suppliers) setSuppliers(backup.suppliers);
                  if (backup.expenses) setExpenses(backup.expenses);
                  if (backup.purchases) setPurchases(backup.purchases);
                  if (backup.invoices) setInvoices(backup.invoices);
                  if (backup.stockHistory) setStockHistory(backup.stockHistory);
                  if (backup.quickButtons) setQuickButtons(backup.quickButtons);
                  alert('âœ… Data restored successfully!');
                }
              } catch (err) {
                alert('âŒ Invalid backup file');
              }
            };
            reader.readAsText(file);
          };
          
          // Debounced localStorage saves for better performance
          const saveTimeoutRef = useRef({});
          const debouncedSave = useCallback((key, data) => {
            if (saveTimeoutRef.current[key]) clearTimeout(saveTimeoutRef.current[key]);
            saveTimeoutRef.current[key] = setTimeout(() => {
              localStorage.setItem(key, JSON.stringify(data));
            }, 500);
          }, []);

          // Debounced search term for better performance
          const [debouncedSearchTerm, setDebouncedSearchTerm] = useState('');
          useEffect(() => {
            const timer = setTimeout(() => {
              setDebouncedSearchTerm(searchTerm);
            }, 300);
            return () => clearTimeout(timer);
          }, [searchTerm]);

          // Memoized filtered products - only recalculates when products, search term, or category changes
          const filteredProducts = useMemo(() => {
            let filtered = products;
            
            // Filter by category if selected
            if (selectedCategory) {
              filtered = filtered.filter(p => p.category === selectedCategory);
            }
            
            // Filter by search term
            if (debouncedSearchTerm) {
              const search = debouncedSearchTerm.toLowerCase();
              filtered = filtered.filter(p => 
                p.name.toLowerCase().includes(search) ||
                p.barcode.includes(debouncedSearchTerm) ||
                (p.category && p.category.toLowerCase().includes(search))
              );
            }
            
            return filtered;
          }, [products, debouncedSearchTerm, selectedCategory]);
          
          // Get unique categories for filter buttons
          const categories = useMemo(() => {
            return [...new Set(products.map(p => p.category).filter(Boolean))].sort();
          }, [products]);
          
          // Handle Buy by Amount
          const handleBuyByAmount = () => {
            if (!buyByAmountProduct || !buyByAmountValue) {
              alert('Please enter an amount!');
              return;
            }
            
            const amount = parseFloat(buyByAmountValue);
            if (isNaN(amount) || amount <= 0) {
              alert('Please enter a valid amount!');
              return;
            }
            
            const sellingPrice = buyByAmountProduct.sellingPrice || buyByAmountProduct.price || 0;
            if (sellingPrice <= 0) {
              alert('Product price is invalid!');
              return;
            }
            
            // Calculate quantity
            const calculatedQuantity = amount / sellingPrice;
            const maxQuantity = buyByAmountProduct.stock || 0;
            
            if (calculatedQuantity > maxQuantity) {
              const unit = buyByAmountProduct.unit || 'pieces';
              const requestedDisplay = (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams')
                ? calculatedQuantity.toFixed(2)
                : Math.floor(calculatedQuantity);
              const availableDisplay = (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams')
                ? parseFloat(maxQuantity).toFixed(2)
                : maxQuantity;
              alert(`âš ï¸ Not enough stock!\n\nYou requested: ${requestedDisplay} ${unit}\nAvailable: ${availableDisplay} ${unit}\n\nMaximum amount you can buy: KES ${(maxQuantity * sellingPrice).toFixed(2)}`);
              return;
            }
            
            // Add to cart with calculated quantity
            const unit = buyByAmountProduct.unit || 'pieces';
            const finalQuantity = (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams') 
              ? parseFloat(calculatedQuantity.toFixed(2)) 
              : Math.floor(calculatedQuantity);
            
            const existing = cart.find(item => item.id === buyByAmountProduct.id);
            if (existing) {
              const newQty = parseFloat(existing.quantity) + finalQuantity;
              if (newQty > maxQuantity) {
                alert(`âš ï¸ Cannot add more! Total would exceed available stock of ${maxQuantity} ${unit}`);
                return;
              }
              setCart(cart.map(item => 
                item.id === buyByAmountProduct.id 
                  ? { ...item, quantity: (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams') ? parseFloat(newQty.toFixed(2)) : newQty } 
                  : item
              ));
            } else {
              setCart([...cart, { ...buyByAmountProduct, quantity: finalQuantity, unit: unit }]);
            }
            
            // Reset modal
            setShowBuyByAmountModal(false);
            setBuyByAmountProduct(null);
            setBuyByAmountValue('');
            setBarcodeInput('');
          };

          // Memoized low stock items
          const lowStockItems = useMemo(() => {
            return products.filter(p => p.stock <= p.reorderLevel);
          }, [products]);

          // Memoized cart totals
          const cartTotal = useMemo(() => {
            return cart.reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0);
          }, [cart]);

          const cartItemCount = useMemo(() => {
            return cart.reduce((sum, item) => sum + item.quantity, 0);
          }, [cart]);

          useEffect(() => { debouncedSave('held_orders', heldOrders); }, [heldOrders, debouncedSave]);
          
          // Calculate points to earn - using memoized cartTotal
          const pointsToEarn = useMemo(() => Math.floor(cartTotal / POINTS_PER_CURRENCY), [cartTotal, POINTS_PER_CURRENCY]);
          
          // Apply points discount - using memoized cartTotal
          const applyPointsDiscount = useCallback((points) => {
            if (!selectedCustomer) return;
            const maxPoints = Math.min(points, selectedCustomer.points);
            const maxDiscount = Math.floor(cartTotal * 0.5); // Max 50% discount
            const discount = Math.min(maxPoints * POINT_VALUE, maxDiscount);
            setRedeemPoints(Math.floor(discount / POINT_VALUE));
            setPointsDiscount(discount);
          }, [selectedCustomer, cartTotal]);
          
          // Add new customer - Name and Mobile only
          const addNewCustomer = () => {
            if (!newCustomer.name || !newCustomer.phone) {
              alert('Please enter customer name and mobile number');
              return;
            }
            // Check if phone already exists
            const existingCustomer = customers.find(c => c.phone === newCustomer.phone);
            if (existingCustomer) {
              alert('âš ï¸ This mobile number is already registered!\n\nCustomer: ' + existingCustomer.name + '\nPoints: ' + existingCustomer.points);
              setSelectedCustomer(existingCustomer);
              setShowAddCustomer(false);
              setShowCustomerSelect(false);
              return;
            }
            
            const customer = {
              id: Math.max(...customers.map(c => c.id), 0) + 1,
              name: newCustomer.name,
              phone: newCustomer.phone,
              email: '',
              points: 0,
              totalSpent: 0,
              visits: 0,
              joinDate: new Date().toISOString().split('T')[0]
            };
            setCustomers([...customers, customer]);
            setSelectedCustomer(customer);
            setShowAddCustomer(false);
            setShowCustomerSelect(false);
            setNewCustomer({ name: '', phone: '', email: '' });
            alert('âœ… Customer Registered!\n\n' + customer.name + '\nMobile: ' + customer.phone + '\n\nThey will earn 1 point per KES 100 spent!');
          };

          useEffect(() => { debouncedSave('products', products); }, [products]);
          useEffect(() => { debouncedSave('purchases', purchases); }, [purchases]);
          useEffect(() => { debouncedSave('invoices', invoices); }, [invoices]);
          useEffect(() => { debouncedSave('sales', sales); }, [sales]);
          useEffect(() => { debouncedSave('customers', customers); }, [customers]);
          useEffect(() => { debouncedSave('stock_history', stockHistory); }, [stockHistory]);
          useEffect(() => { debouncedSave('suppliers', suppliers); }, [suppliers]);
          useEffect(() => { debouncedSave('expenses', expenses); }, [expenses]);
          useEffect(() => { debouncedSave('cashRegister', cashRegister); }, [cashRegister]);
          useEffect(() => { debouncedSave('quickButtons', quickButtons); }, [quickButtons]);

          // Store-specific users - Each store can have their own passwords
          const defaultUsers = [
            { id: 1, username: 'admin', password: 'admin123', role: 'Admin', name: 'Store Manager' },
            { id: 2, username: 'cashier', password: 'cashier123', role: 'Cashier', name: 'Sales Assistant' }
          ];

          const [users, setUsers] = useState(() => {
            const saved = localStorage.getItem('storeUsers');
            if (saved) {
              return JSON.parse(saved);
            }
            // Save default users on first load
            localStorage.setItem('storeUsers', JSON.stringify(defaultUsers));
            return defaultUsers;
          });

          // Save users whenever they change
          useEffect(() => {
            localStorage.setItem('storeUsers', JSON.stringify(users));
          }, [users]);

          const handleLogin = (e) => {
            e.preventDefault();
            console.log('Attempting login with:', loginForm);
            const user = users.find(u => u.username === loginForm.username && u.password === loginForm.password);
            if (user) {
              setCurrentUser(user);
              setIsLoggedIn(true);
              
              // Save to localStorage if Remember Me is checked
              if (loginForm.rememberMe) {
                localStorage.setItem('logged_in_user', JSON.stringify(user));
              }
              
              console.log('Login successful:', user.name);
            } else {
              console.log('Login failed. Available users:', users);
              const userList = users.map(u => `${u.role}: ${u.username} / [password hidden]`).join('\n');
              alert(`Invalid credentials!\n\nYou entered:\nUsername: "${loginForm.username}"\nPassword: "${loginForm.password}"\n\nPlease check your credentials or contact your store administrator.`);
            }
          };

          const handleLogout = () => {
            setIsLoggedIn(false);
            setCurrentUser(null);
            setCart([]);
            localStorage.removeItem('logged_in_user');
          };

          const addToCart = (product) => {
            const existing = cart.find(item => item.id === product.id);
            const unit = product.unit || 'pieces';
            const increment = (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams') ? 0.1 : 1;
            
            if (existing) {
              const newQty = parseFloat(existing.quantity) + increment;
              setCart(cart.map(item => 
                item.id === product.id ? { ...item, quantity: (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams') ? parseFloat(newQty.toFixed(2)) : newQty } : item
              ));
            } else {
              const initialQty = (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams') ? 0.1 : 1;
              setCart([...cart, { ...product, quantity: initialQty, unit: unit }]);
            }
          };

          const initiateMpesaPayment = () => {
            if (!mpesaPhone || mpesaPhone.length < 10) {
              alert('âš ï¸ PHONE NUMBER REQUIRED!\n\nPlease enter customer phone number in the M-Pesa field first.\n\nExample: 0712345678 or 254712345678');
              return;
            }

            setMpesaProcessing(true);

            // DEMO MODE - Simulates M-Pesa STK Push
            alert(`ðŸ“± SENDING M-PESA PROMPT...\n\nTo: ${mpesaPhone}\nAmount: KES ${cartTotal.toFixed(2)}\n\nPlease wait...`);

            setTimeout(() => {
              setMpesaProcessing(false);
              const confirmed = window.confirm(
                `ðŸ“± M-PESA PAYMENT PROMPT SENT!\n\n` +
                `âœ… Customer phone is now showing:\n` +
                `"Enter M-Pesa PIN to pay KES ${cartTotal.toFixed(2)}"\n\n` +
                `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                `DEMO MODE:\n` +
                `Click OK = Customer paid (Success)\n` +
                `Click Cancel = Customer cancelled (Failed)\n` +
                `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
                `Did customer complete payment?`
              );

              if (confirmed) {
                alert(`âœ… M-PESA PAYMENT SUCCESSFUL!\n\n` +
                  `Amount: KES ${cartTotal.toFixed(2)}\n` +
                  `Phone: ${mpesaPhone}\n` +
                  `Transaction ID: MPX${Date.now()}\n\n` +
                  `Generating receipt...`);
                setShowMpesaPrompt(false);
                finalizeMpesaSale();
              } else {
                alert('âŒ Payment Cancelled\n\nCustomer did not complete M-Pesa payment.\nTry again or use different payment method.');
                setMpesaPhone('');
              }
            }, 2000);
          };

          const finalizeMpesaSale = useCallback(() => {
            const total = cartTotal;
            const cost = cart.reduce((sum, item) => sum + (item.costPrice * item.quantity), 0);
            
            const newSale = {
              id: sales.length + 1,
              date: new Date().toISOString().split('T')[0],
              time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
              items: cart.reduce((sum, item) => sum + item.quantity, 0),
              total,
              profit: total - cost,
              paymentMethod: 'M-Pesa',
              mpesaPhone: mpesaPhone,
              cashier: currentUser.name,
              itemDetails: [...cart]
            };
            
            setSales([newSale, ...sales]);
            
            const updatedProducts = products.map(product => {
              const cartItem = cart.find(item => item.id === product.id);
              return cartItem ? { ...product, stock: product.stock - cartItem.quantity } : product;
            });
            setProducts(updatedProducts);
            
            setLastSale(newSale);
            setShowReceipt(true);
            setCart([]);
            setMpesaPhone('');
          }, [cart, cartTotal, sales, products, mpesaPhone, currentUser]);

          const completeSale = () => {
            if (cart.length === 0) {
              alert('Cart is empty!');
              return;
            }

            // Validate split payment
            if (paymentMethod === 'Split') {
              if ((splitPayment.cashAmount + splitPayment.mpesaAmount) < cartTotal) {
                alert('Split payment amounts do not cover the total!');
                return;
              }
            }
            
            // For Cash, Card, and Split payments, complete immediately
            const total = parseFloat(cartTotal.toFixed(2));
            const cost = parseFloat(cart.reduce((sum, item) => {
              const itemCost = parseFloat(item.costPrice || item.buyingPrice || 0);
              const itemQty = parseFloat(item.quantity || 0);
              return sum + (itemCost * itemQty);
            }, 0).toFixed(2));
            const profit = parseFloat((total - cost).toFixed(2));
            
            const newSale = {
              id: sales.length + 1,
              date: new Date().toISOString().split('T')[0],
              time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
              items: parseFloat(cart.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0).toFixed(2)),
              total,
              profit,
              paymentMethod: paymentMethod,
              amountReceived: paymentMethod === 'Cash' ? amountReceived : 0,
              mpesaPhone: paymentMethod === 'M-Pesa' ? mpesaPhone : (paymentMethod === 'Split' && splitPayment.mpesaAmount > 0 ? mpesaPhone : null),
              splitCash: paymentMethod === 'Split' ? splitPayment.cashAmount : null,
              splitMpesa: paymentMethod === 'Split' ? splitPayment.mpesaAmount : null,
              cashier: currentUser.name,
              itemDetails: cart.map(item => ({
                ...item,
                quantity: parseFloat(item.quantity || 0),
                costPrice: parseFloat(item.costPrice || item.buyingPrice || 0),
                sellingPrice: parseFloat(item.sellingPrice || item.price || 0),
                lineTotal: parseFloat(((item.sellingPrice || item.price || 0) * (item.quantity || 0)).toFixed(2)),
                lineCost: parseFloat(((item.costPrice || item.buyingPrice || 0) * (item.quantity || 0)).toFixed(2)),
                lineProfit: parseFloat((((item.sellingPrice || item.price || 0) - (item.costPrice || item.buyingPrice || 0)) * (item.quantity || 0)).toFixed(2))
              })),
              // Loyalty info
              customerId: selectedCustomer?.id || null,
              customerName: selectedCustomer?.name || null,
              pointsEarned: selectedCustomer ? pointsToEarn : 0
            };
            
            setSales([newSale, ...sales]);
            
            // Update product stock
            const updatedProducts = products.map(product => {
              const cartItem = cart.find(item => item.id === product.id);
              return cartItem ? { ...product, stock: product.stock - cartItem.quantity } : product;
            });
            setProducts(updatedProducts);
            
            // Award loyalty points to customer
            if (selectedCustomer) {
              const updatedCustomers = customers.map(c => {
                if (c.id === selectedCustomer.id) {
                  return {
                    ...c,
                    points: c.points + pointsToEarn,
                    totalSpent: (c.totalSpent || 0) + total,
                    visits: (c.visits || 0) + 1,
                    lastVisit: new Date().toISOString().split('T')[0]
                  };
                }
                return c;
              });
              setCustomers(updatedCustomers);
            }
            
            setLastSale(newSale);
            setShowReceipt(true);
            setCart([]);
            setAmountReceived(0);
            setMpesaPhone('');
            setSelectedCustomer(null);
            setSplitPayment({ enabled: false, cashAmount: 0, mpesaAmount: 0 });
          };

          const printReceipt = () => {
            try {
              // Method 1: Try direct window.print()
              if (showReceipt && lastSale) {
                // Create a new window with just the receipt content (80mm = ~302px)
                const printWindow = window.open('', '_blank', 'width=302,height=800');
                if (printWindow) {
                  const receiptContent = document.querySelector('.receipt-print-area');
                  if (receiptContent) {
                    printWindow.document.write(`
                      <!DOCTYPE html>
                      <html>
                        <head>
                          <title>Receipt Print</title>
                          <style>
                            @page {
                              size: 80mm auto;
                              margin: 0;
                            }
                            * {
                              box-sizing: border-box;
                              margin: 0;
                              padding: 0;
                            }
                            body {
                              margin: 0;
                              padding: 2mm;
                              font-family: 'Courier New', Courier, monospace;
                              font-size: 10px;
                              width: 80mm;
                              max-width: 80mm;
                              background: white;
                              line-height: 1.2;
                            }
                            h2 {
                              font-size: 14px !important;
                              margin: 0 !important;
                              padding: 0 !important;
                            }
                            p {
                              font-size: 9px !important;
                              margin: 1px 0 !important;
                            }
                            div {
                              font-size: 10px !important;
                            }
                            table {
                              width: 100%;
                              border-collapse: collapse;
                              font-size: 10px !important;
                            }
                            img {
                              max-width: 60px !important;
                              max-height: 60px !important;
                              width: 60px !important;
                              height: 60px !important;
                            }
                            .qr-code-container img {
                              max-width: 60px !important;
                              max-height: 60px !important;
                              width: 60px !important;
                              height: 60px !important;
                            }
                            [style*="fontSize"] {
                              font-size: 10px !important;
                            }
                            [style*="font-size"] {
                              font-size: 10px !important;
                            }
                            [style*="padding"] {
                              padding: 4px !important;
                            }
                            [style*="margin"] {
                              margin: 2px 0 !important;
                            }
                          </style>
                        </head>
                        <body>
                          ${receiptContent.innerHTML}
                        </body>
                      </html>
                    `);
                    printWindow.document.close();
                    
                    // Wait for content to load, then print
                    setTimeout(() => {
                      printWindow.print();
                      // Close window after printing (optional)
                      // printWindow.close();
                    }, 250);
                  } else {
                    // Fallback to window.print()
                    window.print();
                  }
                } else {
                  // Popup blocked, fallback to window.print()
                  window.print();
                }
              } else {
                // Fallback to window.print()
                window.print();
              }
            } catch (error) {
              console.error('Print error:', error);
              // Final fallback
              alert('Print error: ' + error.message + '\n\nPlease try:\n1. Press Ctrl+P manually\n2. Check printer connection\n3. Allow pop-ups for this site\n4. Check browser print permissions');
              // Try basic print as last resort
              try {
                window.print();
              } catch (e) {
                console.error('Final print attempt failed:', e);
              }
            }
          };

          const scanForStock = () => {
            if (!stockBarcode) {
              alert('Please enter a barcode or product name!');
              return;
            }
            // Try to find by barcode first
            let product = products.find(p => p.barcode === stockBarcode);
            // If not found, try to find by name (case-insensitive, partial match)
            if (!product) {
              const searchTerm = stockBarcode.toLowerCase();
              const matches = products.filter(p => 
                p.name.toLowerCase().includes(searchTerm)
              );
              if (matches.length === 1) {
                product = matches[0];
              } else if (matches.length > 1) {
                // Multiple matches - show selection
                const productNames = matches.map((p, idx) => `${idx + 1}. ${p.name} (Stock: ${p.stock})`).join('\n');
                const selection = prompt(`Multiple products found:\n\n${productNames}\n\nEnter number (1-${matches.length}) or product name:`);
                if (selection) {
                  const idx = parseInt(selection) - 1;
                  if (idx >= 0 && idx < matches.length) {
                    product = matches[idx];
                  } else {
                    const selected = matches.find(p => p.name.toLowerCase() === selection.toLowerCase());
                    if (selected) product = selected;
                  }
                }
              }
            }
            
            if (product) {
              setScannedProduct(product);
              setStockQuantity('');
            } else {
              alert(`âŒ Product not found!\n\nSearch: ${stockBarcode}\n\nThis product is not in your system. Please add the product first.`);
            }
          };

          const addStock = () => {
            if (!scannedProduct || !stockQuantity || stockQuantity <= 0) {
              alert('Please enter a valid quantity!');
              return;
            }

            const qty = parseInt(stockQuantity);
            const updatedProducts = products.map(p => 
              p.id === scannedProduct.id ? { ...p, stock: p.stock + qty } : p
            );
            setProducts(updatedProducts);

            const stockEntry = {
              id: stockHistory.length + 1,
              date: new Date().toISOString().split('T')[0],
              time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
              productName: scannedProduct.name,
              barcode: scannedProduct.barcode,
              quantityAdded: qty,
              newStock: scannedProduct.stock + qty,
              user: currentUser.name
            };
            setStockHistory([stockEntry, ...stockHistory]);

            alert(`âœ… Stock Updated!\n\n${scannedProduct.name}\n+ ${qty} units\nNew Stock: ${scannedProduct.stock + qty}`);
            
            setStockBarcode('');
            setStockQuantity('');
            setScannedProduct(null);
          };

          const showDetails = (type) => {
            let data = {};
            switch(type) {
              case 'revenue':
                data = {
                  title: "Today's Revenue Details",
                  items: todaySales.map(s => ({
                    label: `Sale #${s.id} - ${s.time}`,
                    value: `KES ${s.total.toFixed(2)}`,
                    extra: `${s.items} items - ${s.paymentMethod}`
                  })),
                  total: `Total: KES ${todayRevenue.toFixed(2)}`
                };
                break;
              case 'profit':
                data = {
                  title: "Today's Profit Breakdown",
                  items: todaySales.map(s => ({
                    label: `Sale #${s.id} - ${s.time}`,
                    value: `KES ${s.profit.toFixed(2)}`,
                    extra: `Revenue: KES ${s.total.toFixed(2)}`
                  })),
                  total: `Total Profit: KES ${todayProfit.toFixed(2)}`
                };
                break;
              case 'inventory':
                data = {
                  title: "Inventory Value by Product",
                  items: products.map(p => ({
                    label: p.name,
                    value: `KES ${(p.sellingPrice * p.stock).toFixed(2)}`,
                    extra: `${p.stock} units @ KES ${p.sellingPrice} each`
                  })),
                  total: `Total Inventory: KES ${totalInventoryValue.toFixed(2)}`
                };
                break;
              case 'lowstock':
                data = {
                  title: "Low Stock Items - Action Required!",
                  items: lowStockItems.map(p => ({
                    label: p.name,
                    value: `${p.unit === 'litres' || p.unit === 'ml' || p.unit === 'kg' || p.unit === 'grams' ? parseFloat(p.stock || 0).toFixed(2) : p.stock} ${p.unit || 'units'}`,
                    extra: `Reorder at: ${p.reorderLevel} units`,
                    urgent: p.stock <= p.reorderLevel / 2
                  })),
                  total: `${lowStockItems.length} items need attention`
                };
                break;
            }
            setDetailModalData(data);
            setShowDetailModal(true);
          };

          // Memoized calculations for better performance (lowStockItems already defined above)
          
          const todayDate = new Date().toISOString().split('T')[0];
          
          const { expiringItems, expiredItems } = React.useMemo(() => {
            const today = new Date();
            const sevenDaysFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            return {
              expiringItems: products.filter(p => {
                if (!p.expiryDate) return false;
                const expiry = new Date(p.expiryDate);
                return expiry <= sevenDaysFromNow && expiry >= today;
              }),
              expiredItems: products.filter(p => {
                if (!p.expiryDate) return false;
                return new Date(p.expiryDate) < new Date();
              })
            };
          }, [products]);
          
          const todaySales = React.useMemo(() => sales.filter(s => s.date === todayDate), [sales, todayDate]);
          const todayRevenue = React.useMemo(() => todaySales.reduce((sum, s) => sum + s.total, 0), [todaySales]);
          const todayProfit = React.useMemo(() => todaySales.reduce((sum, s) => sum + (s.profit || 0), 0), [todaySales]);
          const totalInventoryValue = React.useMemo(() => products.reduce((sum, p) => sum + (p.sellingPrice * p.stock), 0), [products]);

          // Product management functions
          const saveProductEdit = (productId) => {
            const unit = editingProduct.unit || 'pieces';
            const updatedProduct = {
              ...editingProduct,
              costPrice: parseFloat(editingProduct.costPrice) || 0,
              sellingPrice: parseFloat(editingProduct.sellingPrice) || 0,
              marketPrice: editingProduct.marketPrice ? parseFloat(editingProduct.marketPrice) : null,
              stock: (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams') 
                ? parseFloat(editingProduct.stock) || 0 
                : parseInt(editingProduct.stock) || 0,
              unit: unit,
              reorderLevel: (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams')
                ? parseFloat(editingProduct.reorderLevel) || 10
                : parseInt(editingProduct.reorderLevel) || 10
            };
            setProducts(products.map(p => p.id === productId ? updatedProduct : p));
            setEditingProduct(null);
            alert('âœ… Product updated successfully!');
          };

          const addNewProduct = () => {
            if (!newProduct.name || !newProduct.sellingPrice) {
              alert('Please fill in all required fields (Name and Selling Price)!');
              return;
            }
            // Generate unique identifier if no barcode provided
            const productBarcode = newProduct.barcode || `NO-BARCODE-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const product = {
              id: Math.max(...products.map(p => p.id), 0) + 1,
              ...newProduct,
              barcode: productBarcode,
              costPrice: parseFloat(newProduct.costPrice) || 0,
              sellingPrice: parseFloat(newProduct.sellingPrice) || 0,
              marketPrice: parseFloat(newProduct.marketPrice) || null,
              stock: newProduct.unit === 'litres' || newProduct.unit === 'ml' || newProduct.unit === 'kg' || newProduct.unit === 'grams' 
                ? parseFloat(newProduct.stock) || 0 
                : parseInt(newProduct.stock) || 0,
              unit: newProduct.unit || 'pieces',
              reorderLevel: newProduct.unit === 'litres' || newProduct.unit === 'ml' || newProduct.unit === 'kg' || newProduct.unit === 'grams'
                ? parseFloat(newProduct.reorderLevel) || 10
                : parseInt(newProduct.reorderLevel) || 10
            };
            setProducts([...products, product]);
            setNewProduct({ name: '', barcode: '', category: '', costPrice: '', sellingPrice: '', marketPrice: '', stock: '', unit: 'pieces', reorderLevel: 10 });
            setShowAddProduct(false);
            alert('âœ… Product added successfully!');
          };

          const deleteProduct = (productId) => {
            if (window.confirm('Are you sure you want to delete this product?')) {
              setProducts(products.filter(p => p.id !== productId));
            }
          };

          // Purchase functions
          const addPurchaseItem = () => {
            if (!purchaseItem.productId || !purchaseItem.qty || !purchaseItem.unitCost) {
              alert('Please fill in all item fields!');
              return;
            }
            const product = products.find(p => p.id === parseInt(purchaseItem.productId));
            const item = {
              name: product.name,
              productId: product.id,
              qty: parseInt(purchaseItem.qty),
              unitCost: parseFloat(purchaseItem.unitCost)
            };
            const newItems = [...newPurchase.items, item];
            const newTotal = newItems.reduce((sum, i) => sum + (i.qty * i.unitCost), 0);
            setNewPurchase({ ...newPurchase, items: newItems, total: newTotal });
            setPurchaseItem({ productId: '', qty: '', unitCost: '' });
          };

          const savePurchase = () => {
            if (!newPurchase.supplier || newPurchase.items.length === 0) {
              alert('Please add supplier and at least one item!');
              return;
            }
            const purchase = {
              id: purchases.length > 0 ? Math.max(...purchases.map(p => p.id)) + 1 : 1,
              date: new Date().toISOString().split('T')[0],
              supplier: newPurchase.supplier,
              items: newPurchase.items,
              total: parseFloat(newPurchase.total.toFixed(2)),
              amountPaid: 0,
              status: 'Pending',
              invoiceNo: `PO-${String(purchases.length + 1).padStart(3, '0')}`
            };
            setPurchases([purchase, ...purchases]);
            setNewPurchase({ supplier: '', items: [], total: 0 });
            setShowPurchaseForm(false);
            alert('âœ… Purchase order created!');
          };

          const receivePurchase = (purchaseId) => {
            const purchase = purchases.find(p => p.id === purchaseId);
            if (purchase && purchase.status === 'Pending') {
              // Update stock for each item
              const updatedProducts = [...products];
              purchase.items.forEach(item => {
                const productIndex = updatedProducts.findIndex(p => p.id === item.productId);
                if (productIndex !== -1) {
                  updatedProducts[productIndex] = {
                    ...updatedProducts[productIndex],
                    stock: updatedProducts[productIndex].stock + item.qty
                  };
                }
              });
              setProducts(updatedProducts);
              
              // Update purchase status
              setPurchases(purchases.map(p => 
                p.id === purchaseId ? { ...p, status: 'Received', receivedDate: new Date().toISOString().split('T')[0] } : p
              ));
              alert('âœ… Stock received and updated!');
            }
          };

          // Invoice functions
          const generateInvoice = () => {
            if (!selectedSaleForInvoice || !invoiceCustomer.name) {
              alert('Please select a sale and enter customer details!');
              return;
            }
            const sale = sales.find(s => s.id === selectedSaleForInvoice);
            const subtotal = parseFloat(sale.total || 0);
            const taxRate = 0.16; // 16% VAT
            const tax = parseFloat((subtotal * taxRate).toFixed(2));
            const total = parseFloat((subtotal + tax).toFixed(2));
            
            const invoice = {
              id: invoices.length > 0 ? Math.max(...invoices.map(i => i.id)) + 1 : 1,
              invoiceNo: `INV-${String(invoices.length + 1).padStart(5, '0')}`,
              date: new Date().toISOString().split('T')[0],
              dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
              customer: { ...invoiceCustomer },
              items: (sale.itemDetails || []).map(item => ({
                ...item,
                lineTotal: parseFloat(((item.sellingPrice || item.price || 0) * (item.quantity || 0)).toFixed(2))
              })),
              subtotal: subtotal,
              tax: tax,
              total: total,
              status: 'Unpaid',
              saleId: sale.id
            };
            setInvoices([invoice, ...invoices]);
            setCurrentInvoice(invoice);
            setShowInvoiceForm(false);
            setShowInvoicePreview(true);
            setInvoiceCustomer({ name: '', address: '', phone: '', email: '', taxId: '' });
            setSelectedSaleForInvoice(null);
          };

          const markInvoicePaid = (invoiceId) => {
            setInvoices(invoices.map(inv => 
              inv.id === invoiceId ? { ...inv, status: 'Paid', paidDate: new Date().toISOString().split('T')[0] } : inv
            ));
          };

          // Report filtering
          const getFilteredSales = () => {
            let filtered = [...sales];
            if (reportDateRange.start) {
              filtered = filtered.filter(s => s.date >= reportDateRange.start);
            }
            if (reportDateRange.end) {
              filtered = filtered.filter(s => s.date <= reportDateRange.end);
            }
            return filtered;
          };

          const getBestSellingProducts = () => {
            const productSales = {};
            const filteredSales = getFilteredSales();
            filteredSales.forEach(sale => {
              if (sale.itemDetails) {
                sale.itemDetails.forEach(item => {
                  if (!productSales[item.name]) {
                    productSales[item.name] = { 
                      name: item.name, 
                      quantity: 0, 
                      revenue: 0, 
                      cost: 0,
                      profit: 0,
                      buyingPrice: item.costPrice || item.buyingPrice || 0,
                      sellingPrice: item.sellingPrice || item.price || 0
                    };
                  }
                  const qty = parseFloat(item.quantity) || 0;
                  const sellPrice = parseFloat(item.sellingPrice || item.price || 0);
                  const costPrice = parseFloat(item.costPrice || item.buyingPrice || 0);
                  productSales[item.name].quantity += qty;
                  productSales[item.name].revenue += sellPrice * qty;
                  productSales[item.name].cost += costPrice * qty;
                  productSales[item.name].profit += (sellPrice - costPrice) * qty;
                });
              }
            });
            return Object.values(productSales).sort((a, b) => b.revenue - a.revenue);
          };

          const getDailySalesBreakdown = () => {
            const filteredSales = getFilteredSales();
            const breakdown = {};
            filteredSales.forEach(sale => {
              const saleDate = sale.date || new Date().toISOString().split('T')[0];
              if (!breakdown[saleDate]) {
                breakdown[saleDate] = {
                  date: saleDate,
                  products: {},
                  totalRevenue: 0,
                  totalCost: 0,
                  totalProfit: 0,
                  totalItemsSold: 0,
                  transactionCount: 0
                };
              }
              breakdown[saleDate].transactionCount++;
              breakdown[saleDate].totalRevenue += parseFloat(sale.total || 0);
              breakdown[saleDate].totalProfit += parseFloat(sale.profit || 0);
              
              if (sale.itemDetails) {
                sale.itemDetails.forEach(item => {
                  const itemName = item.name;
                  if (!breakdown[saleDate].products[itemName]) {
                    breakdown[saleDate].products[itemName] = {
                      name: itemName,
                      quantitySold: 0,
                      revenue: 0,
                      cost: 0,
                      profit: 0,
                      buyingPrice: parseFloat(item.costPrice || item.buyingPrice || 0),
                      sellingPrice: parseFloat(item.sellingPrice || item.price || 0)
                    };
                  }
                  const qty = parseFloat(item.quantity) || 0;
                  const sellPrice = parseFloat(item.sellingPrice || item.price || 0);
                  const costPrice = parseFloat(item.costPrice || item.buyingPrice || 0);
                  breakdown[saleDate].products[itemName].quantitySold += qty;
                  breakdown[saleDate].products[itemName].revenue += sellPrice * qty;
                  breakdown[saleDate].products[itemName].cost += costPrice * qty;
                  breakdown[saleDate].products[itemName].profit += (sellPrice - costPrice) * qty;
                  breakdown[saleDate].totalItemsSold += qty;
                  breakdown[saleDate].totalCost += costPrice * qty;
                });
              }
            });
            return Object.values(breakdown).sort((a, b) => new Date(b.date) - new Date(a.date));
          };

          // Hold/Park current order
          const holdOrder = () => {
            if (cart.length === 0) {
              alert('Cart is empty!');
              return;
            }
            const holdName = prompt('Enter a name for this order (e.g., customer name):');
            if (holdName) {
              const heldOrder = {
                id: Date.now(),
                name: holdName,
                items: [...cart],
                total: cart.reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0),
                time: new Date().toLocaleTimeString(),
                date: new Date().toISOString().split('T')[0]
              };
              setHeldOrders([...heldOrders, heldOrder]);
              setCart([]);
              setAmountReceived(0);
              alert('âœ… Order held!\n\nName: ' + holdName + '\n\nYou can retrieve it anytime from "Held Orders"');
            }
          };

          // Retrieve held order
          const retrieveOrder = (orderId) => {
            const order = heldOrders.find(o => o.id === orderId);
            if (order) {
              if (cart.length > 0) {
                if (!window.confirm('Current cart has items. Replace with held order?')) {
                  return;
                }
              }
              setCart(order.items);
              setHeldOrders(heldOrders.filter(o => o.id !== orderId));
              setShowHeldOrders(false);
            }
          };

          // Delete held order
          const deleteHeldOrder = (orderId) => {
            if (window.confirm('Delete this held order?')) {
              setHeldOrders(heldOrders.filter(o => o.id !== orderId));
            }
          };

          // Void/Refund a completed sale
          const voidSale = (saleId) => {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;
            
            if (!window.confirm(`âš ï¸ VOID SALE #${saleId}?\n\nTotal: KES ${sale.total}\nItems: ${sale.items}\n\nThis will:\nâ€¢ Remove the sale from records\nâ€¢ Restore stock for all items\nâ€¢ Cannot be undone!`)) {
              return;
            }
            
            // Restore stock
            if (sale.itemDetails) {
              const updatedProducts = products.map(product => {
                const saleItem = sale.itemDetails.find(item => item.id === product.id);
                if (saleItem) {
                  return { ...product, stock: product.stock + saleItem.quantity };
                }
                return product;
              });
              setProducts(updatedProducts);
            }
            
            // Mark sale as voided (or remove it)
            setSales(sales.map(s => s.id === saleId ? { ...s, voided: true, voidedAt: new Date().toISOString() } : s));
            
            alert('âœ… Sale #' + saleId + ' has been voided.\n\nStock has been restored.');
            setShowVoidSale(false);
          };

          // Cancel current order with confirmation
          const cancelOrder = () => {
            if (cart.length === 0) return;
            
            if (window.confirm(`ðŸš« CANCEL ORDER?\n\nItems: ${cart.length}\nTotal: KES ${cartTotal.toLocaleString()}\n\nThis will clear the entire cart.`)) {
              setCart([]);
              setAmountReceived(0);
              setMpesaPhone('');
            }
          };

          if (!isLoggedIn) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                  <div className="text-center mb-8">
                    <div className="inline-block p-4 bg-blue-100 rounded-full mb-4">
                      <ShoppingCart size={48} />
                    </div>
                      <h1 className="text-3xl font-bold text-gray-800">43 INDUSTRIES SUPERMARKET MANAGER</h1>
                    <p className="text-gray-600 mt-2">Complete System</p>
                  </div>
                  <form onSubmit={handleLogin} className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Username</label>
                      <input
                        type="text"
                        value={loginForm.username}
                        onChange={(e) => setLoginForm({ ...loginForm, username: e.target.value })}
                        className="w-full px-4 py-3 border rounded-lg"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                      <input
                        type="password"
                        value={loginForm.password}
                        onChange={(e) => setLoginForm({ ...loginForm, password: e.target.value })}
                        className="w-full px-4 py-3 border rounded-lg"
                        required
                      />
                    </div>
                    <div className="flex items-center mb-4">
                      <input
                        type="checkbox"
                        id="rememberMe"
                        checked={loginForm.rememberMe}
                        onChange={(e) => setLoginForm({ ...loginForm, rememberMe: e.target.checked })}
                        className="w-4 h-4 text-blue-600 rounded"
                      />
                      <label htmlFor="rememberMe" className="ml-2 text-sm text-gray-700">
                        Stay logged in (you won't need to enter password again)
                      </label>
                    </div>

                    <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                      Sign In
                    </button>
                  </form>
                  
                  <div className="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p className="text-xs text-green-700 font-semibold mb-2">âœ… Auto-Login Enabled!</p>
                    <p className="text-xs text-green-600">Once you login, you'll stay logged in even after closing the browser. Just open the page and start working!</p>
                  </div>

                  <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                    <p className="text-xs text-gray-600 font-semibold mb-2">Demo Credentials:</p>
                    <p className="text-xs text-gray-600">Admin: admin / admin123</p>
                    <p className="text-xs text-gray-600">Cashier: cashier / cashier123</p>
                  </div>
                </div>
              </div>
            );
          }

          const menuItems = [
            { id: 'dashboard', label: 'Dashboard', icon: TrendingUp, roles: ['Admin', 'Cashier'] },
            { id: 'pos', label: 'Point of Sale', icon: ShoppingCart, roles: ['Admin', 'Cashier'] },
            { id: 'lowstock', label: 'Low Stock', icon: AlertCircle, roles: ['Admin'] },
            { id: 'stock', label: 'Add Stock', icon: Plus, roles: ['Admin'] },
            { id: 'products', label: 'Products & Prices', icon: Package, roles: ['Admin'] },
            { id: 'purchases', label: 'Purchases', icon: Truck, roles: ['Admin'] },
            { id: 'invoices', label: 'Invoices', icon: ClipboardList, roles: ['Admin'] },
            { id: 'customers', label: 'Customers', icon: Users, roles: ['Admin', 'Cashier'] },
            { id: 'suppliers', label: 'Suppliers', icon: Truck, roles: ['Admin'] },
            { id: 'expenses', label: 'Expenses', icon: DollarSign, roles: ['Admin'] },
            { id: 'reports', label: 'Reports', icon: BarChart, roles: ['Admin'] },
            { id: 'settings', label: 'Store Settings', icon: Settings, roles: ['Admin'] },
          ];

          const filteredMenuItems = menuItems.filter(item => item.roles.includes(currentUser?.role));

          // Detail Modal Component
          const DetailModal = () => {
            if (!showDetailModal || !detailModalData) return null;

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
                  <div className="p-6 border-b bg-gradient-to-r from-blue-500 to-blue-600">
                    <h2 className="text-2xl font-bold text-white">{detailModalData.title}</h2>
                  </div>
                  
                  <div className="p-6 overflow-y-auto max-h-[60vh]">
                    {detailModalData.items.length === 0 ? (
                      <p className="text-center text-gray-500 py-8">No data available</p>
                    ) : (
                      <div className="space-y-2">
                        {detailModalData.items.map((item, idx) => (
                          <div 
                            key={idx} 
                            className={`p-4 rounded-lg border ${
                              item.urgent 
                                ? 'bg-red-50 border-red-300' 
                                : 'bg-gray-50 border-gray-200 hover:bg-blue-50'
                            }`}
                          >
                            <div className="flex justify-between items-center">
                              <div className="flex-1">
                                <p className={`font-semibold ${item.urgent ? 'text-red-800' : 'text-gray-800'}`}>
                                  {item.label}
                                </p>
                                <p className="text-sm text-gray-600 mt-1">{item.extra}</p>
                              </div>
                              <p className={`text-lg font-bold ${item.urgent ? 'text-red-600' : 'text-blue-600'}`}>
                                {item.value}
                              </p>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  <div className="p-6 border-t bg-gray-50">
                    <div className="flex justify-between items-center mb-4">
                      <p className="text-lg font-bold text-gray-800">{detailModalData.total}</p>
                      <p className="text-sm text-gray-600">{detailModalData.items.length} entries</p>
                    </div>
                    <button
                      onClick={() => setShowDetailModal(false)}
                      className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
                    >
                      Close
                    </button>
                  </div>
                </div>
              </div>
            );
          };

          // M-Pesa Payment Prompt Modal
          const MpesaPromptModal = () => {
            if (!showMpesaPrompt) return null;

            const total = cart.reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0);

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                  <div className="p-6 border-b bg-gradient-to-r from-green-500 to-green-600">
                    <div className="flex items-center gap-3">
                      <Smartphone className="text-white" size={32} />
                      <div>
                        <h2 className="text-2xl font-bold text-white">M-Pesa Payment</h2>
                        <p className="text-sm text-green-100">Send payment prompt to customer</p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="p-6">
                    <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-4">
                      <div className="flex justify-between items-center">
                        <span className="text-gray-700">Amount to Pay:</span>
                        <span className="text-2xl font-bold text-green-600">KES {total.toFixed(2)}</span>
                      </div>
                    </div>

                    <div className="mb-4">
                      <label className="block text-sm font-medium mb-2">Customer Phone Number</label>
                      <input
                        type="tel"
                        placeholder="254712345678 or 0712345678"
                        value={mpesaPhone}
                        onChange={(e) => setMpesaPhone(e.target.value)}
                        className="w-full px-4 py-3 border-2 border-green-300 rounded-lg text-lg font-mono focus:border-green-500"
                        autoFocus
                      />
                      <p className="text-xs text-gray-500 mt-1">Format: 254712345678 (without +) or 0712345678</p>
                    </div>

                    {mpesaProcessing ? (
                      <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6 mb-4 text-center">
                        <div className="animate-spin inline-block w-8 h-8 border-4 border-yellow-500 border-t-transparent rounded-full mb-3"></div>
                        <p className="font-bold text-yellow-800">Processing Payment...</p>
                        <p className="text-sm text-yellow-700 mt-2">Customer checking their phone for M-Pesa prompt</p>
                      </div>
                    ) : (
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <p className="text-sm text-blue-800 font-semibold mb-2">ðŸ“± How it works:</p>
                        <ol className="text-xs text-blue-700 space-y-1 list-decimal list-inside">
                          <li>Enter customer's M-Pesa phone number</li>
                          <li>Click "Send Payment Prompt"</li>
                          <li>Customer receives pop-up on their phone</li>
                          <li>Customer enters M-Pesa PIN</li>
                          <li>Payment confirmed automatically!</li>
                        </ol>
                      </div>
                    )}

                    <div className="flex gap-2">
                      <button
                        onClick={initiateMpesaPayment}
                        disabled={mpesaProcessing || !mpesaPhone}
                        className={`flex-1 py-3 rounded-lg font-bold flex items-center justify-center gap-2 ${
                          mpesaProcessing || !mpesaPhone
                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            : 'bg-green-600 text-white hover:bg-green-700'
                        }`}
                      >
                        <Smartphone size={20} />
                        {mpesaProcessing ? 'Processing...' : 'Send Payment Prompt'}
                      </button>
                      <button
                        onClick={() => {
                          setShowMpesaPrompt(false);
                          setMpesaPhone('');
                        }}
                        disabled={mpesaProcessing}
                        className="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                      >
                        Cancel
                      </button>
                    </div>

                    <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                      <p className="text-xs text-yellow-800">
                        <strong>âš ï¸ DEMO MODE:</strong> This simulates M-Pesa payment. For real payments, you need M-Pesa Daraja API credentials.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          // Receipt Modal Component - Enhanced with QR Code & Thermal Print Support (80mm)
          const ReceiptModal = () => {
            const [qrCodeUrl, setQrCodeUrl] = React.useState('');
            const receiptPrintRef = React.useRef(null);
            
            // Generate QR code when receipt is shown
            React.useEffect(() => {
              if (showReceipt && lastSale) {
                // Simple receipt code for QR
                const qrText = `RCP-${lastSale.id}-${lastSale.total}-${lastSale.date}`;
                
                // Try to generate QR code
                if (typeof QRCode !== 'undefined' && QRCode.toDataURL) {
                  QRCode.toDataURL(qrText, {
                    width: 150,
                    margin: 2,
                    color: { dark: '#000000', light: '#ffffff' }
                  }).then(url => {
                    setQrCodeUrl(url);
                  }).catch(err => {
                    console.error('QR Code generation failed:', err);
                    setQrCodeUrl('');
                  });
                } else {
                  console.log('QRCode library not available');
                  setQrCodeUrl('');
                }
              }
            }, [showReceipt, lastSale]);
            
            // Handle keyboard shortcut (Ctrl+P or Cmd+P)
            React.useEffect(() => {
              const handleKeyPress = (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'p' && showReceipt) {
                  e.preventDefault();
                  printReceipt();
                }
              };
              window.addEventListener('keydown', handleKeyPress);
              return () => window.removeEventListener('keydown', handleKeyPress);
            }, [showReceipt]);
            
            if (!showReceipt || !lastSale) return null;

            const received = amountReceived || lastSale.amountReceived || 0;
            const change = paymentMethod === 'Cash' && received > 0 ? received - lastSale.total : 0;
            const receiptNumber = `RCP${String(lastSale.id).padStart(6, '0')}`;

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 no-print-parent">
                <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto no-print-parent">
                  {/* Receipt Display - Larger on screen */}
                  <div ref={receiptPrintRef} className="receipt-print-area thermal-receipt" style={{fontFamily: "'Courier New', Courier, monospace", padding: '8px'}}>
                    
                    {/* Header - Store Name */}
                    <div className="text-center" style={{borderBottom: '1px dashed #000', paddingBottom: '6px', marginBottom: '6px'}}>
                      <h2 style={{fontSize: '14px', fontWeight: 'bold', margin: '0', lineHeight: '1.2'}}>{storeConfig.storeName}</h2>
                      <p style={{fontSize: '10px', margin: '2px 0', fontWeight: 'bold'}}>TAX INVOICE</p>
                      <p style={{fontSize: '9px', margin: '1px 0'}}>PIN: {storeConfig.taxPin}</p>
                      <p style={{fontSize: '9px', margin: '1px 0'}}>Tel: {storeConfig.phone}</p>
                      {storeConfig.address && <p style={{fontSize: '8px', margin: '1px 0'}}>{storeConfig.address}</p>}
                    </div>

                    {/* Receipt Info */}
                    <div style={{fontSize: '10px', padding: '6px 0', borderBottom: '1px dashed #000', marginBottom: '6px'}}>
                      <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '3px'}}>
                        <span>Receipt #:</span>
                        <span style={{fontWeight: 'bold'}}>{receiptNumber}</span>
                      </div>
                      <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '3px'}}>
                        <span>Date:</span>
                        <span>{lastSale.date}</span>
                      </div>
                      <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '3px'}}>
                        <span>Time:</span>
                        <span>{lastSale.time}</span>
                      </div>
                      <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '3px'}}>
                        <span>Cashier:</span>
                        <span>{lastSale.cashier}</span>
                      </div>
                      <div style={{display: 'flex', justifyContent: 'space-between'}}>
                        <span>Payment:</span>
                        <span style={{fontWeight: 'bold', color: '#16a34a'}}>{lastSale.paymentMethod}</span>
                      </div>
                      {lastSale.mpesaPhone && (
                        <div style={{background: '#dcfce7', padding: '4px', marginTop: '4px', fontSize: '9px', borderRadius: '4px'}}>
                          <div style={{fontWeight: 'bold', color: '#16a34a'}}>ðŸ“± M-Pesa: {lastSale.mpesaPhone}</div>
                          <div style={{color: '#666'}}>Txn: MPX{lastSale.id}{Date.now().toString().slice(-6)}</div>
                        </div>
                      )}
                    </div>

                    {/* Items */}
                    <div style={{padding: '6px 0', borderBottom: '1px dashed #000', marginBottom: '6px'}}>
                      <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '9px', fontWeight: 'bold', borderBottom: '1px solid #ccc', paddingBottom: '3px', marginBottom: '4px', color: '#666'}}>
                        <span style={{flex: 2}}>ITEM</span>
                        <span style={{flex: 0.5, textAlign: 'center'}}>QTY</span>
                        <span style={{flex: 1, textAlign: 'right'}}>PRICE</span>
                        <span style={{flex: 1, textAlign: 'right'}}>TOTAL</span>
                      </div>
                      {lastSale.itemDetails && lastSale.itemDetails.map((item, idx) => (
                        <div key={idx} style={{display: 'flex', justifyContent: 'space-between', fontSize: '10px', padding: '3px 0', borderBottom: '1px dotted #ddd'}}>
                          <span style={{flex: 2, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>{item.name}</span>
                          <span style={{flex: 0.5, textAlign: 'center', fontWeight: 'bold'}}>{typeof item.quantity === 'number' ? (item.quantity % 1 === 0 ? item.quantity : item.quantity.toFixed(2)) : item.quantity}</span>
                          <span style={{flex: 1, textAlign: 'right'}}>{item.sellingPrice.toLocaleString()}</span>
                          <span style={{flex: 1, textAlign: 'right', fontWeight: 'bold'}}>{((item.sellingPrice || 0) * (item.quantity || 0)).toLocaleString()}</span>
                        </div>
                      ))}
                    </div>

                    {/* Totals */}
                    <div style={{padding: '6px 0', fontSize: '10px'}}>
                      <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '4px'}}>
                        <span>Subtotal ({lastSale.items} items):</span>
                        <span>KES {lastSale.total.toLocaleString()}</span>
                      </div>
                      <div style={{display: 'flex', justifyContent: 'space-between', fontWeight: 'bold', fontSize: '12px', marginTop: '4px', padding: '4px', background: '#f0fdf4', borderRadius: '4px', color: '#16a34a'}}>
                        <span>TOTAL:</span>
                        <span>KES {lastSale.total.toLocaleString()}</span>
                      </div>
                      {(paymentMethod === 'Cash' && (amountReceived > 0 || lastSale.amountReceived)) && (() => {
                        const received = amountReceived || lastSale.amountReceived || 0;
                        const calcChange = received - lastSale.total;
                        return (
                          <div style={{marginTop: '6px', padding: '4px', background: '#fef3c7', borderRadius: '4px'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '10px'}}>
                              <span>Cash Received:</span>
                              <span>KES {received.toLocaleString()}</span>
                            </div>
                            {calcChange > 0 && (
                              <div style={{display: 'flex', justifyContent: 'space-between', fontWeight: 'bold', fontSize: '11px', color: '#16a34a', marginTop: '4px'}}>
                                <span>Change:</span>
                                <span>KES {calcChange.toLocaleString()}</span>
                              </div>
                            )}
                          </div>
                        );
                      })()}
                    </div>

                    {/* QR Code / Receipt Code */}
                    <div className="qr-code-container" style={{textAlign: 'center', padding: '6px 0', borderTop: '1px dashed #000', borderBottom: '1px dashed #000', marginTop: '6px', marginBottom: '6px'}}>
                      {qrCodeUrl ? (
                        <div>
                          <img src={qrCodeUrl} alt="Receipt QR Code" style={{width: '60px', height: '60px', margin: '0 auto', display: 'block'}} />
                          <p style={{fontSize: '8px', margin: '4px 0 0 0', color: '#666'}}>Scan for digital receipt</p>
                        </div>
                      ) : (
                        <div style={{padding: '8px', background: '#f5f5f5', borderRadius: '4px'}}>
                          <p style={{fontSize: '9px', fontWeight: 'bold', color: '#333'}}>Receipt Code</p>
                          <p style={{fontSize: '11px', fontWeight: 'bold', fontFamily: 'monospace', color: '#000', marginTop: '4px'}}>{receiptNumber}</p>
                        </div>
                      )}
                    </div>

                    {/* Footer */}
                    <div style={{textAlign: 'center', padding: '6px 0', fontSize: '9px'}}>
                      <p style={{fontWeight: 'bold', margin: '2px 0', fontSize: '10px'}}>Thank you for shopping with us!</p>
                      <p style={{margin: '2px 0', color: '#666', fontSize: '8px'}}>Keep receipt for returns (7 days)</p>
                      <p style={{margin: '4px 0', fontSize: '8px', color: '#999'}}>================================</p>
                      <p style={{margin: '2px 0', fontSize: '8px', color: '#999'}}>Goods once sold are not returnable</p>
                      {storeConfig.showFooter && (
                        <p style={{margin: '6px 0 2px 0', fontSize: '7px', color: '#666', fontStyle: 'italic'}}>{storeConfig.footerText}</p>
                      )}
                    </div>
                  </div>

                  {/* Action Buttons (hidden when printing) */}
                  <div className="no-print flex gap-2 p-4 border-t bg-gray-50">
                    <button
                      onClick={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        printReceipt();
                      }}
                      className="flex-1 bg-blue-600 text-white py-3 rounded-lg flex items-center justify-center gap-2 hover:bg-blue-700 font-bold"
                    >
                      <Printer size={20} />
                      Print Receipt (Ctrl+P)
                    </button>
                    <button
                      onClick={() => setShowReceipt(false)}
                      className="flex-1 bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 font-bold"
                    >
                      Close
                    </button>
                  </div>
                </div>
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-gray-100">
              <DetailModal />
              <ReceiptModal />
              <div className="bg-white shadow-md">
                <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="bg-blue-600 p-2 rounded-lg">
                      <ShoppingCart size={28} />
                    </div>
                    <div>
                      <h1 className="text-xl font-bold">43 INDUSTRIES SUPERMARKET MANAGER</h1>
                      <p className="text-xs text-gray-600">{currentUser?.name} - <span className={`font-semibold ${currentUser?.role === 'Admin' ? 'text-blue-600' : 'text-green-600'}`}>{currentUser?.role}</span></p>
                    </div>
                  </div>
                  <button 
                    onClick={handleLogout}
                    className="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700"
                  >
                    <LogOut size={18} />
                    Logout
                  </button>
                </div>
              </div>

              <div className="bg-white border-b">
                <div className="max-w-7xl mx-auto px-4">
                  <div className="flex gap-1 overflow-x-auto">
                    {filteredMenuItems.map(item => {
                      const Icon = item.icon;
                      if (item.isLink) {
                        return (
                          <a
                            key={item.id}
                            href={item.href}
                            onClick={(e) => {
                              // Handle navigation more reliably
                              const href = item.href.replace('./', '');
                              const currentUrl = window.location.href;
                              const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
                              window.location.href = baseUrl + href;
                              e.preventDefault();
                            }}
                            target="_self"
                            rel="noopener noreferrer"
                            className="flex items-center gap-2 px-4 py-3 border-b-2 border-transparent bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold rounded-t-lg hover:from-yellow-300 hover:to-orange-400 cursor-pointer"
                            style={{ textDecoration: 'none' }}
                          >
                            <Icon size={18} />
                            {item.label}
                          </a>
                        );
                      }
                      return (
                        <button
                          key={item.id}
                          onClick={() => setCurrentView(item.id)}
                          className={`flex items-center gap-2 px-4 py-3 border-b-2 transition ${
                            currentView === item.id ? 'border-blue-600 text-blue-600 bg-blue-50' : 'border-transparent'
                          }`}
                        >
                          <Icon size={18} />
                          {item.label}
                        </button>
                      );
                    })}
                  </div>
                </div>
              </div>

              <div className="max-w-7xl mx-auto px-4 py-6">
                {currentView === 'dashboard' && (
                  <div className="space-y-6">
                    <h2 className="text-2xl font-bold">Dashboard Overview</h2>
                    <p className="text-sm text-gray-600 mb-4">ðŸ’¡ Click on any card to see detailed breakdown</p>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div 
                        onClick={() => showDetails('revenue')}
                        className="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-500 cursor-pointer hover:shadow-lg hover:scale-105 transition-all"
                      >
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-gray-600">Today Revenue</p>
                            <p className="text-2xl font-bold">KES {todayRevenue.toFixed(2)}</p>
                            <p className="text-xs text-gray-500 mt-1">{todaySales.length} transactions</p>
                          </div>
                          <DollarSign className="text-blue-500" size={32} />
                        </div>
                        <p className="text-xs text-blue-600 mt-3 font-semibold">â†’ Click for details</p>
                      </div>
                      <div 
                        onClick={() => showDetails('profit')}
                        className="bg-green-50 p-6 rounded-lg border-l-4 border-green-500 cursor-pointer hover:shadow-lg hover:scale-105 transition-all"
                      >
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-gray-600">Today Profit</p>
                            <p className="text-2xl font-bold">KES {todayProfit.toFixed(2)}</p>
                            <p className="text-xs text-gray-500 mt-1">{todayRevenue > 0 ? ((todayProfit/todayRevenue)*100).toFixed(1) : 0}% margin</p>
                          </div>
                          <TrendingUp className="text-green-500" size={32} />
                        </div>
                        <p className="text-xs text-green-600 mt-3 font-semibold">â†’ Click for breakdown</p>
                      </div>
                      <div 
                        onClick={() => showDetails('inventory')}
                        className="bg-purple-50 p-6 rounded-lg border-l-4 border-purple-500 cursor-pointer hover:shadow-lg hover:scale-105 transition-all"
                      >
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-gray-600">Inventory Value</p>
                            <p className="text-2xl font-bold">KES {totalInventoryValue.toFixed(0)}</p>
                            <p className="text-xs text-gray-500 mt-1">{products.length} products</p>
                          </div>
                          <Package className="text-purple-500" size={32} />
                        </div>
                        <p className="text-xs text-purple-600 mt-3 font-semibold">â†’ Click for breakdown</p>
                      </div>
                      <div 
                        onClick={() => showDetails('lowstock')}
                        className="bg-orange-50 p-6 rounded-lg border-l-4 border-orange-500 cursor-pointer hover:shadow-lg hover:scale-105 transition-all"
                      >
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-gray-600">Low Stock</p>
                            <p className="text-2xl font-bold">{lowStockItems.length}</p>
                            <p className="text-xs text-gray-500 mt-1">Need reorder</p>
                          </div>
                          <AlertCircle className="text-orange-500" size={32} />
                        </div>
                        <p className="text-xs text-orange-600 mt-3 font-semibold">â†’ Click to view items</p>
                      </div>
                    </div>
                    {lowStockItems.length > 0 && (
                      <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                        <h3 className="font-semibold text-red-800 mb-2">âš ï¸ Low Stock Alert</h3>
                        <ul className="text-sm text-red-700 space-y-1">
                          {lowStockItems.map(item => (
                            <li key={item.id}>{item.name} - Only {item.stock} units left</li>
                          ))}
                        </ul>
                      </div>
                    )}
                    
                    {/* Expiry Alerts */}
                    {expiredItems.length > 0 && (
                      <div className="bg-red-100 border-l-4 border-red-700 p-4 rounded">
                        <h3 className="font-semibold text-red-900 mb-2">ðŸš« EXPIRED Products</h3>
                        <ul className="text-sm text-red-800 space-y-1">
                          {expiredItems.map(item => (
                            <li key={item.id}>{item.name} - Expired {item.expiryDate}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                    
                    {expiringItems.length > 0 && (
                      <div className="bg-orange-50 border-l-4 border-orange-500 p-4 rounded">
                        <h3 className="font-semibold text-orange-800 mb-2">â° Expiring Soon (7 days)</h3>
                        <ul className="text-sm text-orange-700 space-y-1">
                          {expiringItems.map(item => (
                            <li key={item.id}>{item.name} - Expires {item.expiryDate}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>
                )}

                {currentView === 'pos' && (
                  <div className="fixed inset-0 bg-gradient-to-br from-black via-purple-950 to-black z-40" style={{marginTop: '-24px', marginLeft: '-16px', marginRight: '-16px'}}>
                    {/* Animated Background Pattern */}
                    <div className="absolute inset-0 opacity-40">
                      <div className="absolute inset-0" style={{backgroundImage: 'radial-gradient(circle at 20% 20%, rgba(168, 85, 247, 0.15) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%)'}}></div>
                    </div>

                    {/* CUSTOMER SELECT MODAL */}
                    {showCustomerSelect && (
                      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <div className="bg-slate-800 rounded-3xl shadow-2xl max-w-lg w-full border border-white/10 overflow-hidden max-h-[80vh] flex flex-col">
                          <div className="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">
                            <div className="flex justify-between items-center">
                              <div>
                                <h3 className="text-2xl font-black text-white">ðŸ‘¤ Select Customer</h3>
                                <p className="text-purple-100 text-sm">For loyalty points</p>
                              </div>
                              <button onClick={() => setShowCustomerSelect(false)} className="text-white/70 hover:text-white p-2">
                                <X size={24} />
                              </button>
                            </div>
                          </div>
                          
                          <div className="p-4 border-b border-white/10">
                            <input
                              type="text"
                              placeholder="ðŸ” Search by name or phone..."
                              value={customerSearch}
                              onChange={(e) => setCustomerSearch(e.target.value)}
                              className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:border-purple-500"
                              autoFocus
                            />
                          </div>
                          
                          <div className="flex-1 overflow-y-auto p-4">
                            {/* Quick Add Customer Button */}
                            <button
                              onClick={() => setShowAddCustomer(true)}
                              className="w-full mb-4 py-3 bg-gradient-to-r from-purple-500/20 to-pink-500/20 border-2 border-dashed border-purple-500/50 rounded-xl text-purple-400 font-bold hover:bg-purple-500/30 transition-all flex items-center justify-center gap-2"
                            >
                              <Plus size={20} /> Add New Customer
                            </button>
                            
                            {/* Customer List */}
                            <div className="space-y-2">
                              {customers
                                .filter(c => 
                                  c.name.toLowerCase().includes(customerSearch.toLowerCase()) ||
                                  c.phone.includes(customerSearch)
                                )
                                .map(customer => (
                                  <button
                                    key={customer.id}
                                    onClick={() => {
                                      setSelectedCustomer(customer);
                                      setShowCustomerSelect(false);
                                      setCustomerSearch('');
                                    }}
                                    className="w-full bg-slate-700/50 rounded-xl p-4 border border-white/10 hover:border-purple-500/50 transition-all text-left"
                                  >
                                    <div className="flex justify-between items-center">
                                      <div>
                                        <h4 className="font-bold text-white text-lg">{customer.name}</h4>
                                        <p className="text-slate-400 text-sm">{customer.phone}</p>
                                      </div>
                                      <div className="text-right">
                                        <p className="text-2xl font-bold text-purple-400">{customer.points}</p>
                                        <p className="text-slate-500 text-xs">points</p>
                                      </div>
                                    </div>
                                  </button>
                                ))}
                              {customers.filter(c => 
                                c.name.toLowerCase().includes(customerSearch.toLowerCase()) ||
                                c.phone.includes(customerSearch)
                              ).length === 0 && (
                                <p className="text-center text-slate-500 py-4">No customers found</p>
                              )}
                            </div>
                          </div>
                          
                          {/* Skip button */}
                          <div className="p-4 border-t border-white/10">
                            <button
                              onClick={() => { setShowCustomerSelect(false); setSelectedCustomer(null); }}
                              className="w-full py-3 glass text-slate-400 rounded-xl font-medium hover:bg-white/10 transition-all"
                            >
                              Continue without customer
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* ADD NEW CUSTOMER MODAL */}
                    {showAddCustomer && (
                      <div className="absolute inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                        <div className="bg-slate-800 rounded-3xl shadow-2xl max-w-md w-full border border-white/10 overflow-hidden">
                          <div className="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">
                            <div className="flex justify-between items-center">
                              <div>
                                <h3 className="text-xl font-black text-white">ðŸŽ Register for Loyalty</h3>
                                <p className="text-purple-100 text-sm">Earn points on every purchase!</p>
                              </div>
                              <button onClick={() => setShowAddCustomer(false)} className="text-white/70 hover:text-white">
                                <X size={24} />
                              </button>
                            </div>
                          </div>
                          
                          <div className="p-6 space-y-4">
                            <div>
                              <label className="block text-sm text-white font-bold mb-2">Customer Name</label>
                              <input
                                type="text"
                                value={newCustomer.name}
                                onChange={(e) => setNewCustomer({...newCustomer, name: e.target.value})}
                                className="w-full px-4 py-4 bg-slate-700 border-2 border-slate-600 rounded-xl text-white text-lg focus:border-purple-500"
                                placeholder="Enter customer name"
                                autoFocus
                              />
                            </div>
                            <div>
                              <label className="block text-sm text-white font-bold mb-2">Mobile Number</label>
                              <input
                                type="tel"
                                value={newCustomer.phone}
                                onChange={(e) => setNewCustomer({...newCustomer, phone: e.target.value})}
                                className="w-full px-4 py-4 bg-slate-700 border-2 border-slate-600 rounded-xl text-white text-lg font-mono focus:border-purple-500"
                                placeholder="0712345678"
                              />
                            </div>
                            
                            <div className="bg-purple-500/20 border border-purple-500/30 p-4 rounded-xl text-center">
                              <p className="text-purple-300 text-lg font-bold">ðŸŽ Earn 1 Point per KES 100</p>
                              <p className="text-purple-400/70 text-sm mt-1">Points can be redeemed for discounts</p>
                            </div>
                            
                            <button
                              onClick={addNewCustomer}
                              className="w-full py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-bold text-lg hover:from-purple-400 hover:to-pink-400 transition-all"
                            >
                              âœ“ Register Customer
                            </button>
                            <button
                              onClick={() => setShowAddCustomer(false)}
                              className="w-full py-3 bg-slate-700 text-slate-400 rounded-xl hover:bg-slate-600 transition-all"
                            >
                              Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* HELD ORDERS MODAL */}
                    {showHeldOrders && (
                      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <div className="bg-slate-800 rounded-3xl shadow-2xl max-w-lg w-full border border-white/10 overflow-hidden max-h-[80vh] flex flex-col">
                          <div className="bg-gradient-to-r from-amber-500 to-orange-500 px-6 py-4">
                            <div className="flex justify-between items-center">
                              <div>
                                <h3 className="text-2xl font-black text-white">â¸ï¸ Held Orders</h3>
                                <p className="text-amber-100 text-sm">{heldOrders.length} order(s) on hold</p>
                              </div>
                              <button onClick={() => setShowHeldOrders(false)} className="text-white/70 hover:text-white p-2">
                                <X size={24} />
                              </button>
                            </div>
                          </div>
                          
                          <div className="flex-1 overflow-y-auto p-4">
                            {heldOrders.length === 0 ? (
                              <div className="text-center py-12">
                                <p className="text-slate-500 text-lg">No held orders</p>
                                <p className="text-slate-600 text-sm">Orders you put on hold will appear here</p>
                              </div>
                            ) : (
                              <div className="space-y-3">
                                {heldOrders.map(order => (
                                  <div key={order.id} className="bg-slate-700/50 rounded-xl p-4 border border-white/10">
                                    <div className="flex justify-between items-start mb-2">
                                      <div>
                                        <h4 className="font-bold text-white text-lg">{order.name}</h4>
                                        <p className="text-slate-400 text-sm">{order.date} at {order.time}</p>
                                      </div>
                                      <p className="text-xl font-bold text-amber-400">KES {order.total.toLocaleString()}</p>
                                    </div>
                                    <p className="text-slate-400 text-sm mb-3">{order.items.length} products, {order.items.reduce((sum, i) => sum + i.quantity, 0)} items</p>
                                    <div className="flex gap-2">
                                      <button onClick={() => retrieveOrder(order.id)}
                                        className="flex-1 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg font-bold hover:from-amber-400 hover:to-orange-400">
                                        Retrieve Order
                                      </button>
                                      <button onClick={() => deleteHeldOrder(order.id)}
                                        className="px-4 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30">
                                        <Trash size={18} />
                                      </button>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    )}

                    {/* VOID SALE MODAL */}
                    {showVoidSale && (
                      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <div className="bg-slate-800 rounded-3xl shadow-2xl max-w-2xl w-full border border-white/10 overflow-hidden max-h-[80vh] flex flex-col">
                          <div className="bg-gradient-to-r from-red-600 to-red-700 px-6 py-4">
                            <div className="flex justify-between items-center">
                              <div>
                                <h3 className="text-2xl font-black text-white">ðŸš« Void/Refund Sale</h3>
                                <p className="text-red-100 text-sm">Select a sale to void and restore stock</p>
                              </div>
                              <button onClick={() => setShowVoidSale(false)} className="text-white/70 hover:text-white p-2">
                                <X size={24} />
                              </button>
                            </div>
                          </div>
                          
                          <div className="flex-1 overflow-y-auto p-4">
                            <div className="space-y-2">
                              {sales.filter(s => !s.voided && s.itemDetails).slice(0, 20).map(sale => (
                                <div key={sale.id} className={`bg-slate-700/50 rounded-xl p-4 border border-white/10 hover:border-red-500/50 transition-all`}>
                                  <div className="flex justify-between items-center">
                                    <div>
                                      <div className="flex items-center gap-3">
                                        <span className="bg-slate-600 px-3 py-1 rounded-lg font-mono text-white">#{sale.id}</span>
                                        <span className="text-slate-400">{sale.date} {sale.time}</span>
                                      </div>
                                      <p className="text-slate-400 text-sm mt-1">
                                        {sale.items} items â€¢ {sale.paymentMethod} â€¢ {sale.cashier || 'Unknown'}
                                      </p>
                                      <p className="text-slate-500 text-xs mt-1">
                                        {sale.itemDetails?.map(i => i.name).join(', ')}
                                      </p>
                                    </div>
                                    <div className="text-right">
                                      <p className="text-2xl font-bold text-white">KES {sale.total.toLocaleString()}</p>
                                      <button onClick={() => voidSale(sale.id)}
                                        className="mt-2 px-4 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 text-sm">
                                        Void Sale
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              ))}
                              {sales.filter(s => !s.voided).length === 0 && (
                                <p className="text-center text-slate-500 py-8">No sales to void</p>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* QUICK ADD PRODUCT MODAL */}
                    {showQuickAdd && (
                      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <div className="bg-slate-800 rounded-3xl shadow-2xl max-w-lg w-full border border-white/10 overflow-hidden">
                          <div className="bg-gradient-to-r from-emerald-600 to-cyan-600 px-6 py-4">
                            <div className="flex justify-between items-center">
                              <div>
                                <h3 className="text-2xl font-black text-white">âš¡ Quick Add Product</h3>
                                <p className="text-emerald-100 text-sm">Add new product to inventory</p>
                              </div>
                              <button onClick={() => setShowQuickAdd(false)} className="text-white/70 hover:text-white p-2">
                                <X size={24} />
                              </button>
                            </div>
                          </div>
                          
                          <div className="p-6 space-y-4">
                            {/* Barcode */}
                            <div>
                              <label className="block text-xs text-cyan-400 font-bold uppercase mb-1">Barcode (Optional)</label>
                              {quickAddBarcode ? (
                                <div className="bg-slate-700/50 p-4 rounded-xl border border-cyan-500/30">
                                  <p className="text-2xl font-mono font-bold text-white">{quickAddBarcode}</p>
                                </div>
                              ) : (
                                <input 
                                  type="text" 
                                  value={newProduct.barcode} 
                                  onChange={(e) => setNewProduct({...newProduct, barcode: e.target.value})}
                                  className="w-full px-4 py-3 bg-slate-700 border-2 border-cyan-500/50 rounded-xl text-white text-lg font-mono focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20"
                                  placeholder="Scan or type barcode (leave empty if no barcode)"
                                  autoFocus
                                />
                              )}
                            </div>
                            
                            {/* Product Name */}
                            <div>
                              <label className="block text-xs text-slate-400 font-bold uppercase mb-1">Product Name *</label>
                              <input 
                                type="text" 
                                value={newProduct.name} 
                                onChange={(e) => setNewProduct({...newProduct, name: e.target.value})}
                                className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white text-lg focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20"
                                placeholder="e.g., Coca Cola 500ml"
                                autoFocus
                              />
                            </div>
                            
                            {/* Category - Dropdown */}
                            <div>
                              <label className="block text-xs text-slate-400 font-bold uppercase mb-1">Category</label>
                              <div className="relative">
                                <select 
                                  value={newProduct.category} 
                                  onChange={(e) => setNewProduct({...newProduct, category: e.target.value})}
                                  className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:border-cyan-500 appearance-none cursor-pointer text-lg"
                                >
                                  <option value="">-- Select Category --</option>
                                  <option disabled className="text-slate-500">â”€â”€ Your Categories â”€â”€</option>
                                  {[...new Set(products.map(p => p.category))].sort().map(cat => (
                                    <option key={cat} value={cat}>{cat}</option>
                                  ))}
                                  <option disabled className="text-slate-500">â”€â”€ Common Categories â”€â”€</option>
                                  <option value="Beverages">ðŸ¥¤ Beverages</option>
                                  <option value="Dairy">ðŸ¥› Dairy</option>
                                  <option value="Bakery">ðŸž Bakery</option>
                                  <option value="Snacks">ðŸ¿ Snacks</option>
                                  <option value="Grains">ðŸŒ¾ Grains</option>
                                  <option value="Oils">ðŸ«’ Oils</option>
                                  <option value="Canned Goods">ðŸ¥« Canned Goods</option>
                                  <option value="Household">ðŸ  Household</option>
                                  <option value="Personal Care">ðŸ§´ Personal Care</option>
                                  <option value="Frozen">â„ï¸ Frozen</option>
                                  <option value="Meat">ðŸ¥© Meat</option>
                                  <option value="Vegetables">ðŸ¥¬ Vegetables</option>
                                  <option value="Fruits">ðŸŽ Fruits</option>
                                  <option value="Other">ðŸ“¦ Other</option>
                                  <option disabled className="text-slate-500">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                                  <option value="__new__">âž• Add New Category...</option>
                                </select>
                                <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <path d="M6 9l6 6 6-6"/>
                                  </svg>
                                </div>
                              </div>
                              {newProduct.category === '__new__' && (
                                <input 
                                  type="text" 
                                  onChange={(e) => setNewProduct({...newProduct, category: e.target.value})}
                                  className="w-full mt-2 px-4 py-3 bg-slate-700 border-2 border-cyan-500 rounded-xl text-white focus:ring-2 focus:ring-cyan-500/20"
                                  placeholder="Type new category name..."
                                  autoFocus
                                />
                              )}
                            </div>
                            
                            
                            {/* Prices Row - Add Market Price */}
                            <div className="grid grid-cols-3 gap-4">
                              <div>
                                <label className="block text-xs text-slate-400 font-bold uppercase mb-1">Cost Price (KES)</label>
                                <input 
                                  type="number" 
                                  step="0.01"
                                  value={newProduct.costPrice} 
                                  onChange={(e) => setNewProduct({...newProduct, costPrice: e.target.value})}
                                  className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white text-lg focus:border-cyan-500"
                                  placeholder="0"
                                />
                              </div>
                              <div>
                                <label className="block text-xs text-emerald-400 font-bold uppercase mb-1">Selling Price (KES) *</label>
                                <input 
                                  type="number" 
                                  step="0.01"
                                  value={newProduct.sellingPrice} 
                                  onChange={(e) => setNewProduct({...newProduct, sellingPrice: e.target.value})}
                                  className="w-full px-4 py-3 bg-slate-700 border-2 border-emerald-500/50 rounded-xl text-white text-lg font-bold focus:border-emerald-500"
                                  placeholder="0"
                                />
                              </div>
                              <div>
                                <label className="block text-xs text-blue-400 font-bold uppercase mb-1">Market Price (KES)</label>
                                <input 
                                  type="number" 
                                  step="0.01"
                                  value={newProduct.marketPrice || ''} 
                                  onChange={(e) => setNewProduct({...newProduct, marketPrice: e.target.value})}
                                  className="w-full px-4 py-3 bg-slate-700 border border-blue-500/50 rounded-xl text-white text-lg focus:border-blue-500"
                                  placeholder="0"
                                />
                              </div>
                            </div>
                            
                            {/* Unit Field */}
                            <div>
                              <label className="block text-xs text-slate-400 font-bold uppercase mb-1">Unit of Measurement *</label>
                              <select 
                                value={newProduct.unit || 'pieces'} 
                                onChange={(e) => setNewProduct({...newProduct, unit: e.target.value})}
                                className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white text-lg focus:border-cyan-500 appearance-none cursor-pointer"
                              >
                                <option value="pieces">Pieces</option>
                                <option value="litres">Litres</option>
                                <option value="kg">Kilograms (kg)</option>
                                <option value="grams">Grams (g)</option>
                                <option value="ml">Milliliters (ml)</option>
                                <option value="boxes">Boxes</option>
                                <option value="packs">Packs</option>
                                <option value="bags">Bags</option>
                              </select>
                              <p className="text-xs text-cyan-400 mt-1">
                                {newProduct.unit === 'litres' || newProduct.unit === 'ml' || newProduct.unit === 'kg' || newProduct.unit === 'grams' 
                                  ? 'ðŸ’¡ Use decimal values (e.g., 1.5 litres, 0.5 kg)' 
                                  : 'Select how this product is measured'}
                              </p>
                            </div>
                            
                            {/* Stock Row */}
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <label className="block text-xs text-slate-400 font-bold uppercase mb-1">Initial Stock ({newProduct.unit || 'units'}) *</label>
                                <input 
                                  type="number" 
                                  step={newProduct.unit === 'litres' || newProduct.unit === 'ml' || newProduct.unit === 'kg' || newProduct.unit === 'grams' ? "0.01" : "1"}
                                  value={newProduct.stock} 
                                  onChange={(e) => setNewProduct({...newProduct, stock: e.target.value})}
                                  className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white text-lg focus:border-cyan-500"
                                  placeholder="0"
                                />
                              </div>
                              <div>
                                <label className="block text-xs text-slate-400 font-bold uppercase mb-1">Reorder Level ({newProduct.unit || 'units'})</label>
                                <input 
                                  type="number" 
                                  step={newProduct.unit === 'litres' || newProduct.unit === 'ml' || newProduct.unit === 'kg' || newProduct.unit === 'grams' ? "0.01" : "1"}
                                  value={newProduct.reorderLevel} 
                                  onChange={(e) => setNewProduct({...newProduct, reorderLevel: e.target.value})}
                                  className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white focus:border-cyan-500"
                                  placeholder="10"
                                />
                              </div>
                            </div>
                            
                            {/* Profit Preview */}
                            {newProduct.costPrice && newProduct.sellingPrice && (
                              <div className="bg-emerald-500/10 border border-emerald-500/30 p-3 rounded-xl flex justify-between items-center">
                                <span className="text-emerald-400 text-sm">Profit per item:</span>
                                <span className="text-emerald-400 font-bold text-lg">
                                  KES {(parseFloat(newProduct.sellingPrice) - parseFloat(newProduct.costPrice)).toFixed(2)}
                                </span>
                              </div>
                            )}
                            
                            {/* Action Buttons */}
                            <div className="flex gap-3 pt-2">
                              <button 
                                onClick={() => {
                                  if (!newProduct.name || !newProduct.sellingPrice || !newProduct.stock) {
                                    alert('Please fill in: Product Name, Selling Price, and Stock');
                                    return;
                                  }
                                  // Generate unique identifier if no barcode provided
                                  const productBarcode = quickAddBarcode || newProduct.barcode || `NO-BARCODE-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                                  const unit = newProduct.unit || 'pieces';
                                  const product = {
                                    id: Math.max(...products.map(p => p.id), 0) + 1,
                                    name: newProduct.name,
                                    barcode: productBarcode,
                                    category: newProduct.category || 'General',
                                    costPrice: parseFloat(newProduct.costPrice) || 0,
                                    sellingPrice: parseFloat(newProduct.sellingPrice),
                                    marketPrice: newProduct.marketPrice ? parseFloat(newProduct.marketPrice) : null,
                                    stock: (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams') 
                                      ? parseFloat(newProduct.stock) || 0 
                                      : parseInt(newProduct.stock) || 0,
                                    unit: unit,
                                    reorderLevel: (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams')
                                      ? parseFloat(newProduct.reorderLevel) || 10
                                      : parseInt(newProduct.reorderLevel) || 10
                                  };
                                  setProducts([...products, product]);
                                  setShowQuickAdd(false);
                                  setQuickAddBarcode('');
                                  setNewProduct({ name: '', barcode: '', category: '', costPrice: '', sellingPrice: '', marketPrice: '', stock: '', unit: 'pieces', reorderLevel: 10 });
                                  alert('âœ… Product added!\n\n' + product.name + '\nStock: ' + product.stock + '\nPrice: KES ' + product.sellingPrice);
                                }}
                                className="flex-1 py-4 bg-gradient-to-r from-emerald-500 to-cyan-500 text-white rounded-xl font-bold text-lg hover:from-emerald-400 hover:to-cyan-400 transition-all shadow-lg"
                              >
                                âœ“ Add Product
                              </button>
                              <button 
                                onClick={() => { setShowQuickAdd(false); setQuickAddBarcode(''); }}
                                className="px-6 py-4 bg-slate-700 text-slate-300 rounded-xl font-bold hover:bg-slate-600 transition-all"
                              >
                                Cancel
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* QUICK BUTTONS EDIT MODAL */}
                    {editingQuickButtons && (
                      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <div className="bg-slate-800 rounded-3xl shadow-2xl max-w-lg w-full border border-white/10 overflow-hidden max-h-[80vh] flex flex-col">
                          <div className="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">
                            <div className="flex justify-between items-center">
                              <div>
                                <h3 className="text-2xl font-black text-white">âš¡ Quick Sale Buttons</h3>
                                <p className="text-purple-100 text-sm">Add shortcuts for frequently sold items</p>
                              </div>
                              <button onClick={() => setEditingQuickButtons(false)} className="text-white/70 hover:text-white p-2">
                                <X size={24} />
                              </button>
                            </div>
                          </div>
                          
                          <div className="p-4 border-b border-white/10">
                            <p className="text-sm text-slate-400 mb-3">Select products to add as quick buttons:</p>
                            <div className="flex flex-wrap gap-2 max-h-60 overflow-y-auto">
                              {products.map(product => {
                                const isSelected = quickButtons.some(b => b.productId === product.id);
                                return (
                                  <button
                                    key={product.id}
                                    onClick={() => {
                                      if (isSelected) {
                                        setQuickButtons(quickButtons.filter(b => b.productId !== product.id));
                                      } else if (quickButtons.length < 10) {
                                        setQuickButtons([...quickButtons, { productId: product.id }]);
                                      } else {
                                        alert('Maximum 10 quick buttons allowed');
                                      }
                                    }}
                                    className={`px-3 py-2 rounded-lg text-sm font-bold transition-all ${isSelected ? 'bg-purple-500 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                                  >
                                    {isSelected && 'âœ“ '}{product.name}
                                  </button>
                                );
                              })}
                            </div>
                          </div>
                          
                          <div className="p-4">
                            <p className="text-xs text-slate-500 mb-3">Selected: {quickButtons.length}/10</p>
                            <button onClick={() => setEditingQuickButtons(false)}
                              className="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-bold hover:from-purple-400 hover:to-pink-400">
                              Done
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* OPEN REGISTER MODAL */}
                    {showOpenRegister && (
                      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <div className="bg-slate-800 rounded-3xl shadow-2xl max-w-md w-full border border-white/10 overflow-hidden">
                          <div className="bg-gradient-to-r from-green-600 to-emerald-600 px-6 py-4">
                            <h3 className="text-2xl font-black text-white">ðŸ”“ Open Cash Register</h3>
                            <p className="text-green-100 text-sm">Start your shift with opening float</p>
                          </div>
                          <div className="p-6 space-y-4">
                            <div>
                              <label className="block text-sm text-slate-400 font-bold mb-2">Opening Float (Cash in Drawer)</label>
                              <input
                                type="number"
                                value={cashRegister.openingFloat || ''}
                                onChange={(e) => setCashRegister({...cashRegister, openingFloat: parseFloat(e.target.value) || 0})}
                                className="w-full px-4 py-4 bg-slate-700 border-2 border-green-500/50 rounded-xl text-3xl font-bold text-center text-white"
                                placeholder="0"
                                autoFocus
                              />
                            </div>
                            <button
                              onClick={() => {
                                setCashRegister({
                                  isOpen: true,
                                  openingFloat: cashRegister.openingFloat || 0,
                                  openingTime: new Date().toISOString(),
                                  cashierName: currentUser?.name || 'Unknown'
                                });
                                setShowOpenRegister(false);
                                alert('âœ… Register opened!\n\nOpening float: KES ' + (cashRegister.openingFloat || 0).toLocaleString());
                              }}
                              className="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-bold text-lg"
                            >
                              Open Register
                            </button>
                            <button onClick={() => setShowOpenRegister(false)} className="w-full py-3 bg-slate-700 text-slate-400 rounded-xl">
                              Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* CLOSE REGISTER MODAL */}
                    {showCloseRegister && (
                      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <div className="bg-slate-800 rounded-3xl shadow-2xl max-w-md w-full border border-white/10 overflow-hidden">
                          <div className="bg-gradient-to-r from-yellow-600 to-orange-600 px-6 py-4">
                            <h3 className="text-2xl font-black text-white">ðŸ”’ Close Cash Register</h3>
                            <p className="text-yellow-100 text-sm">Count your cash and close the shift</p>
                          </div>
                          <div className="p-6 space-y-4">
                            {(() => {
                              const cashSales = todaySales.filter(s => s.paymentMethod === 'Cash').reduce((sum, s) => sum + s.total, 0);
                              const splitCash = todaySales.filter(s => s.paymentMethod === 'Split').reduce((sum, s) => sum + (s.splitCash || 0), 0);
                              const expectedCash = (cashRegister.openingFloat || 0) + cashSales + splitCash;
                              const difference = (parseFloat(closingCash) || 0) - expectedCash;
                              
                              return (
                                <>
                                  <div className="bg-slate-700/50 p-4 rounded-xl space-y-2">
                                    <div className="flex justify-between text-sm">
                                      <span className="text-slate-400">Opening Float:</span>
                                      <span className="text-white font-bold">KES {(cashRegister.openingFloat || 0).toLocaleString()}</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                      <span className="text-slate-400">Cash Sales Today:</span>
                                      <span className="text-green-400 font-bold">+ KES {(cashSales + splitCash).toLocaleString()}</span>
                                    </div>
                                    <div className="border-t border-slate-600 pt-2 flex justify-between">
                                      <span className="text-white font-bold">Expected Cash:</span>
                                      <span className="text-yellow-400 font-bold text-lg">KES {expectedCash.toLocaleString()}</span>
                                    </div>
                                  </div>
                                  
                                  <div>
                                    <label className="block text-sm text-slate-400 font-bold mb-2">Actual Cash in Drawer</label>
                                    <input
                                      type="number"
                                      value={closingCash}
                                      onChange={(e) => setClosingCash(e.target.value)}
                                      className="w-full px-4 py-4 bg-slate-700 border-2 border-yellow-500/50 rounded-xl text-3xl font-bold text-center text-white"
                                      placeholder="Count and enter"
                                      autoFocus
                                    />
                                  </div>
                                  
                                  {closingCash && (
                                    <div className={`p-4 rounded-xl text-center ${difference >= 0 ? 'bg-green-500/20 border border-green-500/30' : 'bg-red-500/20 border border-red-500/30'}`}>
                                      <p className={`text-sm ${difference >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        {difference >= 0 ? 'âœ“ Over by' : 'âš  Short by'}
                                      </p>
                                      <p className={`text-3xl font-black ${difference >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        KES {Math.abs(difference).toLocaleString()}
                                      </p>
                                    </div>
                                  )}
                                  
                                  <button
                                    onClick={() => {
                                      const summary = `REGISTER CLOSED\n\nCashier: ${cashRegister.cashierName}\nOpening Float: KES ${(cashRegister.openingFloat || 0).toLocaleString()}\nCash Sales: KES ${(cashSales + splitCash).toLocaleString()}\nExpected: KES ${expectedCash.toLocaleString()}\nActual: KES ${parseFloat(closingCash || 0).toLocaleString()}\nDifference: KES ${difference.toLocaleString()}`;
                                      setCashRegister({ isOpen: false, openingFloat: 0, openingTime: null, cashierName: '' });
                                      setClosingCash('');
                                      setShowCloseRegister(false);
                                      alert(summary);
                                    }}
                                    className="w-full py-4 bg-gradient-to-r from-yellow-500 to-orange-500 text-black rounded-xl font-bold text-lg"
                                  >
                                    Close Register
                                  </button>
                                </>
                              );
                            })()}
                            <button onClick={() => setShowCloseRegister(false)} className="w-full py-3 bg-slate-700 text-slate-400 rounded-xl">
                              Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    <div className="relative h-full flex flex-col p-4">
                      {/* TOP BAR */}
                      <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-4">
                          <div className="relative">
                            <div className="absolute inset-0 bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl blur-lg opacity-50"></div>
                            <div className="relative bg-gradient-to-br from-purple-500 to-pink-500 p-4 rounded-2xl shadow-2xl">
                              <ShoppingCart className="text-white" size={32} />
                            </div>
                          </div>
                          <div>
                            <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-purple-400 animate-gradient tracking-tight">{storeConfig.storeName.toUpperCase()}</h1>
                            <p className="text-slate-400 text-sm font-medium flex items-center gap-2">
                              <span className="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></span>
                              Point of Sale Terminal â€¢ {new Date().toLocaleTimeString()}
                            </p>
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <button 
                            onClick={() => {
                              setQuickAddBarcode('');
                              setNewProduct({ name: '', barcode: '', category: '', costPrice: '', sellingPrice: '', stock: '', reorderLevel: 10 });
                              setShowQuickAdd(true);
                            }} 
                            className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:from-purple-400 hover:to-pink-400 transition-all shadow-lg shadow-purple-500/30"
                          >
                            <Plus size={16} /> Add Product
                          </button>
                          <button 
                            onClick={() => setShowHeldOrders(true)} 
                            className="glass text-amber-400 px-3 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-amber-500/20 transition-all border border-amber-500/30"
                          >
                            â¸ï¸ Held {heldOrders.length > 0 && <span className="bg-amber-500 text-white px-2 rounded-full text-xs">{heldOrders.length}</span>}
                          </button>
                          <button 
                            onClick={() => setShowVoidSale(true)} 
                            className="glass text-red-400 px-3 py-2 rounded-xl text-sm flex items-center gap-1 hover:bg-red-500/20 transition-all"
                          >
                            ðŸš« Void
                          </button>
                          {lowStockItems.length > 0 && (
                            <button onClick={() => setCurrentView('lowstock')} className="glass text-orange-400 px-3 py-2 rounded-xl text-sm flex items-center gap-1 hover:bg-orange-500/20 transition-all">
                              <AlertCircle size={16} /> {lowStockItems.length}
                            </button>
                          )}
                          {!cashRegister.isOpen ? (
                            <button onClick={() => setShowOpenRegister(true)} className="bg-green-500 text-white px-3 py-2 rounded-xl text-sm font-bold flex items-center gap-1 hover:bg-green-600 transition-all">
                              ðŸ”“ Open Register
                            </button>
                          ) : (
                            <button onClick={() => setShowCloseRegister(true)} className="bg-yellow-500 text-black px-3 py-2 rounded-xl text-sm font-bold flex items-center gap-1 hover:bg-yellow-400 transition-all">
                              ðŸ”’ Close Register
                            </button>
                          )}
                          <button onClick={() => setCurrentView('dashboard')} className="glass text-white px-3 py-2 rounded-xl text-sm hover:bg-white/10 transition-all">
                            â† Back
                          </button>
                        </div>
                      </div>

                      {/* MAIN CONTENT */}
                      <div className="flex-1 grid grid-cols-1 lg:grid-cols-5 gap-4 min-h-0">
                        
                        {/* LEFT - SCANNER & ITEMS (3 cols) */}
                        <div className="lg:col-span-3 flex flex-col gap-4 min-h-0">
                          
                          {/* ULTRA SCANNER */}
                          <div className="relative">
                            <div className="absolute -inset-1 bg-gradient-to-r from-purple-500 via-pink-500 to-purple-500 rounded-3xl blur-lg opacity-40 animate-pulse"></div>
                            <div className="relative glass rounded-3xl p-6 border border-purple-500/30">
                              <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-4">
                                  <div className="relative">
                                    <div className="absolute inset-0 bg-purple-500 rounded-xl blur-md animate-pulse"></div>
                                    <div className="relative bg-gradient-to-br from-purple-500 to-pink-500 p-4 rounded-xl shadow-lg animate-pulse-glow">
                                      <Barcode className="text-white" size={32} />
                                    </div>
                                  </div>
                                  <div>
                                    <h2 className="text-2xl font-black text-white">SCAN ITEM</h2>
                                    <p className="text-purple-400 text-sm flex items-center gap-2">
                                      <span className="w-2 h-2 bg-purple-400 rounded-full animate-ping"></span>
                                      Ready to scan
                                    </p>
                                  </div>
                                </div>
                                <div className="text-right">
                                  <p className="text-slate-500 text-xs">ITEMS IN CART</p>
                                  <p className="text-4xl font-black text-white">{cartItemCount}</p>
                                </div>
                              </div>
                              <div className="flex gap-3">
                                <div className="flex-1 relative">
                                  <input
                                    type="text"
                                    placeholder="Scan barcode, type product code, or search by name..."
                                    value={barcodeInput}
                                    onChange={(e) => setBarcodeInput(e.target.value)}
                                    onKeyPress={(e) => {
                                      if (e.key === 'Enter' && barcodeInput) {
                                        // Try to find by barcode first
                                        let product = products.find(p => p.barcode === barcodeInput);
                                        // If not found, try to find by name (case-insensitive, partial match)
                                        if (!product) {
                                          const searchTerm = barcodeInput.toLowerCase();
                                          const matches = products.filter(p => 
                                            p.name.toLowerCase().includes(searchTerm)
                                          );
                                          if (matches.length === 1) {
                                            product = matches[0];
                                          } else if (matches.length > 1) {
                                            // Multiple matches - show selection
                                            const productNames = matches.map((p, idx) => `${idx + 1}. ${p.name} (Stock: ${p.stock})`).join('\n');
                                            const selection = prompt(`Multiple products found:\n\n${productNames}\n\nEnter number (1-${matches.length}) or product name:`);
                                            if (selection) {
                                              const idx = parseInt(selection) - 1;
                                              if (idx >= 0 && idx < matches.length) {
                                                product = matches[idx];
                                              } else {
                                                const selected = matches.find(p => p.name.toLowerCase() === selection.toLowerCase());
                                                if (selected) product = selected;
                                              }
                                            }
                                          }
                                        }
                                        
                                        if (product && product.stock > 0) {
                                          addToCart(product);
                                          setBarcodeInput('');
                                          e.target.classList.add('animate-pop');
                                          setTimeout(() => e.target.classList.remove('animate-pop'), 300);
                                        } else if (product) {
                                          alert('âŒ OUT OF STOCK!\n\n' + product.name);
                                        } else {
                                          // Unknown product - offer to add new product
                                          if (window.confirm('ðŸ†• NEW PRODUCT DETECTED!\n\nSearch: ' + barcodeInput + '\n\nWould you like to add this as a new product?')) {
                                            setQuickAddBarcode('');
                                            setNewProduct({...newProduct, barcode: '', name: barcodeInput, category: '', costPrice: '', sellingPrice: '', marketPrice: '', stock: '', unit: 'pieces', reorderLevel: 10});
                                            setShowQuickAdd(true);
                                          }
                                          setBarcodeInput('');
                                        }
                                      }
                                    }}
                                    className="w-full px-6 py-5 bg-slate-800/80 border-2 border-slate-600 rounded-2xl text-2xl font-mono text-white placeholder-slate-500 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/30 transition-all duration-300"
                                    autoFocus
                                  />
                                  <div className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500">
                                    <Search size={24} />
                                  </div>
                                  {/* Search Results Dropdown */}
                                  {barcodeInput && barcodeInput.length > 0 && (
                                    <div className="absolute z-50 w-full mt-2 bg-slate-800 border border-purple-500/30 rounded-2xl shadow-2xl max-h-96 overflow-y-auto custom-scrollbar">
                                      {(() => {
                                        const searchTerm = barcodeInput.toLowerCase();
                                        const matches = products.filter(p => 
                                          (p.name.toLowerCase().includes(searchTerm) ||
                                           p.barcode.includes(barcodeInput) ||
                                           (p.category && p.category.toLowerCase().includes(searchTerm))) &&
                                          p.stock > 0
                                        ).slice(0, 10); // Limit to 10 results
                                        
                                        if (matches.length === 0) {
                                          return (
                                            <div className="p-4 text-center text-slate-400">
                                              <p className="text-sm font-bold">ðŸ” No products found</p>
                                              <p className="text-xs mt-1">Try a different search term or barcode</p>
                                            </div>
                                          );
                                        }
                                        
                                        return (
                                          <>
                                            <div className="p-3 bg-purple-500/20 border-b border-purple-500/30 sticky top-0">
                                              <p className="text-xs text-purple-400 font-bold uppercase">
                                                Found {matches.length} {matches.length === 1 ? 'product' : 'products'}
                                              </p>
                                            </div>
                                            {matches.map(product => (
                                          <div
                                            key={product.id}
                                            onClick={() => {
                                              addToCart(product);
                                              setBarcodeInput('');
                                            }}
                                            className="p-4 border-b border-slate-700 hover:bg-purple-500/20 cursor-pointer transition-all flex items-center justify-between group"
                                          >
                                            <div className="flex-1 min-w-0">
                                              <p className="text-white font-bold text-base truncate">{product.name}</p>
                                              <div className="flex items-center gap-3 mt-1 flex-wrap">
                                                {product.category && (
                                                  <span className="text-purple-400 text-xs font-semibold bg-purple-500/20 px-2 py-0.5 rounded">
                                                    {product.category}
                                                  </span>
                                                )}
                                                <span className="text-emerald-400 text-sm font-bold">KES {product.sellingPrice?.toFixed(2)}</span>
                                                <span className="text-slate-500 text-xs">
                                                  Stock: {product.unit === 'litres' || product.unit === 'ml' || product.unit === 'kg' || product.unit === 'grams'
                                                    ? parseFloat(product.stock || 0).toFixed(2)
                                                    : product.stock} {product.unit || 'units'}
                                                </span>
                                                {product.barcode && product.barcode.length > 0 && (
                                                  <span className="text-slate-600 text-xs font-mono">#{product.barcode.substring(0, 8)}</span>
                                                )}
                                              </div>
                                            </div>
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                setBuyByAmountProduct(product);
                                                setShowBuyByAmountModal(true);
                                                setBarcodeInput('');
                                              }}
                                              className="ml-3 px-3 py-2 bg-green-500/20 text-green-400 rounded-lg text-xs font-bold hover:bg-green-500 hover:text-white transition-all opacity-0 group-hover:opacity-100 whitespace-nowrap"
                                            >
                                              ðŸ’° Amount
                                            </button>
                                          </div>
                                        ))}
                                          </>
                                        );
                                      })()}
                                    </div>
                                  )}
                                </div>
                                <button 
                                  onClick={() => {
                                    if (barcodeInput) {
                                      // Try to find by barcode first
                                      let product = products.find(p => p.barcode === barcodeInput);
                                      // If not found, try to find by name (case-insensitive, partial match)
                                      if (!product) {
                                        const searchTerm = barcodeInput.toLowerCase();
                                        const matches = products.filter(p => 
                                          p.name.toLowerCase().includes(searchTerm)
                                        );
                                        if (matches.length === 1) {
                                          product = matches[0];
                                        } else if (matches.length > 1) {
                                          // Multiple matches - show selection
                                          const productNames = matches.map((p, idx) => `${idx + 1}. ${p.name} (Stock: ${p.stock})`).join('\n');
                                          const selection = prompt(`Multiple products found:\n\n${productNames}\n\nEnter number (1-${matches.length}) or product name:`);
                                          if (selection) {
                                            const idx = parseInt(selection) - 1;
                                            if (idx >= 0 && idx < matches.length) {
                                              product = matches[idx];
                                            } else {
                                              const selected = matches.find(p => p.name.toLowerCase() === selection.toLowerCase());
                                              if (selected) product = selected;
                                            }
                                          }
                                        }
                                      }
                                      if (product && product.stock > 0) { 
                                        // Show option: Add normally or Buy by Amount
                                        const choice = confirm(`Product: ${product.name}\nPrice: KES ${product.sellingPrice}\n\nClick OK to add normally\nClick Cancel to buy by amount`);
                                        if (choice) {
                                          addToCart(product); 
                                        } else {
                                          setBuyByAmountProduct(product);
                                          setShowBuyByAmountModal(true);
                                        }
                                        setBarcodeInput(''); 
                                      }
                                    }
                                  }}
                                  className="px-6 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl font-black text-lg hover:from-purple-400 hover:to-pink-400 transition-all shadow-lg shadow-purple-500/30 hover:shadow-purple-500/50 hover:scale-105 active:scale-95"
                                >
                                  ADD
                                </button>
                                <button
                                  onClick={() => {
                                    if (barcodeInput) {
                                      let product = products.find(p => p.barcode === barcodeInput);
                                      if (!product) {
                                        const searchTerm = barcodeInput.toLowerCase();
                                        const matches = products.filter(p => p.name.toLowerCase().includes(searchTerm));
                                        if (matches.length === 1) {
                                          product = matches[0];
                                        } else if (matches.length > 1) {
                                          const productNames = matches.map((p, idx) => `${idx + 1}. ${p.name}`).join('\n');
                                          const selection = prompt(`Multiple products:\n${productNames}\n\nEnter number:`);
                                          if (selection) {
                                            const idx = parseInt(selection) - 1;
                                            if (idx >= 0 && idx < matches.length) product = matches[idx];
                                          }
                                        }
                                      }
                                      if (product && product.stock > 0) {
                                        setBuyByAmountProduct(product);
                                        setShowBuyByAmountModal(true);
                                        setBarcodeInput('');
                                      }
                                    }
                                  }}
                                  className="px-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl font-bold text-sm hover:from-green-400 hover:to-emerald-400 transition-all shadow-lg shadow-green-500/30"
                                  title="Buy by Amount"
                                >
                                  ðŸ’°
                                </button>
                              </div>
                            </div>
                          </div>

                          {/* QUICK BUTTONS */}
                          {quickButtons.length > 0 && (
                            <div className="glass rounded-2xl p-3 border border-white/10">
                              <div className="flex items-center justify-between mb-2">
                                <p className="text-xs text-slate-400 font-bold uppercase">Quick Add</p>
                                <button onClick={() => setEditingQuickButtons(true)} className="text-xs text-purple-400 hover:text-purple-300">Edit</button>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {quickButtons.map((btn, i) => {
                                  const product = products.find(p => p.id === btn.productId);
                                  if (!product) return null;
                                  return (
                                    <button
                                      key={i}
                                      onClick={() => product.stock > 0 && addToCart(product)}
                                      disabled={product.stock === 0}
                                      className={`px-4 py-2 rounded-xl font-bold text-sm transition-all ${product.stock > 0 ? 'bg-purple-500/30 text-purple-300 hover:bg-purple-500 hover:text-white' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}
                                    >
                                      {product.name.substring(0, 15)}
                                    </button>
                                  );
                                })}
                              </div>
                            </div>
                          )}

                          {quickButtons.length === 0 && (
                            <div className="glass rounded-2xl p-3 border border-dashed border-purple-500/30 text-center">
                              <button onClick={() => setEditingQuickButtons(true)} className="text-purple-400 hover:text-purple-300 text-sm">
                                + Add Quick Sale Buttons
                              </button>
                            </div>
                          )}

                          {/* ITEMS LIST */}
                          <div className="flex-1 glass rounded-3xl border border-white/10 overflow-hidden flex flex-col min-h-0">
                            <div className="bg-gradient-to-r from-purple-600 via-pink-600 to-purple-600 px-6 py-4 flex justify-between items-center">
                              <h3 className="text-xl font-black text-white tracking-wide">CURRENT SALE</h3>
                              <span className="bg-white/20 backdrop-blur px-4 py-1 rounded-full text-white text-sm font-bold">
                                {cart.length} products
                              </span>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                              {cart.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center py-12">
                                  <div className="relative animate-float">
                                    <div className="absolute inset-0 bg-cyan-500/20 rounded-full blur-2xl"></div>
                                    <ShoppingCart size={100} className="relative text-slate-700" />
                                  </div>
                                  <p className="text-2xl font-bold text-slate-600 mt-6">Ready for items</p>
                                  <p className="text-slate-500">Scan a barcode to begin</p>
                                </div>
                              ) : (
                                <div className="space-y-3">
                                  {cart.map((item, index) => (
                                    <div key={item.id} className="group glass rounded-2xl p-4 flex items-center gap-4 border border-white/5 hover:border-cyan-500/50 transition-all duration-300 animate-slide-in">
                                      <div className="bg-gradient-to-br from-cyan-500 to-blue-600 text-white w-14 h-14 rounded-2xl flex items-center justify-center font-black text-xl shadow-lg shadow-cyan-500/30">
                                        {index + 1}
                                      </div>
                                      <div className="flex-1 min-w-0">
                                        <h4 className="font-bold text-white text-lg truncate">{item.name}</h4>
                                        <p className="text-slate-400 text-sm">
                                          KES {item.sellingPrice.toLocaleString()} Ã— {item.quantity} {item.unit || 'units'}
                                        </p>
                                      </div>
                                      <div className="flex items-center gap-1 bg-slate-800 rounded-xl p-1">
                                        <button onClick={() => {
                                          const product = products.find(p => p.id === item.id);
                                          const unit = product?.unit || 'pieces';
                                          const decrement = (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams') ? 0.1 : 1;
                                          const newQty = Math.max(0.01, parseFloat(item.quantity) - decrement);
                                          if (newQty <= 0) {
                                            setCart(cart.filter(c => c.id !== item.id));
                                          } else {
                                            setCart(cart.map(c => c.id === item.id ? {...c, quantity: parseFloat(newQty.toFixed(2))} : c));
                                          }
                                        }}
                                          className="w-10 h-10 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500 hover:text-white font-bold text-xl transition-all">âˆ’</button>
                                        <input 
                                          type="number" 
                                          step={(item.unit === 'litres' || item.unit === 'ml' || item.unit === 'kg' || item.unit === 'grams') ? "0.01" : "1"}
                                          value={item.quantity}
                                          onChange={(e) => {
                                            const product = products.find(p => p.id === item.id);
                                            const unit = product?.unit || 'pieces';
                                            const newQty = (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams') 
                                              ? parseFloat(e.target.value) || 0 
                                              : parseInt(e.target.value) || 0;
                                            if (product) {
                                              const validQty = Math.max(0.01, Math.min(newQty, product.stock));
                                              setCart(cart.map(c => c.id === item.id ? {...c, quantity: (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams') ? parseFloat(validQty.toFixed(2)) : validQty} : c));
                                            }
                                          }}
                                          onFocus={(e) => e.target.select()}
                                          className="w-20 h-10 text-center font-black text-2xl text-white bg-slate-700 rounded-lg border-2 border-transparent focus:border-cyan-500 focus:outline-none transition-all"
                                          min="0.01"
                                        />
                                        <button onClick={() => { 
                                          const p = products.find(p => p.id === item.id);
                                          const unit = p?.unit || 'pieces';
                                          const increment = (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams') ? 0.1 : 1;
                                          const newQty = parseFloat(item.quantity) + increment;
                                          if (p && newQty <= p.stock) {
                                            setCart(cart.map(c => c.id === item.id ? {...c, quantity: (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams') ? parseFloat(newQty.toFixed(2)) : newQty} : c));
                                          }
                                        }}
                                          className="w-10 h-10 bg-purple-500/20 text-purple-400 rounded-lg hover:bg-purple-500 hover:text-white font-bold text-xl transition-all">+</button>
                                      </div>
                                      <div className="text-right min-w-[130px]">
                                        {editingCartItemAmount === item.id ? (
                                          <div className="space-y-2">
                                            <input
                                              type="number"
                                              step="0.01"
                                              value={cartItemAmountValue}
                                              onChange={(e) => setCartItemAmountValue(e.target.value)}
                                              onKeyPress={(e) => {
                                                if (e.key === 'Enter') {
                                                  const amount = parseFloat(cartItemAmountValue);
                                                  if (!isNaN(amount) && amount > 0) {
                                                    const product = products.find(p => p.id === item.id);
                                                    if (product) {
                                                      const calculatedQty = amount / product.sellingPrice;
                                                      const maxQty = product.stock || 0;
                                                      const unit = product.unit || 'pieces';
                                                      
                                                      if (calculatedQty > maxQty) {
                                                        alert(`âš ï¸ Not enough stock!\n\nAvailable: ${maxQty} ${unit}\nMax amount: KES ${(maxQty * product.sellingPrice).toFixed(2)}`);
                                                      } else {
                                                        const finalQty = (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams')
                                                          ? parseFloat(calculatedQty.toFixed(2))
                                                          : Math.floor(calculatedQty);
                                                        setCart(cart.map(c => 
                                                          c.id === item.id 
                                                            ? {...c, quantity: finalQty}
                                                            : c
                                                        ));
                                                        setEditingCartItemAmount(null);
                                                        setCartItemAmountValue('');
                                                      }
                                                    }
                                                  }
                                                } else if (e.key === 'Escape') {
                                                  setEditingCartItemAmount(null);
                                                  setCartItemAmountValue('');
                                                }
                                              }}
                                              className="w-24 px-2 py-1 bg-slate-700 border-2 border-purple-500 rounded-lg text-white text-center font-bold focus:outline-none focus:ring-2 focus:ring-purple-500"
                                              placeholder="Amount"
                                              autoFocus
                                            />
                                            <div className="flex gap-1">
                                              <button
                                                onClick={() => {
                                                  const amount = parseFloat(cartItemAmountValue);
                                                  if (!isNaN(amount) && amount > 0) {
                                                    const product = products.find(p => p.id === item.id);
                                                    if (product) {
                                                      const calculatedQty = amount / product.sellingPrice;
                                                      const maxQty = product.stock || 0;
                                                      const unit = product.unit || 'pieces';
                                                      
                                                      if (calculatedQty > maxQty) {
                                                        alert(`âš ï¸ Not enough stock!\n\nAvailable: ${maxQty} ${unit}\nMax amount: KES ${(maxQty * product.sellingPrice).toFixed(2)}`);
                                                      } else {
                                                        const finalQty = (unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams')
                                                          ? parseFloat(calculatedQty.toFixed(2))
                                                          : Math.floor(calculatedQty);
                                                        setCart(cart.map(c => 
                                                          c.id === item.id 
                                                            ? {...c, quantity: finalQty}
                                                            : c
                                                        ));
                                                        setEditingCartItemAmount(null);
                                                        setCartItemAmountValue('');
                                                      }
                                                    }
                                                  }
                                                }}
                                                className="flex-1 px-2 py-1 bg-green-500 text-white rounded text-xs font-bold hover:bg-green-600"
                                              >
                                                âœ“
                                              </button>
                                              <button
                                                onClick={() => {
                                                  setEditingCartItemAmount(null);
                                                  setCartItemAmountValue('');
                                                }}
                                                className="flex-1 px-2 py-1 bg-red-500 text-white rounded text-xs font-bold hover:bg-red-600"
                                              >
                                                âœ•
                                              </button>
                                            </div>
                                            {cartItemAmountValue && parseFloat(cartItemAmountValue) > 0 && (
                                              <p className="text-xs text-purple-400">
                                                = {((parseFloat(cartItemAmountValue) || 0) / (item.sellingPrice || 1)).toFixed(2)} {item.unit || 'units'}
                                              </p>
                                            )}
                                          </div>
                                        ) : (
                                          <div>
                                            <p className="font-black text-3xl text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">
                                              {(item.sellingPrice * item.quantity).toLocaleString()}
                                            </p>
                                            <p className="text-slate-500 text-xs">KES</p>
                                            <button
                                              onClick={() => {
                                                setEditingCartItemAmount(item.id);
                                                setCartItemAmountValue((item.sellingPrice * item.quantity).toFixed(2));
                                              }}
                                              className="mt-1 text-xs text-purple-400 hover:text-purple-300 font-bold"
                                              title="Edit amount"
                                            >
                                              ðŸ’° Edit Amount
                                            </button>
                                          </div>
                                        )}
                                      </div>
                                      <button onClick={() => setCart(cart.filter(c => c.id !== item.id))}
                                        className="opacity-0 group-hover:opacity-100 bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white p-3 rounded-xl transition-all">
                                        <Trash size={20} />
                                      </button>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                        
                        {/* Buy by Amount Modal */}
                        {showBuyByAmountModal && buyByAmountProduct && (
                          <div className="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 rounded-3xl shadow-2xl max-w-lg w-full border border-purple-500/30 overflow-hidden">
                              {/* Header */}
                              <div className="bg-gradient-to-r from-green-600 to-emerald-600 px-6 py-4">
                                <div className="flex justify-between items-center">
                                  <div>
                                    <h3 className="text-2xl font-black text-white">ðŸ’° Buy by Amount</h3>
                                    <p className="text-green-100 text-sm">Enter amount customer wants to spend</p>
                                  </div>
                                  <button 
                                    onClick={() => {
                                      setShowBuyByAmountModal(false);
                                      setBuyByAmountProduct(null);
                                      setBuyByAmountValue('');
                                    }}
                                    className="text-white/70 hover:text-white p-2 hover:bg-white/10 rounded-lg transition-all"
                                  >
                                    <X size={24} />
                                  </button>
                                </div>
                              </div>
                              
                              <div className="p-6 space-y-4">
                                {/* Product Info */}
                                <div className="bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-purple-500/30 rounded-xl p-4">
                                  <div className="flex items-center justify-between">
                                    <div className="flex-1">
                                      <p className="text-white font-bold text-xl">{buyByAmountProduct.name}</p>
                                      <div className="flex items-center gap-3 mt-2">
                                        <span className="text-purple-300 text-sm font-semibold">
                                          KES {buyByAmountProduct.sellingPrice?.toFixed(2) || '0.00'} per {buyByAmountProduct.unit || 'unit'}
                                        </span>
                                        {buyByAmountProduct.category && (
                                          <span className="text-purple-400 text-xs bg-purple-500/30 px-2 py-1 rounded">
                                            {buyByAmountProduct.category}
                                          </span>
                                        )}
                                      </div>
                                    </div>
                                    <div className="text-right">
                                      <p className="text-slate-400 text-xs">Stock Available</p>
                                      <p className="text-white font-bold text-lg">
                                        {buyByAmountProduct.unit === 'litres' || buyByAmountProduct.unit === 'ml' || buyByAmountProduct.unit === 'kg' || buyByAmountProduct.unit === 'grams'
                                          ? parseFloat(buyByAmountProduct.stock || 0).toFixed(2)
                                          : buyByAmountProduct.stock} {buyByAmountProduct.unit || 'units'}
                                      </p>
                                    </div>
                                  </div>
                                </div>
                                
                                {/* Amount Input */}
                                <div>
                                  <label className="block text-slate-400 text-sm font-bold mb-2 uppercase">Enter Amount (KES) *</label>
                                  <input
                                    type="number"
                                    step="0.01"
                                    value={buyByAmountValue}
                                    onChange={(e) => setBuyByAmountValue(e.target.value)}
                                    onKeyPress={(e) => {
                                      if (e.key === 'Enter') {
                                        handleBuyByAmount();
                                      } else if (e.key === 'Escape') {
                                        setShowBuyByAmountModal(false);
                                        setBuyByAmountProduct(null);
                                        setBuyByAmountValue('');
                                      }
                                    }}
                                    placeholder="0.00"
                                    className="w-full px-6 py-5 bg-slate-700 border-2 border-purple-500/50 rounded-xl text-3xl font-bold text-center text-white focus:border-green-500 focus:ring-4 focus:ring-green-500/30 transition-all"
                                    autoFocus
                                  />
                                  
                                  {/* Quick Amount Buttons */}
                                  <div className="mt-3">
                                    <p className="text-slate-500 text-xs mb-2 font-semibold uppercase">Quick Amounts:</p>
                                    <div className="grid grid-cols-5 gap-2">
                                      {[50, 100, 200, 500, 1000].map(amt => (
                                        <button
                                          key={amt}
                                          onClick={() => setBuyByAmountValue(amt.toString())}
                                          className="px-3 py-2 bg-slate-700 hover:bg-green-500/20 border border-slate-600 hover:border-green-500/50 text-white text-sm font-bold rounded-lg transition-all"
                                        >
                                          {amt}
                                        </button>
                                      ))}
                                    </div>
                                  </div>
                                </div>
                                
                                {/* Calculation Preview */}
                                {buyByAmountValue && parseFloat(buyByAmountValue) > 0 && (() => {
                                  const amount = parseFloat(buyByAmountValue);
                                  const price = buyByAmountProduct.sellingPrice || 1;
                                  const calculatedQty = amount / price;
                                  const maxQty = buyByAmountProduct.stock || 0;
                                  const unit = buyByAmountProduct.unit || 'units';
                                  const isValid = calculatedQty <= maxQty;
                                  
                                  return (
                                    <div className={`border-2 rounded-xl p-4 ${isValid ? 'bg-green-500/20 border-green-500/30' : 'bg-red-500/20 border-red-500/30'}`}>
                                      {isValid ? (
                                        <>
                                          <div className="flex items-center justify-between mb-2">
                                            <p className="text-green-400 text-sm font-bold uppercase">Customer Will Receive:</p>
                                            <p className="text-white font-black text-3xl">
                                              {unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams'
                                                ? calculatedQty.toFixed(2)
                                                : Math.floor(calculatedQty)} {unit}
                                            </p>
                                          </div>
                                          <div className="grid grid-cols-2 gap-2 mt-3 pt-3 border-t border-green-500/30">
                                            <div>
                                              <p className="text-green-300 text-xs">Amount:</p>
                                              <p className="text-white font-bold">KES {amount.toFixed(2)}</p>
                                            </div>
                                            <div>
                                              <p className="text-green-300 text-xs">Price per {unit}:</p>
                                              <p className="text-white font-bold">KES {price.toFixed(2)}</p>
                                            </div>
                                          </div>
                                        </>
                                      ) : (
                                        <div>
                                          <p className="text-red-400 text-sm font-bold mb-2">âš ï¸ Exceeds Available Stock!</p>
                                          <p className="text-red-300 text-xs mb-2">
                                            Requested: {unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams'
                                              ? calculatedQty.toFixed(2)
                                              : Math.floor(calculatedQty)} {unit}<br/>
                                            Available: {unit === 'litres' || unit === 'ml' || unit === 'kg' || unit === 'grams'
                                              ? parseFloat(maxQty).toFixed(2)
                                              : maxQty} {unit}
                                          </p>
                                          <p className="text-green-400 text-xs font-semibold">
                                            Maximum amount: KES {(maxQty * price).toFixed(2)}
                                          </p>
                                        </div>
                                      )}
                                    </div>
                                  );
                                })()}
                                
                                {/* Action Buttons */}
                                <div className="flex gap-3 pt-2">
                                  <button
                                    onClick={() => {
                                      setShowBuyByAmountModal(false);
                                      setBuyByAmountProduct(null);
                                      setBuyByAmountValue('');
                                    }}
                                    className="flex-1 py-4 bg-slate-700 text-slate-300 rounded-xl font-bold hover:bg-slate-600 transition-all"
                                  >
                                    Cancel (ESC)
                                  </button>
                                  <button
                                    onClick={handleBuyByAmount}
                                    disabled={!buyByAmountValue || parseFloat(buyByAmountValue) <= 0}
                                    className="flex-1 py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-black hover:from-green-400 hover:to-emerald-400 transition-all shadow-lg shadow-green-500/30 disabled:opacity-50 disabled:cursor-not-allowed"
                                  >
                                    âœ“ Add to Cart (ENTER)
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* RIGHT - PAYMENT (2 cols) */}
                        <div className="lg:col-span-2 flex flex-col gap-4 min-h-0">
                          
                          {/* MEGA TOTAL */}
                          <div className="relative overflow-hidden rounded-3xl">
                            <div className="absolute inset-0 bg-gradient-to-br from-purple-600 via-pink-600 to-purple-700 animate-gradient"></div>
                            <div className="absolute inset-0 bg-[radial-gradient(circle_at_30%_20%,rgba(255,255,255,0.2),transparent_50%)]"></div>
                            <div className="relative p-6 text-center">
                              <p className="text-white/60 text-sm font-bold uppercase tracking-[0.3em] mb-1">Total Amount</p>
                              <div className="relative">
                                <p className="text-7xl font-black text-white drop-shadow-2xl tracking-tight">
                                  {cart.reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0).toLocaleString()}
                                </p>
                                <p className="text-white/50 text-xl font-bold -mt-1">KES</p>
                              </div>
                              <div className="flex justify-center gap-3 mt-3">
                                <div className="bg-white/10 backdrop-blur px-4 py-2 rounded-xl">
                                  <p className="text-white/60 text-xs font-medium">Items</p>
                                  <p className="text-white font-black text-xl">{cart.reduce((sum, item) => sum + item.quantity, 0)}</p>
                                </div>
                                {selectedCustomer && (
                                  <div className="bg-purple-500/30 backdrop-blur px-4 py-2 rounded-xl">
                                    <p className="text-purple-200 text-xs font-medium">+Points</p>
                                    <p className="text-purple-100 font-black text-xl">{pointsToEarn}</p>
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>

                          {/* PAYMENT PANEL */}
                          <div className="flex-1 glass rounded-3xl border border-white/10 p-6 flex flex-col min-h-0 overflow-y-auto custom-scrollbar">
                            {cart.length === 0 ? (
                              <div className="flex-1 flex flex-col items-center justify-center">
                                <DollarSign size={80} className="text-slate-700 mb-4" />
                                <p className="text-slate-500 font-bold text-lg">Scan items to begin</p>
                              </div>
                            ) : (
                              <>
                                {/* Customer Loyalty Section - Simple Points */}
                                <div className="mb-5">
                                  {selectedCustomer ? (
                                    <div className="bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-500/30 rounded-xl p-3">
                                      <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                          <div className="bg-purple-500/30 p-2 rounded-lg">
                                            <Users size={20} className="text-purple-300" />
                                          </div>
                                          <div>
                                            <h4 className="font-bold text-white">{selectedCustomer.name}</h4>
                                            <p className="text-purple-300 text-xs">{selectedCustomer.points} pts â€¢ Earns +{pointsToEarn} pts</p>
                                          </div>
                                        </div>
                                        <button onClick={() => setSelectedCustomer(null)}
                                          className="text-slate-400 hover:text-white p-1">
                                          <X size={18} />
                                        </button>
                                      </div>
                                    </div>
                                  ) : (
                                    <button
                                      onClick={() => setShowCustomerSelect(true)}
                                      className="w-full py-3 bg-slate-700/30 border border-purple-500/20 rounded-xl text-purple-400 hover:bg-purple-500/10 hover:border-purple-500/40 transition-all flex items-center justify-center gap-2 text-sm"
                                    >
                                      <Users size={18} />
                                      Add Customer (Loyalty Points)
                                    </button>
                                  )}
                                </div>

                                <label className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Payment Method</label>
                                <div className="grid grid-cols-4 gap-2 mb-4">
                                  {[
                                    { name: 'Cash', icon: Banknote, color: 'from-blue-500 to-blue-600', shadow: 'shadow-blue-500/30' },
                                    { name: 'Card', icon: CreditCard, color: 'from-purple-500 to-purple-600', shadow: 'shadow-purple-500/30' },
                                    { name: 'M-Pesa', icon: Smartphone, color: 'from-emerald-500 to-emerald-600', shadow: 'shadow-emerald-500/30' },
                                    { name: 'Split', icon: DollarSign, color: 'from-amber-500 to-orange-600', shadow: 'shadow-amber-500/30' }
                                  ].map(({ name, icon: Icon, color, shadow }) => (
                                    <button key={name} onClick={() => { setPaymentMethod(name); if (name === 'Split') setSplitPayment({...splitPayment, enabled: true}); else setSplitPayment({...splitPayment, enabled: false}); }}
                                      className={`py-4 rounded-2xl flex flex-col items-center justify-center gap-1 transition-all duration-300 ${
                                        paymentMethod === name 
                                          ? `bg-gradient-to-br ${color} text-white shadow-xl ${shadow} scale-105` 
                                          : 'glass text-slate-400 hover:text-white hover:bg-white/10'
                                      }`}>
                                      <Icon size={24} />
                                      <span className="font-bold text-sm">{name}</span>
                                    </button>
                                  ))}
                                </div>

                                {paymentMethod === 'Cash' && (
                                  <div className="mb-6">
                                    <label className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 block">Amount Received</label>
                                    <input type="number" value={amountReceived || ''} onChange={(e) => setAmountReceived(parseFloat(e.target.value) || 0)}
                                      className="w-full px-4 py-4 bg-slate-800 border-2 border-slate-600 rounded-2xl text-3xl font-black text-center text-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20" placeholder="0"/>
                                    {amountReceived > 0 && (
                                      <div className="mt-4 bg-green-500/10 border border-green-500/30 p-4 rounded-2xl text-center">
                                        <p className="text-green-400 text-sm font-medium">Change</p>
                                        <p className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-400">
                                          KES {(amountReceived - cartTotal).toLocaleString()}
                                        </p>
                                      </div>
                                    )}
                                  </div>
                                )}

                                {paymentMethod === 'Split' && (
                                  <div className="mb-6 space-y-3">
                                    <div className="bg-amber-500/10 border border-amber-500/30 p-3 rounded-xl text-center">
                                      <p className="text-amber-400 text-sm">Total: <span className="font-bold">KES {cartTotal.toLocaleString()}</span></p>
                                    </div>
                                    <div>
                                      <label className="text-xs font-bold text-blue-400 uppercase tracking-wider mb-1 block">ðŸ’µ Cash Amount</label>
                                      <input type="number" value={splitPayment.cashAmount || ''} 
                                        onChange={(e) => {
                                          const cash = parseFloat(e.target.value) || 0;
                                          setSplitPayment({...splitPayment, cashAmount: cash, mpesaAmount: Math.max(0, cartTotal - cash)});
                                        }}
                                        className="w-full px-4 py-3 bg-slate-800 border-2 border-blue-500/50 rounded-xl text-xl font-bold text-center text-white focus:border-blue-500" placeholder="0"/>
                                    </div>
                                    <div>
                                      <label className="text-xs font-bold text-green-400 uppercase tracking-wider mb-1 block">ðŸ“± M-Pesa Amount</label>
                                      <input type="number" value={splitPayment.mpesaAmount || ''} 
                                        onChange={(e) => {
                                          const mpesa = parseFloat(e.target.value) || 0;
                                          setSplitPayment({...splitPayment, mpesaAmount: mpesa, cashAmount: Math.max(0, cartTotal - mpesa)});
                                        }}
                                        className="w-full px-4 py-3 bg-slate-800 border-2 border-green-500/50 rounded-xl text-xl font-bold text-center text-white focus:border-green-500" placeholder="0"/>
                                    </div>
                                    {splitPayment.mpesaAmount > 0 && (
                                      <div>
                                        <label className="text-xs font-bold text-green-400 uppercase tracking-wider mb-1 block">M-Pesa Phone</label>
                                        <input type="tel" value={mpesaPhone} onChange={(e) => setMpesaPhone(e.target.value)}
                                          className="w-full px-4 py-3 bg-slate-800 border-2 border-green-500/50 rounded-xl text-lg font-mono text-center text-white" placeholder="0712345678"/>
                                      </div>
                                    )}
                                    {(splitPayment.cashAmount + splitPayment.mpesaAmount) >= cartTotal && (
                                      <div className="bg-green-500/10 border border-green-500/30 p-3 rounded-xl text-center">
                                        <p className="text-green-400 text-sm font-bold">âœ“ Payment complete</p>
                                      </div>
                                    )}
                                  </div>
                                )}

                                {paymentMethod === 'M-Pesa' && (
                                  <div className="mb-6">
                                    <div className="bg-green-500/20 border border-green-500/30 p-4 rounded-2xl text-center">
                                      <p className="text-green-400 font-bold text-lg">ðŸ“± M-Pesa Payment</p>
                                      <p className="text-green-300 text-sm mt-1">Click Complete Sale when customer has paid</p>
                                    </div>
                                    <div className="mt-3">
                                      <label className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 block">Phone (Optional - for receipt)</label>
                                      <input type="tel" value={mpesaPhone} onChange={(e) => setMpesaPhone(e.target.value)}
                                        className="w-full px-4 py-3 bg-slate-800 border-2 border-slate-600 rounded-xl text-lg font-mono text-center text-white focus:border-green-500" placeholder="0712345678 (optional)" maxLength="12"/>
                                    </div>
                                    {mpesaProcessing && (
                                      <div className="mt-4 bg-emerald-500/20 border border-emerald-500/30 p-4 rounded-2xl text-center">
                                        <div className="w-8 h-8 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                                        <p className="text-emerald-400 font-bold">Processing...</p>
                                      </div>
                                    )}
                                  </div>
                                )}

                                {paymentMethod === 'Card' && (
                                  <div className="mb-6 glass p-6 rounded-2xl text-center">
                                    <CreditCard size={48} className="mx-auto text-purple-400 mb-2" />
                                    <p className="text-purple-300 font-bold">Ready for Card</p>
                                    <p className="text-purple-400/60 text-sm">Insert, swipe, or tap</p>
                                  </div>
                                )}

                                <div className="mt-auto space-y-3">
                                  <button onClick={completeSale} disabled={cart.length === 0}
                                    className="relative w-full py-6 rounded-2xl font-black text-2xl overflow-hidden transition-all duration-300 bg-gradient-to-r from-purple-500 via-pink-500 to-purple-500 text-white shadow-2xl shadow-purple-500/30 hover:shadow-purple-500/50 hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed">
                                    <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-full animate-shimmer"></div>
                                    <span className="relative flex items-center justify-center gap-3">
                                      <ShoppingCart size={32} />
                                      COMPLETE SALE
                                    </span>
                                  </button>

                                  {cart.length > 0 && (
                                    <div className="grid grid-cols-2 gap-3">
                                      <button onClick={holdOrder}
                                        className="py-4 glass text-amber-400 rounded-2xl font-bold hover:bg-amber-500/20 flex items-center justify-center gap-2 transition-all border border-amber-500/30">
                                        â¸ï¸ Hold Order
                                      </button>
                                      <button onClick={cancelOrder}
                                        className="py-4 glass text-red-400 rounded-2xl font-bold hover:bg-red-500/20 flex items-center justify-center gap-2 transition-all border border-red-500/30">
                                        <Trash size={20} /> Cancel
                                      </button>
                                    </div>
                                  )}
                                </div>
                              </>
                            )}
                          </div>

                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {currentView === 'stock' && (
                  <div className="space-y-6">
                    <h2 className="text-2xl font-bold">Receive Stock / Add Inventory</h2>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Barcode Scanner for Stock */}
                      <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                          <Barcode className="text-blue-600" size={24} />
                          Scan Product
                        </h3>
                        
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium mb-2">Barcode</label>
                            <input
                              type="text"
                              placeholder="Scan barcode, type code, or search by name..."
                              value={stockBarcode}
                              onChange={(e) => setStockBarcode(e.target.value)}
                              onKeyPress={(e) => {
                                if (e.key === 'Enter' && stockBarcode) {
                                  scanForStock();
                                }
                              }}
                              className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg font-mono focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                              autoFocus
                            />
                          </div>
                          <button
                            onClick={scanForStock}
                            className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2"
                          >
                            <Barcode size={20} />
                            Scan Product
                          </button>

                          {scannedProduct && (
                            <div className="bg-green-50 border-2 border-green-300 rounded-lg p-4 mt-4">
                              <h4 className="font-bold text-green-800 mb-2">âœ… Product Found!</h4>
                              <div className="space-y-1 text-sm">
                                <p><strong>Name:</strong> {scannedProduct.name}</p>
                                <p><strong>Category:</strong> {scannedProduct.category}</p>
                                <p><strong>Current Stock:</strong> <span className="font-bold text-lg text-blue-600">{scannedProduct.stock} units</span></p>
                                <p><strong>Selling Price:</strong> KES {scannedProduct.sellingPrice}</p>
                              </div>
                              
                              <div className="mt-4">
                                <label className="block text-sm font-medium mb-2">Quantity to Add</label>
                                <input
                                  type="number"
                                  placeholder="Enter quantity..."
                                  value={stockQuantity}
                                  onChange={(e) => setStockQuantity(e.target.value)}
                                  onKeyPress={(e) => e.key === 'Enter' && addStock()}
                                  className="w-full px-4 py-3 border-2 border-green-300 rounded-lg text-xl text-center font-bold focus:border-green-500"
                                  min="1"
                                />
                              </div>
                              
                              <button
                                onClick={addStock}
                                className="w-full mt-3 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 flex items-center justify-center gap-2"
                              >
                                <Plus size={20} />
                                Add Stock
                              </button>
                            </div>
                          )}

                          <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <p className="text-sm font-semibold text-blue-800 mb-2">ðŸ“Ÿ Quick Test Barcodes:</p>
                            <div className="grid grid-cols-2 gap-2">
                              {products.slice(0, 6).map(p => (
                                <button
                                  key={p.id}
                                  onClick={() => setStockBarcode(p.barcode)}
                                  className="text-xs bg-white px-2 py-2 rounded border border-blue-200 hover:bg-blue-100 text-left"
                                >
                                  <div className="font-bold">{p.name}</div>
                                  <div className="text-gray-600">{p.barcode}</div>
                                </button>
                              ))}
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Stock Receiving History */}
                      <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-bold mb-4">Recent Stock Additions</h3>
                        {stockHistory.length === 0 ? (
                          <p className="text-gray-500 text-center py-8">No stock additions yet</p>
                        ) : (
                          <div className="space-y-2 max-h-[500px] overflow-y-auto">
                            {stockHistory.slice(0, 10).map(entry => (
                              <div key={entry.id} className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div className="flex justify-between items-start mb-2">
                                  <div className="flex-1">
                                    <p className="font-bold text-gray-800">{entry.productName}</p>
                                    <p className="text-xs text-gray-500">{entry.barcode}</p>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-lg font-bold text-green-600">+{entry.quantityAdded}</p>
                                    <p className="text-xs text-gray-500">New: {entry.newStock}</p>
                                  </div>
                                </div>
                                <div className="flex justify-between text-xs text-gray-600">
                                  <span>{entry.date} {entry.time}</span>
                                  <span>By: {entry.user}</span>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                )}

                {currentView === 'lowstock' && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center">
                      <h2 className="text-2xl font-bold">âš ï¸ Low Stock Management</h2>
                      <span className="bg-red-100 text-red-800 px-4 py-2 rounded-full font-bold">
                        {lowStockItems.length} Items Need Attention
                      </span>
                    </div>

                    {lowStockItems.length === 0 ? (
                      <div className="bg-green-50 border-2 border-green-300 rounded-lg p-8 text-center">
                        <div className="text-6xl mb-4">âœ…</div>
                        <h3 className="text-xl font-bold text-green-800">All Stock Levels OK!</h3>
                        <p className="text-green-600 mt-2">No products are below reorder level.</p>
                      </div>
                    ) : (
                      <div className="grid gap-4">
                        {lowStockItems.map(item => (
                          <div key={item.id} className={`bg-white rounded-lg shadow-lg border-l-4 p-6 ${
                            item.stock === 0 ? 'border-red-600 bg-red-50' : 
                            item.stock <= item.reorderLevel / 2 ? 'border-orange-500' : 'border-yellow-500'
                          }`}>
                            <div className="flex justify-between items-start">
                              <div className="flex-1">
                                <div className="flex items-center gap-3">
                                  <h3 className="text-xl font-bold">{item.name}</h3>
                                  {item.stock === 0 && (
                                    <span className="bg-red-600 text-white text-xs px-2 py-1 rounded">OUT OF STOCK</span>
                                  )}
                                  {item.stock > 0 && item.stock <= item.reorderLevel / 2 && (
                                    <span className="bg-orange-500 text-white text-xs px-2 py-1 rounded">CRITICAL</span>
                                  )}
                                  {item.stock > item.reorderLevel / 2 && (
                                    <span className="bg-yellow-500 text-white text-xs px-2 py-1 rounded">LOW</span>
                                  )}
                                </div>
                                <p className="text-sm text-gray-600 mt-1">Category: {item.category} | Barcode: {item.barcode}</p>
                                <div className="flex gap-6 mt-3">
                                  <div>
                                    <p className="text-xs text-gray-500">Current Stock</p>
                                    <p className={`text-2xl font-bold ${item.stock === 0 ? 'text-red-600' : 'text-orange-600'}`}>
                                      {item.stock} units
                                    </p>
                                  </div>
                                  <div>
                                    <p className="text-xs text-gray-500">Reorder Level</p>
                                    <p className="text-2xl font-bold text-gray-600">{item.reorderLevel} units</p>
                                  </div>
                                  <div>
                                    <p className="text-xs text-gray-500">Suggested Order</p>
                                    <p className="text-2xl font-bold text-blue-600">
                                      {item.unit === 'litres' || item.unit === 'ml' || item.unit === 'kg' || item.unit === 'grams'
                                        ? parseFloat(Math.max(item.reorderLevel * 2 - item.stock, item.reorderLevel)).toFixed(2)
                                        : Math.max(item.reorderLevel * 2 - item.stock, item.reorderLevel)} {item.unit || 'units'}
                                    </p>
                                  </div>
                                </div>
                              </div>
                              <div className="flex flex-col gap-2">
                                <button
                                  onClick={() => {
                                    setStockBarcode(item.barcode);
                                    setScannedProduct(item);
                                    setCurrentView('stock');
                                  }}
                                  className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2"
                                >
                                  <Plus size={18} />
                                  Add Stock
                                </button>
                                <button
                                  onClick={() => {
                                    setShowPurchaseForm(true);
                                    setPurchaseItem({ productId: item.id.toString(), qty: Math.max(item.reorderLevel * 2 - item.stock, item.reorderLevel).toString(), unitCost: item.costPrice.toString() });
                                    setCurrentView('purchases');
                                  }}
                                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2"
                                >
                                  <Truck size={18} />
                                  Create PO
                                </button>
                              </div>
                            </div>
                            {/* Stock level bar */}
                            <div className="mt-4">
                              <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                                <div 
                                  className={`h-full ${item.stock === 0 ? 'bg-red-600' : item.stock <= item.reorderLevel / 2 ? 'bg-orange-500' : 'bg-yellow-500'}`}
                                  style={{ width: `${Math.min((item.stock / item.reorderLevel) * 100, 100)}%` }}
                                ></div>
                              </div>
                              <p className="text-xs text-gray-500 mt-1">
                                {Math.round((item.stock / item.reorderLevel) * 100)}% of reorder level
                              </p>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                )}

                {currentView === 'products' && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center flex-wrap gap-4">
                      <h2 className="text-2xl font-bold">ðŸ“¦ Products & Price Management</h2>
                      <button
                        onClick={() => setShowAddProduct(true)}
                        className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2"
                      >
                        <Plus size={18} />
                        Add New Product
                      </button>
                    </div>
                    
                    {/* Category Filter Buttons for Products Management */}
                    {categories.length > 0 && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <div className="flex items-center justify-between mb-3">
                          <p className="text-sm font-semibold text-gray-700">Filter by Category:</p>
                          {productFilters.category && (
                            <button 
                              onClick={() => setProductFilters({...productFilters, category: ''})}
                              className="text-xs text-blue-600 hover:text-blue-800"
                            >
                              Clear
                            </button>
                          )}
                        </div>
                        <div className="flex flex-wrap gap-2">
                          <button
                            onClick={() => setProductFilters({...productFilters, category: ''})}
                            className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                              !productFilters.category
                                ? 'bg-blue-600 text-white shadow-md'
                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                          >
                            All ({products.length})
                          </button>
                          {categories.map(cat => {
                            const count = products.filter(p => p.category === cat).length;
                            return (
                              <button
                                key={cat}
                                onClick={() => setProductFilters({...productFilters, category: cat})}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                                  productFilters.category === cat
                                    ? 'bg-blue-600 text-white shadow-md'
                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                }`}
                              >
                                {cat} ({count})
                              </button>
                            );
                          })}
                        </div>
                      </div>
                    )}

                    {/* Add Product Modal */}
                    {showAddProduct && (
                      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                          <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold">Add New Product</h3>
                            <button onClick={() => setShowAddProduct(false)} className="text-gray-500 hover:text-gray-700">
                              <X size={24} />
                            </button>
                          </div>
                          <div className="space-y-4">
                            <div>
                              <label className="block text-sm font-medium mb-1">Product Name *</label>
                              <input type="text" value={newProduct.name} onChange={(e) => setNewProduct({...newProduct, name: e.target.value})}
                                className="w-full px-3 py-2 border rounded-lg" placeholder="e.g., Rice 5kg" />
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1">Barcode (Optional)</label>
                              <input type="text" value={newProduct.barcode} onChange={(e) => setNewProduct({...newProduct, barcode: e.target.value})}
                                className="w-full px-3 py-2 border rounded-lg font-mono" placeholder="Leave empty if no barcode" />
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1">Category</label>
                              <select value={newProduct.category} onChange={(e) => setNewProduct({...newProduct, category: e.target.value})}
                                className="w-full px-3 py-2 border rounded-lg bg-white">
                                <option value="">-- Select Category --</option>
                                {[...new Set(products.map(p => p.category))].sort().map(cat => (
                                  <option key={cat} value={cat}>{cat}</option>
                                ))}
                                <option value="Beverages">Beverages</option>
                                <option value="Dairy">Dairy</option>
                                <option value="Snacks">Snacks</option>
                                <option value="Household">Household</option>
                                <option value="Personal Care">Personal Care</option>
                                <option value="Frozen">Frozen</option>
                                <option value="Canned Goods">Canned Goods</option>
                                <option value="Other">Other</option>
                              </select>
                            </div>
                            <div className="grid grid-cols-3 gap-4">
                              <div>
                                <label className="block text-sm font-medium mb-1">Buying Price (KES) *</label>
                                <input type="number" step="0.01" value={newProduct.costPrice} onChange={(e) => setNewProduct({...newProduct, costPrice: e.target.value})}
                                  className="w-full px-3 py-2 border rounded-lg" placeholder="0.00" />
                                <p className="text-xs text-gray-500 mt-1">Cost from supplier</p>
                              </div>
                              <div>
                                <label className="block text-sm font-medium mb-1">Selling Price (KES) *</label>
                                <input type="number" step="0.01" value={newProduct.sellingPrice} onChange={(e) => setNewProduct({...newProduct, sellingPrice: e.target.value})}
                                  className="w-full px-3 py-2 border rounded-lg" placeholder="0.00" />
                                <p className="text-xs text-gray-500 mt-1">Your selling price</p>
                              </div>
                              <div>
                                <label className="block text-sm font-medium mb-1">Market Price (KES)</label>
                                <input type="number" step="0.01" value={newProduct.marketPrice} onChange={(e) => setNewProduct({...newProduct, marketPrice: e.target.value})}
                                  className="w-full px-3 py-2 border rounded-lg" placeholder="0.00" />
                                <p className="text-xs text-gray-500 mt-1">Competitor price</p>
                              </div>
                            </div>
                            {newProduct.costPrice && newProduct.sellingPrice && (
                              <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                                <div className="flex justify-between items-center">
                                  <span className="text-sm text-emerald-700">Profit per unit:</span>
                                  <span className="font-bold text-emerald-800">
                                    KES {((parseFloat(newProduct.sellingPrice) || 0) - (parseFloat(newProduct.costPrice) || 0)).toFixed(2)}
                                  </span>
                                </div>
                                {newProduct.marketPrice && (
                                  <div className="flex justify-between items-center mt-2">
                                    <span className="text-sm text-blue-700">vs Market Price:</span>
                                    <span className={`font-bold ${(parseFloat(newProduct.sellingPrice) || 0) <= (parseFloat(newProduct.marketPrice) || 0) ? 'text-green-800' : 'text-orange-800'}`}>
                                      {(parseFloat(newProduct.sellingPrice) || 0) <= (parseFloat(newProduct.marketPrice) || 0) ? 'Competitive' : 'Above Market'}
                                    </span>
                                  </div>
                                )}
                              </div>
                            )}
                            <div>
                              <label className="block text-sm font-medium mb-1">Unit of Measurement *</label>
                              <select value={newProduct.unit} onChange={(e) => setNewProduct({...newProduct, unit: e.target.value})}
                                className="w-full px-3 py-2 border rounded-lg bg-white">
                                <option value="pieces">Pieces</option>
                                <option value="litres">Litres</option>
                                <option value="kg">Kilograms (kg)</option>
                                <option value="grams">Grams (g)</option>
                                <option value="ml">Milliliters (ml)</option>
                                <option value="boxes">Boxes</option>
                                <option value="packs">Packs</option>
                                <option value="bags">Bags</option>
                              </select>
                              <p className="text-xs text-gray-500 mt-1">
                                {newProduct.unit === 'litres' || newProduct.unit === 'ml' || newProduct.unit === 'kg' || newProduct.unit === 'grams' 
                                  ? 'ðŸ’¡ Use decimal values (e.g., 1.5 litres, 0.5 kg)' 
                                  : 'Select how this product is measured'}
                              </p>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <label className="block text-sm font-medium mb-1">Initial Stock ({newProduct.unit || 'units'})</label>
                                <input 
                                  type="number" 
                                  step={newProduct.unit === 'litres' || newProduct.unit === 'ml' || newProduct.unit === 'kg' || newProduct.unit === 'grams' ? "0.01" : "1"}
                                  value={newProduct.stock} 
                                  onChange={(e) => setNewProduct({...newProduct, stock: e.target.value})}
                                  className="w-full px-3 py-2 border rounded-lg" 
                                  placeholder="0" />
                              </div>
                              <div>
                                <label className="block text-sm font-medium mb-1">Reorder Level ({newProduct.unit || 'units'})</label>
                                <input 
                                  type="number" 
                                  step={newProduct.unit === 'litres' || newProduct.unit === 'ml' || newProduct.unit === 'kg' || newProduct.unit === 'grams' ? "0.01" : "1"}
                                  value={newProduct.reorderLevel} 
                                  onChange={(e) => setNewProduct({...newProduct, reorderLevel: e.target.value})}
                                  className="w-full px-3 py-2 border rounded-lg" 
                                  placeholder="10" />
                              </div>
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1">Expiry Date (optional)</label>
                              <input type="date" value={newProduct.expiryDate || ''} onChange={(e) => setNewProduct({...newProduct, expiryDate: e.target.value})}
                                className="w-full px-3 py-2 border rounded-lg" />
                            </div>
                            <button onClick={addNewProduct} className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                              Add Product
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    <div className="bg-white rounded-lg shadow overflow-hidden">
                      <table className="w-full">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Name</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Barcode</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Category</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Buying Price</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Selling Price</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Market Price</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Unit</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Stock</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Reorder</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {products.map(p => (
                            <tr key={p.id} className="border-t hover:bg-gray-50">
                              {editingProduct && editingProduct.id === p.id ? (
                                <>
                                  <td className="px-4 py-2">
                                    <input type="text" value={editingProduct.name} onChange={(e) => setEditingProduct({...editingProduct, name: e.target.value})}
                                      className="w-full px-2 py-1 border rounded text-sm" />
                                  </td>
                                  <td className="px-4 py-2">
                                    <input type="text" value={editingProduct.barcode} onChange={(e) => setEditingProduct({...editingProduct, barcode: e.target.value})}
                                      className="w-full px-2 py-1 border rounded text-sm font-mono" />
                                  </td>
                                  <td className="px-4 py-2">
                                    <input type="text" value={editingProduct.category} onChange={(e) => setEditingProduct({...editingProduct, category: e.target.value})}
                                      className="w-full px-2 py-1 border rounded text-sm" />
                                  </td>
                                  <td className="px-4 py-2">
                                    <input type="number" step="0.01" value={editingProduct.costPrice} onChange={(e) => setEditingProduct({...editingProduct, costPrice: parseFloat(e.target.value) || 0})}
                                      className="w-24 px-2 py-1 border rounded text-sm" />
                                  </td>
                                  <td className="px-4 py-2">
                                    <input type="number" step="0.01" value={editingProduct.sellingPrice} onChange={(e) => setEditingProduct({...editingProduct, sellingPrice: parseFloat(e.target.value) || 0})}
                                      className="w-24 px-2 py-1 border rounded text-sm font-bold text-green-600" />
                                  </td>
                                  <td className="px-4 py-2">
                                    <input type="number" step="0.01" value={editingProduct.marketPrice || ''} onChange={(e) => setEditingProduct({...editingProduct, marketPrice: parseFloat(e.target.value) || 0})}
                                      className="w-24 px-2 py-1 border rounded text-sm text-blue-600" />
                                  </td>
                                  <td className="px-4 py-2">
                                    <select value={editingProduct.unit || 'pieces'} onChange={(e) => setEditingProduct({...editingProduct, unit: e.target.value})}
                                      className="w-24 px-2 py-1 border rounded text-sm">
                                      <option value="pieces">Pieces</option>
                                      <option value="litres">Litres</option>
                                      <option value="kg">kg</option>
                                      <option value="grams">g</option>
                                      <option value="ml">ml</option>
                                      <option value="boxes">Boxes</option>
                                      <option value="packs">Packs</option>
                                      <option value="bags">Bags</option>
                                    </select>
                                  </td>
                                  <td className="px-4 py-2">
                                    <input 
                                      type="number" 
                                      step={(editingProduct.unit === 'litres' || editingProduct.unit === 'ml' || editingProduct.unit === 'kg' || editingProduct.unit === 'grams') ? "0.01" : "1"}
                                      value={editingProduct.stock} 
                                      onChange={(e) => setEditingProduct({...editingProduct, stock: e.target.value})}
                                      className="w-20 px-2 py-1 border rounded text-sm" />
                                  </td>
                                  <td className="px-4 py-2">
                                    <input 
                                      type="number" 
                                      step={(editingProduct.unit === 'litres' || editingProduct.unit === 'ml' || editingProduct.unit === 'kg' || editingProduct.unit === 'grams') ? "0.01" : "1"}
                                      value={editingProduct.reorderLevel} 
                                      onChange={(e) => setEditingProduct({...editingProduct, reorderLevel: e.target.value})}
                                      className="w-20 px-2 py-1 border rounded text-sm" />
                                  </td>
                                  <td className="px-4 py-2">
                                    <div className="flex gap-1">
                                      <button onClick={() => saveProductEdit(p.id)} className="bg-green-600 text-white p-1 rounded hover:bg-green-700">
                                        <Save size={16} />
                                      </button>
                                      <button onClick={() => setEditingProduct(null)} className="bg-gray-500 text-white p-1 rounded hover:bg-gray-600">
                                        <X size={16} />
                                      </button>
                                    </div>
                                  </td>
                                </>
                              ) : (
                                <>
                                  <td className="px-4 py-3 text-sm font-semibold">{p.name}</td>
                                  <td className="px-4 py-3 text-sm font-mono text-gray-600">{p.barcode}</td>
                                  <td className="px-4 py-3 text-sm">{p.category}</td>
                                  <td className="px-4 py-3 text-sm text-gray-600">KES {p.costPrice?.toFixed(2) || '0.00'}</td>
                                  <td className="px-4 py-3 text-sm font-bold text-green-600">KES {p.sellingPrice?.toFixed(2) || '0.00'}</td>
                                  <td className="px-4 py-3 text-sm text-blue-600">{p.marketPrice ? `KES ${p.marketPrice.toFixed(2)}` : '-'}</td>
                                  <td className="px-4 py-3 text-sm text-gray-600 font-semibold">{p.unit || 'pieces'}</td>
                                  <td className={`px-4 py-3 text-sm font-semibold ${p.stock <= p.reorderLevel ? 'text-red-600' : 'text-gray-800'}`}>
                                    {p.unit === 'litres' || p.unit === 'ml' || p.unit === 'kg' || p.unit === 'grams' 
                                      ? parseFloat(p.stock || 0).toFixed(2) 
                                      : p.stock} {p.unit || 'units'}
                                  </td>
                                  <td className="px-4 py-3 text-sm text-gray-600">
                                    {p.unit === 'litres' || p.unit === 'ml' || p.unit === 'kg' || p.unit === 'grams'
                                      ? parseFloat(p.reorderLevel || 0).toFixed(2)
                                      : p.reorderLevel} {p.unit || 'units'}
                                  </td>
                                  <td className="px-4 py-3">
                                    <div className="flex gap-1">
                                      <button onClick={() => setEditingProduct({...p})} className="bg-blue-600 text-white p-1 rounded hover:bg-blue-700" title="Edit">
                                        <Edit size={16} />
                                      </button>
                                      <button onClick={() => deleteProduct(p.id)} className="bg-red-600 text-white p-1 rounded hover:bg-red-700" title="Delete">
                                        <Trash size={16} />
                                      </button>
                                    </div>
                                  </td>
                                </>
                              )}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <h4 className="font-semibold text-blue-800 mb-2">ðŸ’¡ Quick Tips</h4>
                      <ul className="text-sm text-blue-700 space-y-1">
                        <li>â€¢ Click the <Edit size={14} className="inline" /> button to edit product details including prices</li>
                        <li>â€¢ Products with stock at or below reorder level are highlighted in red</li>
                        <li>â€¢ Profit margin = (Selling Price - Cost Price) / Selling Price Ã— 100</li>
                      </ul>
                    </div>
                  </div>
                )}

                {currentView === 'purchases' && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center">
                      <h2 className="text-2xl font-bold">ðŸšš Purchase Orders</h2>
                      <button
                        onClick={() => setShowPurchaseForm(true)}
                        className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2"
                      >
                        <Plus size={18} />
                        New Purchase Order
                      </button>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div className="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <p className="text-sm text-gray-600">Total Purchases</p>
                        <p className="text-2xl font-bold">KES {purchases.reduce((sum, p) => sum + (p.total || 0), 0).toLocaleString()}</p>
                        <p className="text-xs text-gray-500">{purchases.length} orders</p>
                      </div>
                      <div className="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                        <p className="text-sm text-gray-600">Total Debt (Owed)</p>
                        <p className="text-2xl font-bold text-red-700">KES {purchases.reduce((sum, p) => sum + ((p.total || 0) - (p.amountPaid || 0)), 0).toLocaleString()}</p>
                        <p className="text-xs text-gray-500">Amount owed to suppliers</p>
                      </div>
                      <div className="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500">
                        <p className="text-sm text-gray-600">Pending Orders</p>
                        <p className="text-2xl font-bold">{purchases.filter(p => p.status === 'Pending').length}</p>
                        <p className="text-xs text-gray-500">Awaiting delivery</p>
                      </div>
                      <div className="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                        <p className="text-sm text-gray-600">Paid in Full</p>
                        <p className="text-2xl font-bold">{purchases.filter(p => (p.amountPaid || 0) >= (p.total || 0)).length}</p>
                        <p className="text-xs text-gray-500">Fully paid orders</p>
                      </div>
                    </div>

                    {/* Search Bar for Purchases */}
                    <div className="bg-white rounded-lg shadow p-4">
                      <div className="flex items-center gap-3">
                        <div className="relative flex-1">
                          <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                            <Search size={20} />
                          </div>
                          <input
                            type="text"
                            value={purchaseSearchTerm}
                            onChange={(e) => setPurchaseSearchTerm(e.target.value)}
                            placeholder="Search purchases by supplier, invoice number, items, date, status..."
                            className="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          />
                          {purchaseSearchTerm && (
                            <button
                              onClick={() => setPurchaseSearchTerm('')}
                              className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                            >
                              <X size={18} />
                            </button>
                          )}
                        </div>
                        {purchaseSearchTerm && (
                          <span className="text-sm text-gray-600 font-medium whitespace-nowrap">
                            {purchases.filter(p => {
                              const search = purchaseSearchTerm.toLowerCase();
                              return (
                                p.supplier?.toLowerCase().includes(search) ||
                                p.invoiceNo?.toLowerCase().includes(search) ||
                                p.date?.includes(search) ||
                                p.items?.some(item => item.name?.toLowerCase().includes(search)) ||
                                p.status?.toLowerCase().includes(search)
                              );
                            }).length} results
                          </span>
                        )}
                      </div>
                    </div>

                    {/* Purchase Form Modal */}
                    {showPurchaseForm && (
                      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                          <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold">ðŸ“ New Purchase Order</h3>
                            <button onClick={() => { setShowPurchaseForm(false); setNewPurchase({ supplier: '', items: [], total: 0 }); }} className="text-gray-500 hover:text-gray-700">
                              <X size={24} />
                            </button>
                          </div>
                          
                          <div className="space-y-4">
                            <div>
                              <label className="block text-sm font-medium mb-1">Supplier Name *</label>
                              <input type="text" value={newPurchase.supplier} onChange={(e) => setNewPurchase({...newPurchase, supplier: e.target.value})}
                                className="w-full px-3 py-2 border rounded-lg" placeholder="e.g., ABC Distributors" />
                            </div>

                            <div className="border-t pt-4">
                              <h4 className="font-semibold mb-3">Add Items</h4>
                              <div className="grid grid-cols-3 gap-2">
                                <div>
                                  <label className="block text-xs font-medium mb-1">Product</label>
                                  <select value={purchaseItem.productId} onChange={(e) => setPurchaseItem({...purchaseItem, productId: e.target.value})}
                                    className="w-full px-2 py-2 border rounded text-sm">
                                    <option value="">Select product...</option>
                                    {products.map(p => (
                                      <option key={p.id} value={p.id}>{p.name}</option>
                                    ))}
                                  </select>
                                </div>
                                <div>
                                  <label className="block text-xs font-medium mb-1">Quantity</label>
                                  <input type="number" value={purchaseItem.qty} onChange={(e) => setPurchaseItem({...purchaseItem, qty: e.target.value})}
                                    className="w-full px-2 py-2 border rounded text-sm" placeholder="0" />
                                </div>
                                <div>
                                  <label className="block text-xs font-medium mb-1">Unit Cost (KES)</label>
                                  <input type="number" value={purchaseItem.unitCost} onChange={(e) => setPurchaseItem({...purchaseItem, unitCost: e.target.value})}
                                    className="w-full px-2 py-2 border rounded text-sm" placeholder="0" />
                                </div>
                              </div>
                              <button onClick={addPurchaseItem} className="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                                + Add Item
                              </button>
                            </div>

                            {newPurchase.items.length > 0 && (
                              <div className="border rounded-lg overflow-hidden">
                                <table className="w-full text-sm">
                                  <thead className="bg-gray-50">
                                    <tr>
                                      <th className="px-3 py-2 text-left">Product</th>
                                      <th className="px-3 py-2 text-right">Qty</th>
                                      <th className="px-3 py-2 text-right">Unit Cost</th>
                                      <th className="px-3 py-2 text-right">Total</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {newPurchase.items.map((item, idx) => (
                                      <tr key={idx} className="border-t">
                                        <td className="px-3 py-2">{item.name}</td>
                                        <td className="px-3 py-2 text-right">{item.qty}</td>
                                        <td className="px-3 py-2 text-right">KES {item.unitCost}</td>
                                        <td className="px-3 py-2 text-right font-semibold">KES {(item.qty * item.unitCost).toLocaleString()}</td>
                                      </tr>
                                    ))}
                                  </tbody>
                                  <tfoot className="bg-gray-100">
                                    <tr>
                                      <td colSpan="3" className="px-3 py-2 text-right font-bold">Total:</td>
                                      <td className="px-3 py-2 text-right font-bold text-green-600">KES {newPurchase.total.toLocaleString()}</td>
                                    </tr>
                                  </tfoot>
                                </table>
                              </div>
                            )}

                            <button onClick={savePurchase} className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                              Create Purchase Order
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Purchase Orders Table */}
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                      <table className="w-full">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left text-sm font-semibold">PO #</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Date</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Supplier</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Items</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Total</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Paid</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Debt</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Status</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {purchases.filter(p => {
                            if (!purchaseSearchTerm) return true;
                            const search = purchaseSearchTerm.toLowerCase();
                            return (
                              p.supplier?.toLowerCase().includes(search) ||
                              p.invoiceNo?.toLowerCase().includes(search) ||
                              p.date?.includes(search) ||
                              p.items?.some(item => item.name?.toLowerCase().includes(search)) ||
                              p.status?.toLowerCase().includes(search)
                            );
                          }).map(p => (
                            <tr key={p.id} className="border-t hover:bg-gray-50">
                              <td className="px-4 py-3 text-sm font-mono font-bold">{p.invoiceNo}</td>
                              <td className="px-4 py-3 text-sm">{p.date}</td>
                              <td className="px-4 py-3 text-sm font-semibold">{p.supplier}</td>
                              <td className="px-4 py-3 text-sm">
                                <ul className="text-xs text-gray-600">
                                  {p.items.map((item, idx) => (
                                    <li key={idx}>{item.name} Ã— {item.qty}</li>
                                  ))}
                                </ul>
                              </td>
                              <td className="px-4 py-3 text-sm font-bold text-green-600">KES {parseFloat(p.total || 0).toFixed(2)}</td>
                              <td className="px-4 py-3 text-sm font-semibold text-blue-600">KES {parseFloat(p.amountPaid || 0).toFixed(2)}</td>
                              <td className={`px-4 py-3 text-sm font-bold ${((p.total || 0) - (p.amountPaid || 0)) > 0 ? 'text-red-600' : 'text-green-600'}`}>
                                KES {Math.max(0, ((p.total || 0) - (p.amountPaid || 0))).toFixed(2)}
                              </td>
                              <td className="px-4 py-3 text-sm">
                                <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                  p.status === 'Received' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                                }`}>
                                  {p.status}
                                </span>
                              </td>
                              <td className="px-4 py-3">
                                <div className="flex gap-2">
                                  {p.status === 'Pending' && (
                                    <button
                                      onClick={() => receivePurchase(p.id)}
                                      className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700"
                                    >
                                      Mark Received
                                    </button>
                                  )}
                                  {((p.total || 0) - (p.amountPaid || 0)) > 0 && (
                                    <button
                                      onClick={() => {
                                        const amount = prompt(`Enter payment amount for ${p.supplier}:\n\nTotal: KES ${p.total.toFixed(2)}\nAlready Paid: KES ${(p.amountPaid || 0).toFixed(2)}\nRemaining: KES ${((p.total || 0) - (p.amountPaid || 0)).toFixed(2)}`, ((p.total || 0) - (p.amountPaid || 0)).toFixed(2));
                                        if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                                          const paidAmount = parseFloat(amount);
                                          const currentPaid = p.amountPaid || 0;
                                          const newPaid = Math.min(currentPaid + paidAmount, p.total);
                                          setPurchases(purchases.map(pur => 
                                            pur.id === p.id ? { ...pur, amountPaid: parseFloat(newPaid.toFixed(2)) } : pur
                                          ));
                                          alert(`âœ… Payment recorded!\n\nAmount Paid: KES ${paidAmount.toFixed(2)}\nTotal Paid: KES ${newPaid.toFixed(2)}\nRemaining: KES ${((p.total || 0) - newPaid).toFixed(2)}`);
                                        }
                                      }}
                                      className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700"
                                    >
                                      ðŸ’° Pay
                                    </button>
                                  )}
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {currentView === 'invoices' && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center">
                      <h2 className="text-2xl font-bold">ðŸ“„ Invoices</h2>
                      <button
                        onClick={() => setShowInvoiceForm(true)}
                        className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2"
                      >
                        <Plus size={18} />
                        Generate Invoice
                      </button>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div className="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <p className="text-sm text-gray-600">Total Invoiced</p>
                        <p className="text-2xl font-bold">KES {invoices.reduce((sum, i) => sum + i.total, 0).toLocaleString()}</p>
                      </div>
                      <div className="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                        <p className="text-sm text-gray-600">Paid</p>
                        <p className="text-2xl font-bold">KES {invoices.filter(i => i.status === 'Paid').reduce((sum, i) => sum + i.total, 0).toLocaleString()}</p>
                      </div>
                      <div className="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                        <p className="text-sm text-gray-600">Unpaid</p>
                        <p className="text-2xl font-bold">KES {invoices.filter(i => i.status === 'Unpaid').reduce((sum, i) => sum + i.total, 0).toLocaleString()}</p>
                      </div>
                      <div className="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500">
                        <p className="text-sm text-gray-600">Total Invoices</p>
                        <p className="text-2xl font-bold">{invoices.length}</p>
                      </div>
                    </div>

                    {/* Invoice Form Modal */}
                    {showInvoiceForm && (
                      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                          <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold">Generate Invoice</h3>
                            <button onClick={() => setShowInvoiceForm(false)} className="text-gray-500 hover:text-gray-700">
                              <X size={24} />
                            </button>
                          </div>
                          
                          <div className="space-y-4">
                            <div>
                              <label className="block text-sm font-medium mb-1">Select Sale *</label>
                              <select value={selectedSaleForInvoice || ''} onChange={(e) => setSelectedSaleForInvoice(parseInt(e.target.value))}
                                className="w-full px-3 py-2 border rounded-lg">
                                <option value="">Choose a sale...</option>
                                {sales.filter(s => s.itemDetails).map(s => (
                                  <option key={s.id} value={s.id}>
                                    #{s.id} - {s.date} - KES {s.total} ({s.items} items)
                                  </option>
                                ))}
                              </select>
                            </div>

                            <div className="border-t pt-4">
                              <h4 className="font-semibold mb-3">Customer Details</h4>
                              <div className="space-y-3">
                                <input type="text" value={invoiceCustomer.name} onChange={(e) => setInvoiceCustomer({...invoiceCustomer, name: e.target.value})}
                                  className="w-full px-3 py-2 border rounded-lg" placeholder="Customer/Business Name *" />
                                <input type="text" value={invoiceCustomer.address} onChange={(e) => setInvoiceCustomer({...invoiceCustomer, address: e.target.value})}
                                  className="w-full px-3 py-2 border rounded-lg" placeholder="Address" />
                                <div className="grid grid-cols-2 gap-2">
                                  <input type="text" value={invoiceCustomer.phone} onChange={(e) => setInvoiceCustomer({...invoiceCustomer, phone: e.target.value})}
                                    className="w-full px-3 py-2 border rounded-lg" placeholder="Phone" />
                                  <input type="email" value={invoiceCustomer.email} onChange={(e) => setInvoiceCustomer({...invoiceCustomer, email: e.target.value})}
                                    className="w-full px-3 py-2 border rounded-lg" placeholder="Email" />
                                </div>
                                <input type="text" value={invoiceCustomer.taxId} onChange={(e) => setInvoiceCustomer({...invoiceCustomer, taxId: e.target.value})}
                                  className="w-full px-3 py-2 border rounded-lg" placeholder="Tax/KRA PIN (optional)" />
                              </div>
                            </div>

                            <button onClick={generateInvoice} className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                              Generate Invoice
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Invoice Preview Modal */}
                    {showInvoicePreview && currentInvoice && (
                      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                          <div className="p-8 receipt-print-area">
                            {/* Invoice Header */}
                            <div className="flex justify-between items-start border-b pb-4 mb-4">
                              <div>
                                <h1 className="text-3xl font-bold text-gray-800">INVOICE</h1>
                                <p className="text-gray-600 mt-1">#{currentInvoice.invoiceNo}</p>
                              </div>
                              <div className="text-right">
                                <h2 className="text-xl font-bold">{storeConfig.storeName}</h2>
                                {storeConfig.address && <p className="text-sm text-gray-600">{storeConfig.address}</p>}
                                <p className="text-sm text-gray-600">Tel: {storeConfig.phone}</p>
                                {storeConfig.email && <p className="text-sm text-gray-600">{storeConfig.email}</p>}
                                <p className="text-sm text-gray-600">PIN: {storeConfig.taxPin}</p>
                              </div>
                            </div>

                            {/* Bill To / Invoice Info */}
                            <div className="grid grid-cols-2 gap-8 mb-6">
                              <div>
                                <h3 className="font-bold text-gray-500 mb-2">BILL TO:</h3>
                                <p className="font-bold text-lg">{currentInvoice.customer.name}</p>
                                {currentInvoice.customer.address && <p className="text-gray-600">{currentInvoice.customer.address}</p>}
                                {currentInvoice.customer.phone && <p className="text-gray-600">{currentInvoice.customer.phone}</p>}
                                {currentInvoice.customer.email && <p className="text-gray-600">{currentInvoice.customer.email}</p>}
                                {currentInvoice.customer.taxId && <p className="text-gray-600">PIN: {currentInvoice.customer.taxId}</p>}
                              </div>
                              <div className="text-right">
                                <div className="mb-2">
                                  <span className="text-gray-500">Invoice Date:</span>
                                  <span className="ml-2 font-semibold">{currentInvoice.date}</span>
                                </div>
                                <div className="mb-2">
                                  <span className="text-gray-500">Due Date:</span>
                                  <span className="ml-2 font-semibold">{currentInvoice.dueDate}</span>
                                </div>
                                <div className={`inline-block px-3 py-1 rounded-full text-sm font-bold ${
                                  currentInvoice.status === 'Paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                }`}>
                                  {currentInvoice.status}
                                </div>
                              </div>
                            </div>

                            {/* Items Table */}
                            <table className="w-full mb-6">
                              <thead>
                                <tr className="bg-gray-100">
                                  <th className="px-4 py-3 text-left">Item</th>
                                  <th className="px-4 py-3 text-right">Qty</th>
                                  <th className="px-4 py-3 text-right">Price</th>
                                  <th className="px-4 py-3 text-right">Total</th>
                                </tr>
                              </thead>
                              <tbody>
                                {currentInvoice.items.map((item, idx) => (
                                  <tr key={idx} className="border-b">
                                    <td className="px-4 py-3">{item.name}</td>
                                    <td className="px-4 py-3 text-right">{parseFloat(item.quantity || 0).toFixed(2)}</td>
                                    <td className="px-4 py-3 text-right">KES {parseFloat(item.sellingPrice || item.price || 0).toFixed(2)}</td>
                                    <td className="px-4 py-3 text-right font-semibold">KES {parseFloat(item.lineTotal || ((item.sellingPrice || item.price || 0) * (item.quantity || 0))).toFixed(2)}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>

                            {/* Totals */}
                            <div className="flex justify-end">
                              <div className="w-64">
                                <div className="flex justify-between py-2 border-b">
                                  <span>Subtotal:</span>
                                  <span>KES {parseFloat(currentInvoice.subtotal || 0).toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between py-2 border-b">
                                  <span>VAT (16%):</span>
                                  <span>KES {parseFloat(currentInvoice.tax || 0).toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between py-3 font-bold text-lg">
                                  <span>TOTAL:</span>
                                  <span>KES {parseFloat(currentInvoice.total || 0).toFixed(2)}</span>
                                </div>
                              </div>
                            </div>

                            {/* Footer */}
                            <div className="mt-8 pt-4 border-t text-center text-sm text-gray-500">
                              <p>Thank you for your business!</p>
                              <p className="mt-1">Payment terms: Net 30 days</p>
                            </div>
                          </div>

                          {/* Action Buttons */}
                          <div className="no-print flex gap-2 p-4 border-t bg-gray-50">
                            <button onClick={() => window.print()} className="flex-1 bg-blue-600 text-white py-3 rounded-lg flex items-center justify-center gap-2 hover:bg-blue-700">
                              <Printer size={20} />
                              Print Invoice
                            </button>
                            <button onClick={() => { setShowInvoicePreview(false); setCurrentInvoice(null); }} className="flex-1 bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700">
                              Close
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Invoices Table */}
                    {invoices.length === 0 ? (
                      <div className="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <ClipboardList className="mx-auto text-gray-400 mb-4" size={48} />
                        <h3 className="text-lg font-semibold text-gray-600">No Invoices Yet</h3>
                        <p className="text-gray-500 mt-1">Generate invoices from completed sales</p>
                      </div>
                    ) : (
                      <div className="bg-white rounded-lg shadow overflow-hidden">
                        <table className="w-full">
                          <thead className="bg-gray-50">
                            <tr>
                              <th className="px-4 py-3 text-left text-sm font-semibold">Invoice #</th>
                              <th className="px-4 py-3 text-left text-sm font-semibold">Date</th>
                              <th className="px-4 py-3 text-left text-sm font-semibold">Customer</th>
                              <th className="px-4 py-3 text-left text-sm font-semibold">Amount</th>
                              <th className="px-4 py-3 text-left text-sm font-semibold">Due Date</th>
                              <th className="px-4 py-3 text-left text-sm font-semibold">Status</th>
                              <th className="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {invoices.map(inv => (
                              <tr key={inv.id} className="border-t hover:bg-gray-50">
                                <td className="px-4 py-3 text-sm font-mono font-bold">{inv.invoiceNo}</td>
                                <td className="px-4 py-3 text-sm">{inv.date}</td>
                                <td className="px-4 py-3 text-sm font-semibold">{inv.customer.name}</td>
                                <td className="px-4 py-3 text-sm font-bold text-green-600">KES {inv.total.toFixed(2)}</td>
                                <td className="px-4 py-3 text-sm">{inv.dueDate}</td>
                                <td className="px-4 py-3 text-sm">
                                  <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                    inv.status === 'Paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                  }`}>
                                    {inv.status}
                                  </span>
                                </td>
                                <td className="px-4 py-3">
                                  <div className="flex gap-2">
                                    <button onClick={() => { setCurrentInvoice(inv); setShowInvoicePreview(true); }} className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                      View
                                    </button>
                                    {inv.status === 'Unpaid' && (
                                      <button onClick={() => markInvoicePaid(inv.id)} className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                        Mark Paid
                                      </button>
                                    )}
                                  </div>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                )}

                {currentView === 'customers' && (
                  <div className="space-y-6">
                    {/* Header */}
                    <div className="flex justify-between items-center">
                      <div>
                        <h2 className="text-2xl font-bold">ðŸ‘¥ Loyalty Customers</h2>
                        <p className="text-gray-600">1 point per KES 100 spent</p>
                      </div>
                      <button
                        onClick={() => setShowAddCustomer(true)}
                        className="px-6 py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 flex items-center gap-2"
                      >
                        <Plus size={20} /> Register Customer
                      </button>
                    </div>

                    {/* Stats Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div className="bg-gradient-to-r from-purple-500 to-pink-500 p-6 rounded-xl text-white">
                        <p className="text-purple-100">Total Customers</p>
                        <p className="text-4xl font-black">{customers.length}</p>
                      </div>
                      <div className="bg-gradient-to-r from-yellow-500 to-orange-500 p-6 rounded-xl text-white">
                        <p className="text-yellow-100">Total Points Issued</p>
                        <p className="text-4xl font-black">{customers.reduce((sum, c) => sum + (c.points || 0), 0).toLocaleString()}</p>
                      </div>
                      <div className="bg-gradient-to-r from-green-500 to-emerald-500 p-6 rounded-xl text-white">
                        <p className="text-green-100">Total Spent</p>
                        <p className="text-4xl font-black">KES {customers.reduce((sum, c) => sum + (c.totalSpent || 0), 0).toLocaleString()}</p>
                      </div>
                      <div className="bg-gradient-to-r from-blue-500 to-cyan-500 p-6 rounded-xl text-white">
                        <p className="text-blue-100">Total Visits</p>
                        <p className="text-4xl font-black">{customers.reduce((sum, c) => sum + (c.visits || 0), 0)}</p>
                      </div>
                    </div>

                    {/* Search */}
                    <div className="bg-white p-4 rounded-lg shadow">
                      <input
                        type="text"
                        placeholder="ðŸ” Search by name or mobile number..."
                        value={customerSearchTerm}
                        onChange={(e) => setCustomerSearchTerm(e.target.value)}
                        className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500"
                      />
                    </div>

                    {/* Customer List */}
                    <div className="bg-white rounded-xl shadow overflow-hidden">
                      <table className="w-full">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-6 py-4 text-left font-bold text-gray-700">Customer</th>
                            <th className="px-6 py-4 text-left font-bold text-gray-700">Mobile</th>
                            <th className="px-6 py-4 text-center font-bold text-gray-700">Points</th>
                            <th className="px-6 py-4 text-right font-bold text-gray-700">Total Spent</th>
                            <th className="px-6 py-4 text-center font-bold text-gray-700">Visits</th>
                            <th className="px-6 py-4 text-center font-bold text-gray-700">Joined</th>
                            <th className="px-6 py-4 text-center font-bold text-gray-700">Actions</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y">
                          {customers
                            .filter(c => 
                              c.name.toLowerCase().includes(customerSearchTerm.toLowerCase()) ||
                              c.phone.includes(customerSearchTerm)
                            )
                            .map(c => (
                            <tr key={c.id} className="hover:bg-purple-50">
                              <td className="px-6 py-4">
                                <div className="font-bold text-gray-900">{c.name}</div>
                              </td>
                              <td className="px-6 py-4 font-mono text-gray-600">{c.phone}</td>
                              <td className="px-6 py-4 text-center">
                                <span className="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-full font-black text-lg">
                                  â­ {c.points || 0}
                                </span>
                              </td>
                              <td className="px-6 py-4 text-right font-bold text-green-600">
                                KES {(c.totalSpent || 0).toLocaleString()}
                              </td>
                              <td className="px-6 py-4 text-center text-gray-600">{c.visits || 0}</td>
                              <td className="px-6 py-4 text-center text-gray-500 text-sm">{c.joinDate || '-'}</td>
                              <td className="px-6 py-4 text-center">
                                <button
                                  onClick={() => {
                                    const points = prompt('Add bonus points for ' + c.name + ':\n\nCurrent: ' + (c.points || 0) + ' points\n\nEnter points to add:');
                                    if (points && !isNaN(points)) {
                                      setCustomers(customers.map(cust => 
                                        cust.id === c.id ? {...cust, points: (cust.points || 0) + parseInt(points)} : cust
                                      ));
                                    }
                                  }}
                                  className="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm font-bold"
                                >
                                  + Points
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                      {customers.length === 0 && (
                        <div className="text-center py-12 text-gray-500">
                          <Users size={48} className="mx-auto mb-4 text-gray-300" />
                          <p className="text-lg">No loyalty customers yet</p>
                          <p className="text-sm">Register customers at POS or click "Register Customer" above</p>
                        </div>
                      )}
                    </div>

                    {/* Register Customer Modal */}
                    {showAddCustomer && (
                      <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
                          <div className="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">
                            <div className="flex justify-between items-center">
                              <div>
                                <h3 className="text-xl font-black text-white">ðŸŽ Register for Loyalty</h3>
                                <p className="text-purple-100 text-sm">Earn 1 point per KES 100 spent</p>
                              </div>
                              <button onClick={() => setShowAddCustomer(false)} className="text-white/70 hover:text-white">
                                <X size={24} />
                              </button>
                            </div>
                          </div>
                          <div className="p-6 space-y-4">
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Customer Name</label>
                              <input
                                type="text"
                                value={newCustomer.name}
                                onChange={(e) => setNewCustomer({...newCustomer, name: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-lg focus:border-purple-500"
                                placeholder="Enter customer name"
                                autoFocus
                              />
                            </div>
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Mobile Number</label>
                              <input
                                type="tel"
                                value={newCustomer.phone}
                                onChange={(e) => setNewCustomer({...newCustomer, phone: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-lg font-mono focus:border-purple-500"
                                placeholder="0712345678"
                              />
                            </div>
                            <button
                              onClick={addNewCustomer}
                              className="w-full py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-bold text-lg hover:from-purple-400 hover:to-pink-400"
                            >
                              âœ“ Register Customer
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* SUPPLIERS VIEW */}
                {currentView === 'suppliers' && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center">
                      <div>
                        <h2 className="text-2xl font-bold">ðŸšš Supplier Management</h2>
                        <p className="text-gray-600">Manage your product suppliers</p>
                      </div>
                      <button
                        onClick={() => setShowAddSupplier(true)}
                        className="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2"
                      >
                        <Plus size={20} /> Add Supplier
                      </button>
                    </div>

                    {/* Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="bg-gradient-to-r from-blue-500 to-cyan-500 p-6 rounded-xl text-white">
                        <p className="text-blue-100">Total Suppliers</p>
                        <p className="text-4xl font-black">{suppliers.length}</p>
                      </div>
                      <div className="bg-gradient-to-r from-green-500 to-emerald-500 p-6 rounded-xl text-white">
                        <p className="text-green-100">Total Purchases</p>
                        <p className="text-4xl font-black">KES {suppliers.reduce((sum, s) => sum + (s.totalPurchases || 0), 0).toLocaleString()}</p>
                      </div>
                      <div className="bg-gradient-to-r from-purple-500 to-pink-500 p-6 rounded-xl text-white">
                        <p className="text-purple-100">Products Supplied</p>
                        <p className="text-4xl font-black">{suppliers.reduce((sum, s) => sum + (s.products?.length || 0), 0)}</p>
                      </div>
                    </div>

                    {/* Supplier List */}
                    <div className="bg-white rounded-xl shadow overflow-hidden">
                      <table className="w-full">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-6 py-4 text-left font-bold text-gray-700">Supplier</th>
                            <th className="px-6 py-4 text-left font-bold text-gray-700">Contact</th>
                            <th className="px-6 py-4 text-left font-bold text-gray-700">Products</th>
                            <th className="px-6 py-4 text-right font-bold text-gray-700">Total Purchases</th>
                            <th className="px-6 py-4 text-center font-bold text-gray-700">Actions</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y">
                          {suppliers.map(supplier => (
                            <tr key={supplier.id} className="hover:bg-blue-50">
                              <td className="px-6 py-4">
                                <div className="font-bold text-gray-900">{supplier.name}</div>
                                <div className="text-sm text-gray-500">{supplier.address}</div>
                              </td>
                              <td className="px-6 py-4">
                                <div className="text-gray-900">{supplier.phone}</div>
                                <div className="text-sm text-gray-500">{supplier.email}</div>
                              </td>
                              <td className="px-6 py-4">
                                <div className="flex flex-wrap gap-1">
                                  {(supplier.products || []).slice(0, 3).map((p, i) => (
                                    <span key={i} className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">{p}</span>
                                  ))}
                                  {(supplier.products?.length || 0) > 3 && (
                                    <span className="text-gray-500 text-xs">+{supplier.products.length - 3} more</span>
                                  )}
                                </div>
                              </td>
                              <td className="px-6 py-4 text-right font-bold text-green-600">
                                KES {(supplier.totalPurchases || 0).toLocaleString()}
                              </td>
                              <td className="px-6 py-4 text-center">
                                <button
                                  onClick={() => setEditingSupplier(supplier)}
                                  className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-bold mr-2"
                                >
                                  Edit
                                </button>
                                <button
                                  onClick={() => {
                                    if (confirm('Delete supplier ' + supplier.name + '?')) {
                                      setSuppliers(suppliers.filter(s => s.id !== supplier.id));
                                    }
                                  }}
                                  className="px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm font-bold"
                                >
                                  Delete
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                      {suppliers.length === 0 && (
                        <div className="text-center py-12 text-gray-500">
                          <Truck size={48} className="mx-auto mb-4 text-gray-300" />
                          <p className="text-lg">No suppliers yet</p>
                          <p className="text-sm">Add your first supplier to track purchases</p>
                        </div>
                      )}
                    </div>

                    {/* Add Supplier Modal */}
                    {showAddSupplier && (
                      <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
                          <div className="bg-gradient-to-r from-blue-600 to-cyan-600 px-6 py-4">
                            <div className="flex justify-between items-center">
                              <h3 className="text-xl font-black text-white">ðŸšš Add Supplier</h3>
                              <button onClick={() => setShowAddSupplier(false)} className="text-white/70 hover:text-white">
                                <X size={24} />
                              </button>
                            </div>
                          </div>
                          <div className="p-6 space-y-4">
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Supplier Name *</label>
                              <input type="text" value={newSupplier.name} onChange={(e) => setNewSupplier({...newSupplier, name: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500" placeholder="ABC Distributors" />
                            </div>
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Phone *</label>
                              <input type="tel" value={newSupplier.phone} onChange={(e) => setNewSupplier({...newSupplier, phone: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500" placeholder="0722111222" />
                            </div>
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Email</label>
                              <input type="email" value={newSupplier.email} onChange={(e) => setNewSupplier({...newSupplier, email: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500" placeholder="supplier@email.com" />
                            </div>
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Address</label>
                              <input type="text" value={newSupplier.address} onChange={(e) => setNewSupplier({...newSupplier, address: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500" placeholder="Industrial Area, Nairobi" />
                            </div>
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Products (comma separated)</label>
                              <input type="text" value={newSupplier.products} onChange={(e) => setNewSupplier({...newSupplier, products: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500" placeholder="Rice, Sugar, Flour" />
                            </div>
                            <button
                              onClick={() => {
                                if (!newSupplier.name || !newSupplier.phone) {
                                  alert('Please enter supplier name and phone');
                                  return;
                                }
                                const supplier = {
                                  id: Math.max(...suppliers.map(s => s.id), 0) + 1,
                                  name: newSupplier.name,
                                  phone: newSupplier.phone,
                                  email: newSupplier.email,
                                  address: newSupplier.address,
                                  products: newSupplier.products.split(',').map(p => p.trim()).filter(p => p),
                                  totalPurchases: 0
                                };
                                setSuppliers([...suppliers, supplier]);
                                setShowAddSupplier(false);
                                setNewSupplier({ name: '', phone: '', email: '', address: '', products: '' });
                              }}
                              className="w-full py-4 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl font-bold text-lg hover:from-blue-400 hover:to-cyan-400"
                            >
                              âœ“ Add Supplier
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Edit Supplier Modal */}
                    {editingSupplier && (
                      <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
                          <div className="bg-gradient-to-r from-blue-600 to-cyan-600 px-6 py-4">
                            <div className="flex justify-between items-center">
                              <h3 className="text-xl font-black text-white">âœï¸ Edit Supplier</h3>
                              <button onClick={() => setEditingSupplier(null)} className="text-white/70 hover:text-white">
                                <X size={24} />
                              </button>
                            </div>
                          </div>
                          <div className="p-6 space-y-4">
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Supplier Name *</label>
                              <input type="text" value={editingSupplier.name} onChange={(e) => setEditingSupplier({...editingSupplier, name: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500" />
                            </div>
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Phone *</label>
                              <input type="tel" value={editingSupplier.phone} onChange={(e) => setEditingSupplier({...editingSupplier, phone: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500" />
                            </div>
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Email</label>
                              <input type="email" value={editingSupplier.email || ''} onChange={(e) => setEditingSupplier({...editingSupplier, email: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500" />
                            </div>
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Address</label>
                              <input type="text" value={editingSupplier.address || ''} onChange={(e) => setEditingSupplier({...editingSupplier, address: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500" />
                            </div>
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Products (comma separated)</label>
                              <input type="text" value={(editingSupplier.products || []).join(', ')} onChange={(e) => setEditingSupplier({...editingSupplier, products: e.target.value.split(',').map(p => p.trim()).filter(p => p)})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500" />
                            </div>
                            <button
                              onClick={() => {
                                setSuppliers(suppliers.map(s => s.id === editingSupplier.id ? editingSupplier : s));
                                setEditingSupplier(null);
                              }}
                              className="w-full py-4 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl font-bold text-lg hover:from-blue-400 hover:to-cyan-400"
                            >
                              âœ“ Save Changes
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* EXPENSES VIEW */}
                {currentView === 'expenses' && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center">
                      <div>
                        <h2 className="text-2xl font-bold">ðŸ’° Expense Tracking</h2>
                        <p className="text-gray-600">Track business expenses and see true profit</p>
                      </div>
                      <button
                        onClick={() => setShowAddExpense(true)}
                        className="px-6 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 flex items-center gap-2"
                      >
                        <Plus size={20} /> Add Expense
                      </button>
                    </div>

                    {/* Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div className="bg-gradient-to-r from-red-500 to-pink-500 p-6 rounded-xl text-white">
                        <p className="text-red-100">This Month Expenses</p>
                        <p className="text-4xl font-black">KES {expenses.filter(e => e.date?.startsWith(new Date().toISOString().slice(0, 7))).reduce((sum, e) => sum + (e.amount || 0), 0).toLocaleString()}</p>
                      </div>
                      <div className="bg-gradient-to-r from-green-500 to-emerald-500 p-6 rounded-xl text-white">
                        <p className="text-green-100">This Month Revenue</p>
                        <p className="text-4xl font-black">KES {sales.filter(s => s.date?.startsWith(new Date().toISOString().slice(0, 7))).reduce((sum, s) => sum + (s.total || 0), 0).toLocaleString()}</p>
                      </div>
                      <div className="bg-gradient-to-r from-blue-500 to-cyan-500 p-6 rounded-xl text-white">
                        <p className="text-blue-100">Gross Profit</p>
                        <p className="text-4xl font-black">KES {sales.filter(s => s.date?.startsWith(new Date().toISOString().slice(0, 7))).reduce((sum, s) => sum + (s.profit || 0), 0).toLocaleString()}</p>
                      </div>
                      <div className="bg-gradient-to-r from-purple-500 to-pink-500 p-6 rounded-xl text-white">
                        <p className="text-purple-100">Net Profit</p>
                        <p className="text-4xl font-black">KES {(sales.filter(s => s.date?.startsWith(new Date().toISOString().slice(0, 7))).reduce((sum, s) => sum + (s.profit || 0), 0) - expenses.filter(e => e.date?.startsWith(new Date().toISOString().slice(0, 7))).reduce((sum, e) => sum + (e.amount || 0), 0)).toLocaleString()}</p>
                      </div>
                    </div>

                    {/* Expense Categories Summary */}
                    <div className="bg-white rounded-xl shadow p-6">
                      <h3 className="font-bold text-lg mb-4">Expense by Category</h3>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {['Rent', 'Utilities', 'Salaries', 'Supplies', 'Transport', 'Other'].map(cat => {
                          const total = expenses.filter(e => e.category === cat).reduce((sum, e) => sum + (e.amount || 0), 0);
                          return (
                            <div key={cat} className="bg-gray-50 p-4 rounded-lg">
                              <p className="text-gray-500 text-sm">{cat}</p>
                              <p className="text-xl font-bold text-gray-900">KES {total.toLocaleString()}</p>
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    {/* Expense List */}
                    <div className="bg-white rounded-xl shadow overflow-hidden">
                      <table className="w-full">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-6 py-4 text-left font-bold text-gray-700">Date</th>
                            <th className="px-6 py-4 text-left font-bold text-gray-700">Category</th>
                            <th className="px-6 py-4 text-left font-bold text-gray-700">Description</th>
                            <th className="px-6 py-4 text-right font-bold text-gray-700">Amount</th>
                            <th className="px-6 py-4 text-center font-bold text-gray-700">Actions</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y">
                          {expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(expense => (
                            <tr key={expense.id} className="hover:bg-red-50">
                              <td className="px-6 py-4 text-gray-900">{expense.date}</td>
                              <td className="px-6 py-4">
                                <span className="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-bold">{expense.category}</span>
                              </td>
                              <td className="px-6 py-4 text-gray-600">{expense.description}</td>
                              <td className="px-6 py-4 text-right font-bold text-red-600">-KES {(expense.amount || 0).toLocaleString()}</td>
                              <td className="px-6 py-4 text-center">
                                <button
                                  onClick={() => {
                                    if (confirm('Delete this expense?')) {
                                      setExpenses(expenses.filter(e => e.id !== expense.id));
                                    }
                                  }}
                                  className="px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm font-bold"
                                >
                                  Delete
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                      {expenses.length === 0 && (
                        <div className="text-center py-12 text-gray-500">
                          <DollarSign size={48} className="mx-auto mb-4 text-gray-300" />
                          <p className="text-lg">No expenses recorded</p>
                          <p className="text-sm">Add expenses to track your true profit</p>
                        </div>
                      )}
                    </div>

                    {/* Add Expense Modal */}
                    {showAddExpense && (
                      <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
                          <div className="bg-gradient-to-r from-red-600 to-pink-600 px-6 py-4">
                            <div className="flex justify-between items-center">
                              <h3 className="text-xl font-black text-white">ðŸ’° Add Expense</h3>
                              <button onClick={() => setShowAddExpense(false)} className="text-white/70 hover:text-white">
                                <X size={24} />
                              </button>
                            </div>
                          </div>
                          <div className="p-6 space-y-4">
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Date</label>
                              <input type="date" value={newExpense.date} onChange={(e) => setNewExpense({...newExpense, date: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500" />
                            </div>
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Category</label>
                              <select value={newExpense.category} onChange={(e) => setNewExpense({...newExpense, category: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500">
                                <option>Rent</option>
                                <option>Utilities</option>
                                <option>Salaries</option>
                                <option>Supplies</option>
                                <option>Transport</option>
                                <option>Other</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Description</label>
                              <input type="text" value={newExpense.description} onChange={(e) => setNewExpense({...newExpense, description: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500" placeholder="Monthly electricity bill" />
                            </div>
                            <div>
                              <label className="block text-sm text-gray-700 font-bold mb-2">Amount (KES)</label>
                              <input type="number" value={newExpense.amount} onChange={(e) => setNewExpense({...newExpense, amount: e.target.value})}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500 text-2xl font-bold" placeholder="0" />
                            </div>
                            <button
                              onClick={() => {
                                if (!newExpense.amount) {
                                  alert('Please enter amount');
                                  return;
                                }
                                const expense = {
                                  id: Math.max(...expenses.map(e => e.id), 0) + 1,
                                  date: newExpense.date,
                                  category: newExpense.category,
                                  description: newExpense.description,
                                  amount: parseFloat(newExpense.amount)
                                };
                                setExpenses([...expenses, expense]);
                                setShowAddExpense(false);
                                setNewExpense({ date: new Date().toISOString().split('T')[0], category: 'Rent', description: '', amount: '' });
                              }}
                              className="w-full py-4 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-xl font-bold text-lg hover:from-red-400 hover:to-pink-400"
                            >
                              âœ“ Add Expense
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {currentView === 'reports' && (
                  <div className="space-y-6">
                    <div className="flex justify-between items-center flex-wrap gap-4">
                      <h2 className="text-2xl font-bold">ðŸ“Š Reports & Analytics</h2>
                      <div className="flex gap-2">
                        <button onClick={backupAllData} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2">
                          ðŸ“¦ Backup All Data
                        </button>
                        <label className="px-4 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 flex items-center gap-2 cursor-pointer">
                          ðŸ“¥ Restore Backup
                          <input type="file" accept=".json" onChange={restoreFromBackup} className="hidden" />
                        </label>
                      </div>
                    </div>

                    {/* Export Buttons */}
                    <div className="bg-white p-4 rounded-lg shadow flex flex-wrap gap-2">
                      <span className="font-bold text-gray-700 mr-2">Export to CSV:</span>
                      <button onClick={() => exportToCSV(sales, 'sales')} className="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm font-bold">Sales</button>
                      <button onClick={() => exportToCSV(products, 'products')} className="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm font-bold">Products</button>
                      <button onClick={() => exportToCSV(customers, 'customers')} className="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm font-bold">Customers</button>
                      <button onClick={() => exportToCSV(suppliers, 'suppliers')} className="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm font-bold">Suppliers</button>
                      <button onClick={() => exportToCSV(expenses, 'expenses')} className="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm font-bold">Expenses</button>
                    </div>
                    
                    {/* Report Type Tabs */}
                    <div className="flex gap-2 flex-wrap">
                      {[
                        { id: 'sales', label: 'Sales Report', icon: TrendingUp },
                        { id: 'products', label: 'Product Analysis', icon: Package },
                        { id: 'inventory', label: 'Inventory Report', icon: BarChart },
                        { id: 'purchases', label: 'Purchase History', icon: Truck },
                        { id: 'employees', label: 'Employee Performance', icon: Users }
                      ].map(tab => (
                        <button
                          key={tab.id}
                          onClick={() => setReportType(tab.id)}
                          className={`flex items-center gap-2 px-4 py-2 rounded-lg font-semibold ${
                            reportType === tab.id ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`}
                        >
                          <tab.icon size={18} />
                          {tab.label}
                        </button>
                      ))}
                    </div>

                    {/* Date Range Filter */}
                    <div className="bg-white p-4 rounded-lg shadow flex flex-wrap gap-4 items-end">
                      <div>
                        <label className="block text-sm font-medium mb-1">From Date</label>
                        <input
                          type="date"
                          value={reportDateRange.start}
                          onChange={(e) => setReportDateRange({...reportDateRange, start: e.target.value})}
                          className="px-3 py-2 border rounded-lg"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">To Date</label>
                        <input
                          type="date"
                          value={reportDateRange.end}
                          onChange={(e) => setReportDateRange({...reportDateRange, end: e.target.value})}
                          className="px-3 py-2 border rounded-lg"
                        />
                      </div>
                      <button
                        onClick={() => setReportDateRange({ start: '', end: '' })}
                        className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                      >
                        Clear Filters
                      </button>
                      <button
                        onClick={() => {
                          const today = new Date().toISOString().split('T')[0];
                          setReportDateRange({ start: today, end: today });
                        }}
                        className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200"
                      >
                        Today
                      </button>
                      <button
                        onClick={() => {
                          const today = new Date();
                          const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                          setReportDateRange({ 
                            start: weekAgo.toISOString().split('T')[0], 
                            end: today.toISOString().split('T')[0] 
                          });
                        }}
                        className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200"
                      >
                        Last 7 Days
                      </button>
                    </div>

                    {reportType === 'sales' && (
                      <>
                        {/* Summary Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                          <div className="bg-gradient-to-r from-blue-500 to-blue-600 p-6 rounded-lg text-white">
                            <p className="text-sm opacity-80">Total Revenue</p>
                            <p className="text-3xl font-bold">KES {getFilteredSales().reduce((sum, s) => sum + s.total, 0).toLocaleString()}</p>
                            <p className="text-xs opacity-70 mt-1">{getFilteredSales().length} transactions</p>
                          </div>
                          <div className="bg-gradient-to-r from-green-500 to-green-600 p-6 rounded-lg text-white">
                            <p className="text-sm opacity-80">Total Profit</p>
                            <p className="text-3xl font-bold">KES {getFilteredSales().reduce((sum, s) => sum + s.profit, 0).toLocaleString()}</p>
                            <p className="text-xs opacity-70 mt-1">
                              {getFilteredSales().reduce((sum, s) => sum + s.total, 0) > 0 
                                ? ((getFilteredSales().reduce((sum, s) => sum + s.profit, 0) / getFilteredSales().reduce((sum, s) => sum + s.total, 0)) * 100).toFixed(1) 
                                : 0}% margin
                            </p>
                          </div>
                          <div className="bg-gradient-to-r from-purple-500 to-purple-600 p-6 rounded-lg text-white">
                            <p className="text-sm opacity-80">Avg Transaction</p>
                            <p className="text-3xl font-bold">
                              KES {getFilteredSales().length > 0 
                                ? (getFilteredSales().reduce((sum, s) => sum + s.total, 0) / getFilteredSales().length).toFixed(0) 
                                : 0}
                            </p>
                            <p className="text-xs opacity-70 mt-1">Per sale</p>
                          </div>
                          <div className="bg-gradient-to-r from-orange-500 to-orange-600 p-6 rounded-lg text-white">
                            <p className="text-sm opacity-80">Items Sold</p>
                            <p className="text-3xl font-bold">{getFilteredSales().reduce((sum, s) => sum + s.items, 0)}</p>
                            <p className="text-xs opacity-70 mt-1">Total items</p>
                          </div>
                        </div>

                        {/* Payment Method Summary */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          {['Cash', 'Card', 'M-Pesa'].map(method => {
                            const methodSales = getFilteredSales().filter(s => s.paymentMethod === method);
                            const methodTotal = methodSales.reduce((sum, s) => sum + s.total, 0);
                            const percentage = getFilteredSales().reduce((sum, s) => sum + s.total, 0) > 0
                              ? (methodTotal / getFilteredSales().reduce((sum, s) => sum + s.total, 0) * 100).toFixed(1)
                              : 0;
                            return (
                              <div key={method} className={`p-6 rounded-lg border-l-4 ${
                                method === 'Cash' ? 'bg-blue-50 border-blue-500' :
                                method === 'Card' ? 'bg-purple-50 border-purple-500' :
                                'bg-green-50 border-green-500'
                              }`}>
                                <div className="flex items-center justify-between">
                                  <div>
                                    <p className="text-sm text-gray-600">{method} Payments</p>
                                    <p className="text-2xl font-bold">KES {methodTotal.toLocaleString()}</p>
                                    <p className="text-xs text-gray-500 mt-1">{methodSales.length} transactions ({percentage}%)</p>
                                  </div>
                                  {method === 'Cash' && <Banknote size={32} className="text-blue-500" />}
                                  {method === 'Card' && <CreditCard size={32} className="text-purple-500" />}
                                  {method === 'M-Pesa' && <Smartphone size={32} className="text-green-500" />}
                                </div>
                                {/* Progress bar */}
                                <div className="mt-3 h-2 bg-gray-200 rounded-full overflow-hidden">
                                  <div 
                                    className={`h-full ${method === 'Cash' ? 'bg-blue-500' : method === 'Card' ? 'bg-purple-500' : 'bg-green-500'}`}
                                    style={{ width: `${percentage}%` }}
                                  ></div>
                                </div>
                              </div>
                            );
                          })}
                        </div>

                        {/* Detailed Sales Table */}
                        <div className="bg-white rounded-lg shadow overflow-hidden">
                          <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                            <h3 className="font-semibold">Transaction Details</h3>
                            <span className="text-sm text-gray-500">{getFilteredSales().length} records</span>
                          </div>
                          <div className="overflow-x-auto">
                            <table className="w-full">
                              <thead className="bg-gray-50">
                                <tr>
                                  <th className="px-4 py-3 text-left text-sm font-semibold">ID</th>
                                  <th className="px-4 py-3 text-left text-sm font-semibold">Date</th>
                                  <th className="px-4 py-3 text-left text-sm font-semibold">Time</th>
                                  <th className="px-4 py-3 text-left text-sm font-semibold">Items</th>
                                  <th className="px-4 py-3 text-left text-sm font-semibold">Total</th>
                                  <th className="px-4 py-3 text-left text-sm font-semibold">Profit</th>
                                  <th className="px-4 py-3 text-left text-sm font-semibold">Payment</th>
                                  <th className="px-4 py-3 text-left text-sm font-semibold">Cashier</th>
                                </tr>
                              </thead>
                              <tbody>
                                {getFilteredSales().map(s => (
                                  <tr key={s.id} className="border-t hover:bg-gray-50">
                                    <td className="px-4 py-3 text-sm font-mono">#{s.id}</td>
                                    <td className="px-4 py-3 text-sm">{s.date}</td>
                                    <td className="px-4 py-3 text-sm">{s.time}</td>
                                    <td className="px-4 py-3 text-sm">{s.items}</td>
                                    <td className="px-4 py-3 text-sm font-semibold text-green-600">KES {s.total.toLocaleString()}</td>
                                    <td className="px-4 py-3 text-sm font-semibold text-blue-600">KES {s.profit.toLocaleString()}</td>
                                    <td className="px-4 py-3 text-sm">
                                      <div className="flex items-center gap-1">
                                        {s.paymentMethod === 'Cash' && <Banknote size={16} className="text-blue-500" />}
                                        {s.paymentMethod === 'Card' && <CreditCard size={16} className="text-purple-500" />}
                                        {s.paymentMethod === 'M-Pesa' && <Smartphone size={16} className="text-green-500" />}
                                        <span>{s.paymentMethod}</span>
                                      </div>
                                    </td>
                                    <td className="px-4 py-3 text-sm text-gray-600">{s.cashier || '-'}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>

                        {/* Daily Sales Breakdown */}
                        <div className="bg-white rounded-lg shadow overflow-hidden mt-6">
                          <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                            <h3 className="font-semibold">ðŸ“Š Daily Sales Breakdown - Exact Goods Sold & Profit</h3>
                          </div>
                          <div className="overflow-x-auto">
                            {getDailySalesBreakdown().map(day => (
                              <div key={day.date} className="border-b last:border-b-0">
                                <div className="bg-blue-50 p-4 border-b">
                                  <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                                    <div>
                                      <p className="text-xs text-gray-600">Date</p>
                                      <p className="font-bold text-lg">{day.date}</p>
                                    </div>
                                    <div>
                                      <p className="text-xs text-gray-600">Total Revenue</p>
                                      <p className="font-bold text-green-600 text-lg">KES {day.totalRevenue.toFixed(2)}</p>
                                    </div>
                                    <div>
                                      <p className="text-xs text-gray-600">Total Profit</p>
                                      <p className="font-bold text-blue-600 text-lg">KES {day.totalProfit.toFixed(2)}</p>
                                    </div>
                                    <div>
                                      <p className="text-xs text-gray-600">Items Sold</p>
                                      <p className="font-bold text-lg">{day.totalItemsSold.toFixed(2)} units</p>
                                    </div>
                                    <div>
                                      <p className="text-xs text-gray-600">Transactions</p>
                                      <p className="font-bold text-lg">{day.transactionCount}</p>
                                    </div>
                                  </div>
                                </div>
                                <table className="w-full">
                                  <thead className="bg-gray-100">
                                    <tr>
                                      <th className="px-4 py-2 text-left text-sm font-semibold">Product Name</th>
                                      <th className="px-4 py-2 text-right text-sm font-semibold">Quantity Sold</th>
                                      <th className="px-4 py-2 text-right text-sm font-semibold">Buying Price</th>
                                      <th className="px-4 py-2 text-right text-sm font-semibold">Selling Price</th>
                                      <th className="px-4 py-2 text-right text-sm font-semibold">Revenue</th>
                                      <th className="px-4 py-2 text-right text-sm font-semibold">Cost</th>
                                      <th className="px-4 py-2 text-right text-sm font-semibold">Profit</th>
                                      <th className="px-4 py-2 text-right text-sm font-semibold">Margin %</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {Object.values(day.products).sort((a, b) => b.profit - a.profit).map((product, idx) => (
                                      <tr key={idx} className="border-t hover:bg-gray-50">
                                        <td className="px-4 py-2 text-sm font-semibold">{product.name}</td>
                                        <td className="px-4 py-2 text-sm text-right font-bold">{product.quantitySold.toFixed(2)}</td>
                                        <td className="px-4 py-2 text-sm text-right text-gray-600">KES {product.buyingPrice.toFixed(2)}</td>
                                        <td className="px-4 py-2 text-sm text-right text-green-600 font-semibold">KES {product.sellingPrice.toFixed(2)}</td>
                                        <td className="px-4 py-2 text-sm text-right font-semibold text-green-600">KES {product.revenue.toFixed(2)}</td>
                                        <td className="px-4 py-2 text-sm text-right text-gray-600">KES {product.cost.toFixed(2)}</td>
                                        <td className={`px-4 py-2 text-sm text-right font-bold ${product.profit >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                          KES {product.profit.toFixed(2)}
                                        </td>
                                        <td className="px-4 py-2 text-sm text-right">
                                          <span className={`font-semibold ${product.revenue > 0 ? ((product.profit / product.revenue) * 100 >= 0 ? 'text-green-600' : 'text-red-600') : 'text-gray-500'}`}>
                                            {product.revenue > 0 ? ((product.profit / product.revenue) * 100).toFixed(1) : '0.0'}%
                                          </span>
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                  <tfoot className="bg-gray-100 font-bold">
                                    <tr>
                                      <td className="px-4 py-2 text-sm">TOTAL</td>
                                      <td className="px-4 py-2 text-sm text-right">{day.totalItemsSold.toFixed(2)}</td>
                                      <td className="px-4 py-2 text-sm text-right" colSpan="2">-</td>
                                      <td className="px-4 py-2 text-sm text-right text-green-600">KES {day.totalRevenue.toFixed(2)}</td>
                                      <td className="px-4 py-2 text-sm text-right text-gray-600">KES {day.totalCost.toFixed(2)}</td>
                                      <td className={`px-4 py-2 text-sm text-right ${day.totalProfit >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                        KES {day.totalProfit.toFixed(2)}
                                      </td>
                                      <td className="px-4 py-2 text-sm text-right">
                                        <span className={day.totalRevenue > 0 ? ((day.totalProfit / day.totalRevenue) * 100 >= 0 ? 'text-green-600' : 'text-red-600') : 'text-gray-500'}>
                                          {day.totalRevenue > 0 ? ((day.totalProfit / day.totalRevenue) * 100).toFixed(1) : '0.0'}%
                                        </span>
                                      </td>
                                    </tr>
                                  </tfoot>
                                </table>
                              </div>
                            ))}
                            {getDailySalesBreakdown().length === 0 && (
                              <div className="p-8 text-center text-gray-500">
                                No sales data available for selected date range
                              </div>
                            )}
                          </div>
                        </div>
                      </>
                    )}

                    {reportType === 'products' && (
                      <>
                        <h3 className="text-xl font-bold">ðŸ† Best Selling Products</h3>
                        <div className="bg-white rounded-lg shadow overflow-hidden">
                          <table className="w-full">
                            <thead className="bg-gray-50">
                              <tr>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Rank</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Product</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Quantity Sold</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Revenue</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Profit</th>
                              </tr>
                            </thead>
                            <tbody>
                              {getBestSellingProducts().map((p, idx) => (
                                <tr key={idx} className="border-t hover:bg-gray-50">
                                  <td className="px-4 py-3">
                                    <span className={`inline-flex items-center justify-center w-8 h-8 rounded-full font-bold ${
                                      idx === 0 ? 'bg-yellow-100 text-yellow-700' :
                                      idx === 1 ? 'bg-gray-200 text-gray-700' :
                                      idx === 2 ? 'bg-orange-100 text-orange-700' :
                                      'bg-gray-100 text-gray-600'
                                    }`}>
                                      {idx + 1}
                                    </span>
                                  </td>
                                <td className="px-4 py-3 text-sm font-semibold">{p.name}</td>
                                <td className="px-4 py-3 text-sm font-bold">{p.quantity.toFixed(2)} units</td>
                                <td className="px-4 py-3 text-sm font-bold text-green-600">KES {p.revenue.toFixed(2)}</td>
                                <td className="px-4 py-3 text-sm font-bold text-blue-600">KES {p.profit.toFixed(2)}</td>
                                </tr>
                              ))}
                              {getBestSellingProducts().length === 0 && (
                                <tr>
                                  <td colSpan="5" className="px-4 py-8 text-center text-gray-500">
                                    No sales data with item details available
                                  </td>
                                </tr>
                              )}
                            </tbody>
                          </table>
                        </div>
                      </>
                    )}

                    {reportType === 'inventory' && (
                      <>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div className="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-500">
                            <p className="text-sm text-gray-600">Total Products</p>
                            <p className="text-3xl font-bold">{products.length}</p>
                          </div>
                          <div className="bg-green-50 p-6 rounded-lg border-l-4 border-green-500">
                            <p className="text-sm text-gray-600">Total Stock Value</p>
                            <p className="text-3xl font-bold">KES {totalInventoryValue.toLocaleString()}</p>
                          </div>
                          <div className="bg-red-50 p-6 rounded-lg border-l-4 border-red-500">
                            <p className="text-sm text-gray-600">Low Stock Items</p>
                            <p className="text-3xl font-bold">{lowStockItems.length}</p>
                          </div>
                        </div>

                        <div className="bg-white rounded-lg shadow overflow-hidden">
                          <div className="p-4 bg-gray-50 border-b">
                            <h3 className="font-semibold">Full Inventory List</h3>
                          </div>
                          <table className="w-full">
                            <thead className="bg-gray-50">
                              <tr>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Product</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Category</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Stock</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Reorder Level</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Stock Value</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Status</th>
                              </tr>
                            </thead>
                            <tbody>
                              {products.map(p => (
                                <tr key={p.id} className={`border-t ${p.stock <= p.reorderLevel ? 'bg-red-50' : ''}`}>
                                  <td className="px-4 py-3 text-sm font-semibold">{p.name}</td>
                                  <td className="px-4 py-3 text-sm">{p.category}</td>
                                  <td className="px-4 py-3 text-sm font-bold">{p.stock}</td>
                                  <td className="px-4 py-3 text-sm">{p.reorderLevel}</td>
                                  <td className="px-4 py-3 text-sm font-semibold text-green-600">KES {(p.stock * p.sellingPrice).toLocaleString()}</td>
                                  <td className="px-4 py-3 text-sm">
                                    {p.stock === 0 ? (
                                      <span className="bg-red-600 text-white px-2 py-1 rounded text-xs">OUT OF STOCK</span>
                                    ) : p.stock <= p.reorderLevel ? (
                                      <span className="bg-orange-500 text-white px-2 py-1 rounded text-xs">LOW STOCK</span>
                                    ) : (
                                      <span className="bg-green-500 text-white px-2 py-1 rounded text-xs">IN STOCK</span>
                                    )}
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </>
                    )}

                    {reportType === 'purchases' && (
                      <>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div className="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-500">
                            <p className="text-sm text-gray-600">Total Purchase Value</p>
                            <p className="text-3xl font-bold">KES {purchases.reduce((sum, p) => sum + p.total, 0).toLocaleString()}</p>
                          </div>
                          <div className="bg-yellow-50 p-6 rounded-lg border-l-4 border-yellow-500">
                            <p className="text-sm text-gray-600">Pending Orders</p>
                            <p className="text-3xl font-bold">{purchases.filter(p => p.status === 'Pending').length}</p>
                          </div>
                          <div className="bg-green-50 p-6 rounded-lg border-l-4 border-green-500">
                            <p className="text-sm text-gray-600">Received Orders</p>
                            <p className="text-3xl font-bold">{purchases.filter(p => p.status === 'Received').length}</p>
                          </div>
                        </div>

                        <div className="bg-white rounded-lg shadow overflow-hidden">
                          <div className="p-4 bg-gray-50 border-b">
                            <h3 className="font-semibold">Purchase Order History</h3>
                          </div>
                          <table className="w-full">
                            <thead className="bg-gray-50">
                              <tr>
                                <th className="px-4 py-3 text-left text-sm font-semibold">PO #</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Date</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Supplier</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Items</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Total</th>
                                <th className="px-4 py-3 text-left text-sm font-semibold">Status</th>
                              </tr>
                            </thead>
                            <tbody>
                              {purchases.map(p => (
                                <tr key={p.id} className="border-t hover:bg-gray-50">
                                  <td className="px-4 py-3 text-sm font-mono font-bold">{p.invoiceNo}</td>
                                  <td className="px-4 py-3 text-sm">{p.date}</td>
                                  <td className="px-4 py-3 text-sm">{p.supplier}</td>
                                  <td className="px-4 py-3 text-sm">{p.items.length} items</td>
                                  <td className="px-4 py-3 text-sm font-bold text-green-600">KES {p.total.toLocaleString()}</td>
                                  <td className="px-4 py-3 text-sm">
                                    <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                      p.status === 'Received' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                                    }`}>
                                      {p.status}
                                    </span>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </>
                    )}

                    {reportType === 'employees' && (
                      <>
                        <div className="bg-white rounded-lg shadow p-6">
                          <h3 className="font-bold text-lg mb-4">ðŸ‘¤ Employee Sales Performance</h3>
                          <div className="space-y-4">
                            {[...new Set(sales.map(s => s.cashier || 'Unknown'))].map(cashier => {
                              const cashierSales = sales.filter(s => s.cashier === cashier);
                              const totalSales = cashierSales.reduce((sum, s) => sum + s.total, 0);
                              const totalProfit = cashierSales.reduce((sum, s) => sum + (s.profit || 0), 0);
                              const transactionCount = cashierSales.length;
                              const avgTransaction = transactionCount > 0 ? totalSales / transactionCount : 0;
                              
                              return (
                                <div key={cashier} className="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                  <div className="flex justify-between items-start mb-3">
                                    <div>
                                      <h4 className="font-bold text-lg text-gray-900">{cashier}</h4>
                                      <p className="text-sm text-gray-500">{transactionCount} transactions</p>
                                    </div>
                                    <div className="text-right">
                                      <p className="text-2xl font-bold text-green-600">KES {totalSales.toLocaleString()}</p>
                                      <p className="text-sm text-gray-500">Total Sales</p>
                                    </div>
                                  </div>
                                  <div className="grid grid-cols-3 gap-4 text-center">
                                    <div className="bg-white p-3 rounded-lg">
                                      <p className="text-xs text-gray-500">Profit Generated</p>
                                      <p className="font-bold text-emerald-600">KES {totalProfit.toLocaleString()}</p>
                                    </div>
                                    <div className="bg-white p-3 rounded-lg">
                                      <p className="text-xs text-gray-500">Avg Transaction</p>
                                      <p className="font-bold text-blue-600">KES {avgTransaction.toFixed(0)}</p>
                                    </div>
                                    <div className="bg-white p-3 rounded-lg">
                                      <p className="text-xs text-gray-500">Items Sold</p>
                                      <p className="font-bold text-purple-600">{cashierSales.reduce((sum, s) => sum + (s.items || 0), 0)}</p>
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>

                        {/* Top Performers */}
                        <div className="bg-white rounded-lg shadow p-6">
                          <h3 className="font-bold text-lg mb-4">ðŸ† Today's Performance</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {[...new Set(todaySales.map(s => s.cashier || 'Unknown'))].map(cashier => {
                              const cashierTodaySales = todaySales.filter(s => s.cashier === cashier);
                              const total = cashierTodaySales.reduce((sum, s) => sum + s.total, 0);
                              return (
                                <div key={cashier} className="flex justify-between items-center bg-blue-50 p-4 rounded-lg">
                                  <span className="font-bold">{cashier}</span>
                                  <span className="text-blue-600 font-bold">KES {total.toLocaleString()}</span>
                                </div>
                              );
                            })}
                            {todaySales.length === 0 && (
                              <p className="text-gray-500 col-span-2 text-center py-4">No sales recorded today</p>
                            )}
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                )}

                {currentView === 'settings' && (
                  <div className="space-y-6">
                    <h2 className="text-2xl font-bold">âš™ï¸ Store Settings</h2>
                    <p className="text-sm text-gray-600 mb-4">Customize your store information for receipts and invoices</p>
                    
                    <div className="bg-white rounded-lg shadow p-6 space-y-6">
                      <div>
                        <label className="block text-sm font-medium mb-2">Store Name *</label>
                        <input
                          type="text"
                          value={storeConfig.storeName}
                          onChange={(e) => setStoreConfig({...storeConfig, storeName: e.target.value})}
                          className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Enter your store name"
                        />
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium mb-2">Phone Number *</label>
                          <input
                            type="text"
                            value={storeConfig.phone}
                            onChange={(e) => setStoreConfig({...storeConfig, phone: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="+254 XXX XXX XXX"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-2">Email</label>
                          <input
                            type="email"
                            value={storeConfig.email}
                            onChange={(e) => setStoreConfig({...storeConfig, email: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="store@email.com"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium mb-2">Address</label>
                        <input
                          type="text"
                          value={storeConfig.address}
                          onChange={(e) => setStoreConfig({...storeConfig, address: e.target.value})}
                          className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Street, City, Country"
                        />
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium mb-2">Tax PIN *</label>
                          <input
                            type="text"
                            value={storeConfig.taxPin}
                            onChange={(e) => setStoreConfig({...storeConfig, taxPin: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="P051234567X"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-2">Currency</label>
                          <select
                            value={storeConfig.currency}
                            onChange={(e) => setStoreConfig({...storeConfig, currency: e.target.value, currencySymbol: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          >
                            <option value="KES">KES (Kenyan Shilling)</option>
                            <option value="USD">USD (US Dollar)</option>
                            <option value="EUR">EUR (Euro)</option>
                            <option value="GBP">GBP (British Pound)</option>
                            <option value="UGX">UGX (Ugandan Shilling)</option>
                            <option value="TZS">TZS (Tanzanian Shilling)</option>
                            <option value="RWF">RWF (Rwandan Franc)</option>
                          </select>
                        </div>
                      </div>

                      <div className="border-t pt-4">
                        <label className="block text-sm font-medium mb-2">Receipt Footer Text</label>
                        <input
                          type="text"
                          value={storeConfig.footerText}
                          onChange={(e) => setStoreConfig({...storeConfig, footerText: e.target.value})}
                          className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Powered by 43_Industries"
                        />
                        <div className="mt-2 flex items-center gap-2">
                          <input
                            type="checkbox"
                            checked={storeConfig.showFooter}
                            onChange={(e) => setStoreConfig({...storeConfig, showFooter: e.target.checked})}
                            className="w-4 h-4"
                          />
                          <label className="text-sm text-gray-600">Show footer on receipts</label>
                        </div>
                      </div>

                      {/* User Management Section */}
                      <div className="border-t-2 border-gray-300 pt-6 mt-6">
                        <div className="bg-purple-50 border-l-4 border-purple-500 p-4 mb-4 rounded">
                          <h3 className="text-xl font-bold mb-2 text-purple-800">ðŸ” User Accounts & Passwords</h3>
                          <p className="text-sm text-purple-700">Change passwords for Admin and Cashier accounts. Each store can have different passwords.</p>
                        </div>
                        <p className="text-sm text-gray-600 mb-4">Manage login credentials for this store. Each store can have different passwords.</p>
                        
                        <div className="space-y-4">
                          {users.map((user, index) => (
                            <div key={user.id || index} className="bg-gray-50 border rounded-lg p-4">
                              <div className="flex justify-between items-start mb-3">
                                <div>
                                  <h4 className="font-bold text-lg">{user.name}</h4>
                                  <p className="text-sm text-gray-600">Role: <span className="font-semibold">{user.role}</span></p>
                                  <p className="text-sm text-gray-500">Username: <span className="font-mono">{user.username}</span></p>
                                </div>
                                <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                  user.role === 'Admin' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'
                                }`}>
                                  {user.role}
                                </span>
                              </div>
                              
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                  <label className="block text-xs font-medium mb-1 text-gray-700">New Password</label>
                                  <input
                                    type="password"
                                    placeholder="Enter new password"
                                    id={`password-${user.id || index}`}
                                    className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  />
                                </div>
                                <div className="flex items-end">
                                  <button
                                    onClick={() => {
                                      const passwordInput = document.getElementById(`password-${user.id || index}`);
                                      const newPassword = passwordInput.value.trim();
                                      
                                      if (!newPassword) {
                                        alert('âš ï¸ Please enter a new password');
                                        return;
                                      }
                                      
                                      if (newPassword.length < 4) {
                                        alert('âš ï¸ Password must be at least 4 characters long');
                                        return;
                                      }
                                      
                                      if (confirm(`Change password for ${user.name} (${user.role})?`)) {
                                        const updatedUsers = users.map(u => 
                                          u.id === user.id ? { ...u, password: newPassword } : u
                                        );
                                        setUsers(updatedUsers);
                                        passwordInput.value = '';
                                        alert(`âœ… Password updated successfully for ${user.name}!\n\nNew password: ${newPassword}\n\nPlease write this down and keep it safe.`);
                                      }
                                    }}
                                    className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm"
                                  >
                                    Change Password
                                  </button>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                        
                        <div className="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                          <p className="text-sm text-yellow-800">
                            <strong>âš ï¸ Important:</strong> Write down your passwords and keep them safe. If you forget your password, you'll need to clear browser data to reset.
                          </p>
                        </div>
                      </div>

                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p className="text-sm text-blue-800 font-semibold mb-2">ðŸ’¡ Tips for Selling to Different Mini Marts:</p>
                        <ul className="text-sm text-blue-700 space-y-1 list-disc list-inside">
                          <li>Fill in all required fields (marked with *) before delivering to clients</li>
                          <li>Each store's settings and passwords are saved automatically in their browser</li>
                          <li>Settings persist even after browser restart</li>
                          <li>You can customize passwords for each client before installation</li>
                          <li>All receipts and invoices will use these settings</li>
                        </ul>
                      </div>

                      <div className="flex gap-2 pt-4 border-t">
                        <button
                          onClick={() => {
                            if (confirm('Reset to default settings? This cannot be undone.')) {
                              setStoreConfig(defaultStoreConfig);
                            }
                          }}
                          className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold"
                        >
                          Reset to Default
                        </button>
                        <div className="flex-1"></div>
                        <button
                          onClick={() => {
                            // Force save to localStorage
                            localStorage.setItem('storeConfig', JSON.stringify(storeConfig));
                            // Show success message
                            alert('âœ… Settings saved successfully!\n\nYour store information has been updated and will appear on all receipts and invoices.');
                          }}
                          className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold flex items-center gap-2"
                        >
                          <Save size={18} />
                          Save Changes
                        </button>
                        <div className="bg-green-50 border border-green-200 rounded-lg px-4 py-2 flex items-center gap-2">
                          <span className="text-green-600 font-semibold text-sm">Auto-save enabled</span>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        // Wait for React and ReactDOM to be available
        function initApp() {
            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                console.log('â³ Waiting for React libraries to load...');
                setTimeout(initApp, 200);
                return;
            }
            
            const rootElement = document.getElementById('root');
            if (!rootElement) {
                console.error('âŒ Root element not found! Creating one...');
                const rootDiv = document.createElement('div');
                rootDiv.id = 'root';
                document.body.appendChild(rootDiv);
                initApp();
                return;
            }
            
            try {
                console.log('âœ… React libraries loaded, initializing application...');
                const root = ReactDOM.createRoot(rootElement);
                root.render(React.createElement(CompleteSystem));
                console.log('âœ… Complete system loaded successfully!');
            } catch (error) {
                console.error('âŒ Error rendering application:', error);
                const errorHtml = `
                    <div style="padding: 50px; text-align: center; font-family: Arial;">
                        <h1 style="color: red; margin-bottom: 20px;">Error Loading Application</h1>
                        <p style="color: #666; margin-bottom: 10px;">There was an error loading the application:</p>
                        <pre style="background: #f5f5f5; padding: 20px; text-align: left; overflow: auto; max-width: 800px; margin: 0 auto;">
                            ${error.toString()}
                            ${error.stack || ''}
                        </pre>
                        <p style="margin-top: 20px; color: #666; font-size: 12px;">
                            Check the browser console (F12) for more details.
                        </p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Reload Page
                        </button>
                    </div>
                `;
                rootElement.innerHTML = errorHtml;
            }
        }
        
        // Start initialization after ensuring libraries are loaded
        // Babel processes type="text/babel" scripts automatically, but we still need to wait for React
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(initApp, 1000);
            });
        } else {
            setTimeout(initApp, 1000);
        }
    </script>
</body>
</html>

